<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAA 관리자 홈</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- 마크다운 렌더링 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Excel 파일 생성을 위한 SheetJS 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1 id="sidebar-title">AAA 관리자 홈</h1>
            <div class="sidebar-tabs">
                <a href="index.html" class="sidebar-tab active">홈</a>
                <a href="pages/dashboard.html" class="sidebar-tab">대시보드</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown">
                        사용자 관리
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="pages/users.html" class="sidebar-dropdown-item">재직자</a>
                        <a href="pages/resigned-users.html" class="sidebar-dropdown-item">퇴사자</a>
                    </div>
                </div>
                <a href="pages/gifts.html" class="sidebar-tab">선물보내기</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown">
                        휴가 총괄 관리
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="pages/vacation-requests.html" class="sidebar-dropdown-item">부여요청목록</a>
                        <a href="pages/vacation-history.html" class="sidebar-dropdown-item">부여내역</a>
                        <a href="pages/vacation-status.html" class="sidebar-dropdown-item">전사원 휴가현황</a>
                        <a href="pages/vacation-proxy.html" class="sidebar-dropdown-item" style="display: none;">휴가 대리결제</a>
                        <a href="pages/vacation-manual.html" class="sidebar-dropdown-item">임의휴가부여</a>
                        <a href="pages/vacation-approvers.html" class="sidebar-dropdown-item">권한관리자 지정</a>
                        <a href="pages/vacation-promotion.html" class="sidebar-dropdown-item" style="display: none;">연차촉진관리</a>
                        <a href="pages/vacation-approval-history.html" class="sidebar-dropdown-item">휴가신청승인 관리</a>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <span id="username-display"></span>
                <button id="logout-btn" class="logout-btn">로그아웃</button>
            </div>
        </div>
        
        <div class="main-content">
            <div id="dashboard">
                <div class="dashboard">
                    <div class="dashboard-card">
                        <h3 id="card1-title">총 사용자</h3>
                        <p id="total-users">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 id="card2-title">오늘의 대화</h3>
                        <p id="today-conversations">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 id="card3-title">활성 사용자</h3>
                        <p id="active-users">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 id="card4-title">권한</h3>
                        <p id="role-description">관리자</p>
                    </div>
                    <!-- CSR 이상내역 카드 -->
                    <div class="dashboard-card csr-abnormal-card" id="csr-abnormal-card" onclick="openCSRAbnormalModal()">
                        <h3>🚨 CSR 이상내역</h3>
                        <p id="csr-abnormal-count">0</p>
                        <small>클릭하여 상세보기</small>
                    </div>
                    <!-- AAA 미사용자 명단 카드 -->
                    <div class="dashboard-card unused-users-card" onclick="openUnusedUsersModal()">
                        <h3>AAA 미사용자 명단</h3>
                        <p><span id="unused-users-count">0</span>명</p>
                        <small>대화 기록이 없는 사용자</small>
                    </div>
                    <!-- 사용자 앱 버전 내역 카드 -->
                    <div class="dashboard-card app-version-card" onclick="openAppVersionModal()">
                        <h3>📱 사용자 앱 버전 내역</h3>
                        <p id="app-version-summary">로딩중...</p>
                        <small>클릭하여 상세보기</small>
                    </div>
                    <!-- 생일자 개인정보 동의 현황 카드 -->
                    <div class="dashboard-card privacy-consent-card" onclick="openPrivacyConsentModal()">
                        <h3>🎂 생일자 개인정보 동의 현황</h3>
                        <p id="privacy-consent-summary">로딩중...</p>
                        <small>클릭하여 상세보기</small>
                    </div>
                    <!-- 추석 선물 모니터링 현황 카드 -->
                    <div class="dashboard-card chuseok-gift-card" onclick="openChuseokGiftModal()">
                        <h3>🌕 추석 선물 모니터링 현황</h3>
                        <p id="chuseok-gift-summary">로딩중...</p>
                        <small>클릭하여 상세보기</small>
                    </div>
                </div>
                
                <div class="recent-activity">
                    <button id="activity-toggle-btn" class="activity-toggle-btn">
                        <span id="activity-title">최근 활동</span>
                        <span class="toggle-icon">▼</span>
                    </button>
                    <div class="activity-list" id="activity-list" style="display: none;">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>
                
                <!-- 권한 안내 (role 2,3,4,5만 표시) -->
                <div class="admin-notice" id="admin-notice" style="display: none;">
                    <h3 id="notice-title">권한 안내</h3>
                    <ul id="notice-list">
                        <!-- 동적으로 생성됨 -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- CSR 이상내역 모달 -->
    <div id="csr-abnormal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CSR 이상내역 상세</h2>
                <span class="close" onclick="closeCSRAbnormalModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="filter-section">
                    <select id="abnormal-filter" onchange="filterCSRAbnormal()">
                        <option value="all">전체</option>
                        <option value="today">오늘</option>
                        <option value="week">최근 7일</option>
                        <option value="month">최근 30일</option>
                    </select>
                    <button onclick="loadCSRAbnormalData()">새로고침</button>
                </div>
                <div class="table-container">
                    <table id="csr-abnormal-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>발생일시</th>
                                <th>CSR ID</th>
                                <th>이상 유형</th>
                                <th>요청서 제목</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody id="csr-abnormal-tbody">
                            <!-- 동적으로 생성됨 -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="csr-abnormal-pagination">
                    <!-- 페이지네이션 버튼들 -->
                </div>
            </div>
        </div>
    </div>

    <!-- CSR 상세 정보 모달 -->
    <div id="csr-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>CSR 상세 정보</h2>
                <span class="close" onclick="closeCSRDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="csr-detail-container">
                    <!-- 1번 컨테이너: 이상 탐지 내역 (가장 위로 이동) -->
                    <div class="detail-section abnormal-detail-section">
                        <h3>⚠️ 이상 탐지 내역</h3>
                        
                        <!-- 이상 탐지 목록 -->
                        <div class="abnormal-list-container" id="abnormal-list-container">
                            이상 탐지 내역을 불러오는 중...
                        </div>
                    </div>
                    
                    <!-- 2번 컨테이너: 요청서 상세보기 -->
                    <div class="detail-section request-detail-section">
                        <h3>📋 요청서 상세보기</h3>
                        
                        <!-- 요청서 헤더 정보 -->
                        <div class="request-header-grid">
                            <div class="header-item">
                                <label>CSR ID:</label>
                                <span id="req-csr-id">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청서 제목:</label>
                                <span id="req-title">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청자:</label>
                                <span id="req-user-name">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청회사:</label>
                                <span id="req-company-name">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청일자:</label>
                                <span id="req-reg-date">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청 희망 일자:</label>
                                <span id="req-comp-hope-date">-</span>
                            </div>
                            <div class="header-item">
                                <label>완료 일자:</label>
                                <span id="req-comp-date">-</span>
                            </div>
                            <div class="header-item">
                                <label>요청구분:</label>
                                <span id="req-div-name">-</span>
                        </div>
                    </div>

                        <!-- 요청서 내용 -->
                        <div class="request-content-section">
                            <h4>📝 요청 내용</h4>
                            <div class="request-content-box" id="req-content">
                                요청 내용을 불러오는 중...
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3번 컨테이너: 진행 내역 상세 -->
                    <div class="detail-section progress-detail-section">
                        <h3>📈 진행 내역 상세</h3>
                        
                        <!-- 진행 헤더 정보 -->
                        <div class="progress-header-grid">
                            <div class="header-item">
                                <label>담당자:</label>
                                <span id="prog-csm-nm">-</span>
                            </div>
                            <div class="header-item">
                                <label>처리담당자:</label>
                                <span id="prog-proc-user-name">-</span>
                            </div>
                            <div class="header-item">
                                <label>처리담당자 부서:</label>
                                <span id="prog-dept">-</span>
                            </div>
                            <div class="header-item">
                                <label>서비스구분1:</label>
                                <span id="prog-depth1">-</span>
                            </div>
                            <div class="header-item">
                                <label>서비스구분2:</label>
                                <span id="prog-depth2">-</span>
                        </div>
                    </div>

                        <!-- 처리계획 내용 -->
                        <div class="progress-content-section">
                            <h4>📋 처리계획 본문</h4>
                            <div class="progress-content-box" id="prog-plan-content">
                                처리계획을 불러오는 중...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AAA 미사용자 명단 모달 -->
    <div id="unused-users-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AAA 미사용자 명단</h2>
                <span class="close" onclick="closeUnusedUsersModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="filter-section">
                    <button onclick="loadUnusedUsersData()">새로고침</button>

                    <!-- AAA 미사용자 주간 비교 정보 -->
                    <div id="unused-users-weekly-comparison" style="margin: 10px 0; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; font-size: 13px;">
                        <strong>📊 AAA 미사용자 주간 추이</strong>
                        <div id="unused-weekly-comparison-content" style="margin-top: 5px; color: #666;">
                            로딩 중...
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="unused-users-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>사용자 ID</th>
                                <th>이름</th>
                                <th class="dept-filter-header" onclick="toggleDeptFilter()">
                                    부서 
                                    <span class="filter-icon">▼</span>
                                    <div id="dept-filter-dropdown" class="dept-filter-dropdown">
                                        <div class="dept-filter-option" onclick="filterByDept('전체')">전체</div>
                                        <!-- 부서 목록은 동적으로 생성됨 -->
                                    </div>
                                </th>
                                <th>마지막 대화일</th>
                                <th>대화 상태</th>
                            </tr>
                        </thead>
                        <tbody id="unused-users-tbody">
                            <!-- 동적으로 생성됨 -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="unused-users-pagination">
                    <!-- 페이지네이션 버튼들 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 앱 버전 내역 모달 -->
    <div id="app-version-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📱 사용자 앱 버전 내역</h2>
                <span class="close" onclick="closeAppVersionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="filter-section">
                    <!-- v1.3.1 주간 비교 정보 -->
                    <div id="v131-weekly-comparison" style="margin: 10px 0; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; font-size: 13px;">
                        <strong>📊 v1.3.1 사용자 주간 비교</strong>
                        <div id="v131-weekly-comparison-content" style="margin-top: 5px; color: #666;">
                            로딩 중...
                        </div>
                    </div>

                    <div class="filter-buttons">
                        <button onclick="loadAppVersionData()">새로고침</button>
                        <button onclick="resetAppVersionFilters()" style="background-color: #6c757d;">필터 초기화</button>
                        <button onclick="exportAppVersionToExcel()" class="export-btn excel-btn">📊 Excel 다운로드</button>
                        <button onclick="exportAppVersionToMarkdown()" class="export-btn md-btn">📝 Markdown 다운로드</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="app-version-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>사용자 ID</th>
                                <th>이름</th>
                                <th class="dept-filter-header-appversion">
                                    <div class="dept-header-controls">
                                        <span class="dept-title">부서</span>
                                        <button class="dept-sort-btn" onclick="sortAppVersionByDept()" title="부서명 정렬">
                                            <span id="dept-sort-icon">⇅</span>
                                        </button>
                                        <span class="dept-filter-icon-appversion" onclick="toggleDeptFilterAppVersion(event)">▼</span>
                                    </div>
                                    <div id="dept-filter-dropdown-appversion" class="dept-filter-dropdown-appversion">
                                        <div class="dept-filter-option-appversion" data-dept="전체">전체</div>
                                        <div class="dept-filter-option-appversion" data-dept="중국지사 제외">중국지사 제외</div>
                                        <!-- 부서 목록은 동적으로 생성됨 -->
                                    </div>
                                </th>
                                                            <th class="version-filter-header" onclick="toggleVersionFilter(event)">
                                앱 버전 
                                <span class="version-filter-icon">▼</span>
                                <div id="version-filter-dropdown" class="version-filter-dropdown">
                                    <div class="version-filter-option" data-version="전체">전체</div>
                                    <div class="version-filter-option" data-version="1.3.1">1.3.1</div>
                                    <div class="version-filter-option" data-version="1.3.0">1.3.0</div>
                                    <div class="version-filter-option" data-version="1.2.1">1.2.1</div>
                                    <div class="version-filter-option" data-version="1.2.0">1.2.0</div>
                                    <div class="version-filter-option" data-version="1.1.0">1.1.0</div>
                                </div>
                            </th>
                            <th class="consent-filter-header-appversion" onclick="toggleConsentFilterAppVersion(event)">
                                개인정보 동의 
                                <span class="consent-filter-icon-appversion">▼</span>
                                <div id="consent-filter-dropdown-appversion" class="consent-filter-dropdown-appversion">
                                    <div class="consent-filter-option-appversion" data-consent="전체">전체</div>
                                    <div class="consent-filter-option-appversion" data-consent="동의함">동의함</div>
                                    <div class="consent-filter-option-appversion" data-consent="동의안함">동의안함</div>
                                </div>
                            </th>
                            </tr>
                        </thead>
                        <tbody id="app-version-tbody">
                            <!-- 동적으로 생성됨 -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="app-version-pagination">
                    <!-- 페이지네이션 버튼들 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 생일자 개인정보 동의 현황 모달 -->
    <div id="privacy-consent-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎂 생일자 개인정보 동의 현황</h2>
                <span class="close" onclick="closePrivacyConsentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 월별 생일자 인원수 표시 영역 -->
                <div class="birthday-count-section" id="birthday-count-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0; color: #333;">📅 월별 생일자 현황</h4>
                            <div id="filter-status-display" style="font-size: 12px; color: #888; margin-top: 4px;">
                                <!-- 필터 상태가 동적으로 표시됨 -->
                            </div>
                        </div>
                        
                        <!-- 컨트롤 버튼들 -->
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <!-- 이름 검색 입력 필드 -->
                            <div style="display: flex; align-items: center; position: relative; margin-top: 17px;">
                                <div style="position: relative; display: flex; align-items: center;">
                                    <span style="position: absolute; left: 8px; color: #888; font-size: 12px; pointer-events: none;">🔍</span>
                                    <input type="text" id="name-search-input" placeholder="이름으로 검색..." 
                                           style="padding: 6px 8px 6px 28px; border: 1px solid #e0e0e0; border-radius: 20px; width: 140px; font-size: 12px; 
                                                  background-color: #f8f9fa; transition: all 0.3s ease; outline: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                                           oninput="searchByName()"
                                           onkeyup="if(event.key==='Enter') searchByName()"
                                           onfocus="this.style.borderColor='#007bff'; this.style.backgroundColor='#fff'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.25)'"
                                           onblur="this.style.borderColor='#e0e0e0'; this.style.backgroundColor='#f8f9fa'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                                </div>
                            </div>
                            <button onclick="loadPrivacyConsentData()" style="padding: 4px 8px; font-size: 12px; white-space: nowrap;">새로고침</button>
                            <button id="senior-employee-filter-btn" onclick="toggleSeniorEmployeeFilter()" style="padding: 4px 8px; font-size: 12px; white-space: nowrap; background-color: #28a745;" title="입사 3개월 이상 인원만 조회">3개월+</button>
                            <button onclick="resetPrivacyConsentFilters()" style="background-color: #6c757d; padding: 4px 8px; font-size: 12px; white-space: nowrap;">필터 초기화</button>
                            <button onclick="exportPrivacyConsentToExcel()" class="export-btn excel-btn" style="padding: 4px 8px; font-size: 12px; white-space: nowrap;">📊 Excel</button>
                            <!-- 연도별 탭 버튼들 -->
                            <div class="year-tabs" style="display: inline-flex; gap: 4px; margin-bottom: 0;">
                                <button id="year-tab-2025" class="year-tab active" onclick="switchYearTab(2025)" style="padding: 4px 8px; font-size: 12px;">2025년</button>
                                <button id="year-tab-2026" class="year-tab" onclick="switchYearTab(2026)" style="padding: 4px 8px; font-size: 12px;">2026년</button>
                            </div>
                        </div>
                        
                        <div style="font-size: 14px; color: #666; text-align: right; margin-left: 15px;">
                            <div>총인원 (중국지사 32명 제외): <span id="total-birthday-count" style="font-weight: bold; color: #007bff;">0</span></div>
                            <div style="margin-top: 2px;">인사기록카드 미작성: <span id="no-birthday-count" style="font-weight: bold; color: #dc3545;">0</span></div>
                        </div>
                    </div>
                    <div class="birthday-count-grid" id="birthday-count-grid">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>

                <!-- 개인정보 동의 현황 추이 섹션 -->
                <div style="margin: 10px 0; padding: 6px 12px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
                        <span style="font-weight: 600; color: #333; font-size: 12px; white-space: nowrap;">📈 동의 증가 추이:</span>
                        <input type="date" id="privacy-trend-start-date" style="padding: 3px 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; width: 120px;">
                        <span style="color: #666; font-size: 12px;">~</span>
                        <input type="date" id="privacy-trend-end-date" style="padding: 3px 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; width: 120px;">
                        <button onclick="getPrivacyTrend()" style="padding: 3px 10px; font-size: 11px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; white-space: nowrap;">조회</button>
                        <span id="privacy-trend-result" style="font-weight: 600; color: #28a745; font-size: 12px; white-space: nowrap;"></span>
                    </div>
                </div>

                <div class="table-container">
                    <table id="privacy-consent-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>사용자명</th>
                                <th class="dept-filter-header-privacy" onclick="toggleDeptFilterPrivacy(event)">
                                    부서 
                                    <span class="dept-filter-icon-privacy">▼</span>
                                    <div id="dept-filter-dropdown-privacy" class="dept-filter-dropdown-privacy">
                                        <div class="dept-filter-option-privacy" data-dept="전체">전체</div>
                                        <!-- 부서 목록은 동적으로 생성됨 -->
                                    </div>
                                </th>
                                <th class="birthday-header">
                                    <div class="birthday-header-content">
                                        <span class="birthday-filter-part" onclick="toggleBirthdayFilter(event)">
                                            생일 
                                            <span class="birthday-filter-icon">▼</span>
                                            <div id="birthday-filter-dropdown" class="birthday-filter-dropdown">
                                                <div class="birthday-filter-option" data-month="전체">전체</div>
                                                <div class="birthday-filter-option" data-month="1">1월</div>
                                                <div class="birthday-filter-option" data-month="2">2월</div>
                                                <div class="birthday-filter-option" data-month="3">3월</div>
                                                <div class="birthday-filter-option" data-month="4">4월</div>
                                                <div class="birthday-filter-option" data-month="5">5월</div>
                                                <div class="birthday-filter-option" data-month="6">6월</div>
                                                <div class="birthday-filter-option" data-month="7">7월</div>
                                                <div class="birthday-filter-option" data-month="8">8월</div>
                                                <div class="birthday-filter-option" data-month="9">9월</div>
                                                <div class="birthday-filter-option" data-month="10">10월</div>
                                                <div class="birthday-filter-option" data-month="11">11월</div>
                                                <div class="birthday-filter-option" data-month="12">12월</div>
                                            </div>
                                        </span>
                                        <span class="birthday-sort-part" onclick="toggleBirthdaySort()" title="생일 정렬">
                                            <span id="birthday-sort-icon">⇅</span>
                                        </span>
                                    </div>
                                </th>
                                <th class="consent-filter-header" onclick="toggleConsentFilter(event)">
                                    개인정보 동의 현황 
                                    <span class="consent-filter-icon">▼</span>
                                    <div id="consent-filter-dropdown" class="consent-filter-dropdown">
                                        <div class="consent-filter-option" data-consent="전체">전체</div>
                                        <div class="consent-filter-option" data-consent="동의함">동의함</div>
                                        <div class="consent-filter-option" data-consent="동의안함">동의안함</div>
                                    </div>
                                </th>
                                <th>생일메시지</th>
                                <th>쿠폰</th>
                                <th>유효기간</th>
                                <th>사용여부</th>
                            </tr>
                        </thead>
                        <tbody id="privacy-consent-tbody">
                            <!-- 동적으로 생성됨 -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="privacy-consent-pagination">
                    <!-- 페이지네이션 버튼들 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 토스 스타일 개인정보 상세보기 모달 -->
    <div id="privacy-detail-modal" class="toss-modal">
        <div class="toss-modal-backdrop" onclick="closePrivacyDetailModal()"></div>
        <div class="toss-modal-content">
            <div class="toss-modal-header">
                <h3 class="toss-modal-title">개인정보 동의 현황</h3>
                <button class="toss-modal-close" onclick="closePrivacyDetailModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="toss-modal-body">
                <div class="toss-user-info">
                    <div class="toss-user-avatar">
                        <span id="detail-user-initial"></span>
                    </div>
                    <div class="toss-user-details">
                        <h4 id="detail-user-name" class="toss-user-name"></h4>
                        <p id="detail-user-dept" class="toss-user-dept"></p>
                    </div>
                </div>

                <div class="toss-info-grid">
                    <div class="toss-info-item">
                        <span class="toss-info-label">생년월일</span>
                        <span id="detail-user-birthday" class="toss-info-value"></span>
                    </div>
                    <div class="toss-info-item">
                        <span class="toss-info-label">개인정보 동의</span>
                        <span id="detail-user-consent" class="toss-info-value toss-consent-badge"></span>
                    </div>
                    <div class="toss-info-item">
                        <span class="toss-info-label">사용자 ID</span>
                        <span id="detail-user-id" class="toss-info-value"></span>
                    </div>
                    <div class="toss-info-item">
                        <span class="toss-info-label">연락처</span>
                        <span id="detail-user-phone" class="toss-info-value"></span>
                    </div>
                </div>

                <div class="toss-additional-info">
                    <h5 class="toss-section-title">추가 정보</h5>
                    <div class="toss-additional-grid">
                        <div class="toss-info-item">
                            <span class="toss-info-label">입사일</span>
                            <span id="detail-user-hire-date" class="toss-info-value"></span>
                        </div>
                        <div class="toss-info-item">
                            <span class="toss-info-label">직급</span>
                            <span id="detail-user-position" class="toss-info-value"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 유틸리티 스크립트 먼저 로드 -->
    <script src="js/utils/auth.js"></script>
    <script src="js/utils/api.js"></script>
    <script src="js/utils/debug.js"></script>
    <!-- 메인 스크립트 -->
    <script src="js/main.js"></script>
    <script>
        // 로그인 상태 확인
        if (!localStorage.getItem('adminRole')) {
            window.location.href = 'pages/login.html';
        }

        // role 3, 4인 경우 userId 검증 (localStorage 사용)
        const adminRole = localStorage.getItem('adminRole');
        const userId = localStorage.getItem('userId');
        const username = localStorage.getItem('username') || localStorage.getItem('userId');
        
        console.log('페이지 로드 시 검증:', { adminRole, userId, username });
        
        if ((adminRole === '3' || adminRole === '4') && !userId) {
            console.error('본부장/사업부장 권한이지만 userId가 없습니다');
            alert('사용자 정보가 없습니다. 다시 로그인해주세요.');
            localStorage.clear();
            window.location.href = 'pages/login.html';
        }
        
        // 페이지 로드 시 권한별 메뉴 제어
        document.addEventListener('DOMContentLoaded', function() {
            controlSidebarMenus();
        });

        // role별 설정 정의
        const roleConfigs = {
            '0': {
                title: 'AAA 관리자 홈 (최고관리자)',
                userGreeting: '(최고관리자)',
                cards: {
                    card1: '총 사용자',
                    card2: '오늘의 대화',
                    card3: '활성 사용자',
                    card4: '시스템 관리'
                },
                roleDesc: '최고관리자 권한',
                activityTitle: '최근 사용자 활동',
                activities: [
                    { text: '최고관리자 권한으로 새로운 사용자를 생성했습니다', time: '10분 전' },
                    { text: '시스템 설정을 업데이트했습니다', time: '30분 전' },
                    { text: '전체 사용자 보고서를 생성했습니다', time: '1시간 전' }
                ],
                showNotice: false
            },
            '1': {
                title: 'AAA 관리자 홈 (관리자_1)',
                userGreeting: '(관리자_1)',
                cards: {
                    card1: '총 사용자',
                    card2: '오늘의 대화',
                    card3: '활성 사용자',
                    card4: '시스템 관리'
                },
                roleDesc: '관리자_1 권한',
                activityTitle: '최근 사용자 활동',
                activities: [
                    { text: '관리자 권한으로 새로운 사용자를 생성했습니다', time: '10분 전' },
                    { text: '시스템 설정을 업데이트했습니다', time: '30분 전' },
                    { text: '전체 사용자 보고서를 생성했습니다', time: '1시간 전' }
                ],
                showNotice: false
            },
            '2': {
                title: 'AAA 관리자 홈 (관리자_2)',
                userGreeting: '(관리자_2)',
                cards: {
                    card1: '총 사용자',
                    card2: '오늘의 대화',
                    card3: '활성 사용자',
                    card4: '시스템 관리'
                },
                roleDesc: '관리자_2 권한',
                activityTitle: '최근 사용자 활동',
                activities: [
                    { text: '사용자 정보를 업데이트했습니다', time: '15분 전' },
                    { text: '부서별 대화 통계를 확인했습니다', time: '45분 전' },
                    { text: '사용자 권한을 변경했습니다', time: '2시간 전' }
                ],
                showNotice: true,
                noticeTitle: '관리자_2 권한 안내',
                notices: [
                    '✅ 전체 회원 관리 권한',
                    '✅ 사용자 정보 수정 가능',
                    '✅ 대화 목록 및 통계 열람',
                    '❌ 관리 권한 부여 불가'
                ]
            },
            '3': {
                title: 'AAA 관리자 홈 (본부장)',
                userGreeting: '(본부장)',
                cards: {
                    card1: '본부 소속 직원',
                    card2: '본부 대화 현황',
                    card3: '본부 활성 사용자',
                    card4: '관리 권한'
                },
                roleDesc: '본부장',
                activityTitle: '최근 본부장 활동',
                activities: [
                    { text: '본부 직원 정보를 관리했습니다', time: '20분 전' },
                    { text: '본부별 성과 보고서를 확인했습니다', time: '1시간 전' },
                    { text: '소속 직원 권한을 업데이트했습니다', time: '3시간 전' }
                ],
                showNotice: true,
                noticeTitle: '본부장 권한 안내',
                notices: [
                    '✅ 소속 본부의 직원 정보 관리 가능',
                    '✅ 해당 본부의 모든 데이터 열람 가능',
                    '✅ 본부별 통계 및 보고서 열람',
                    '❌ 타 본부 직원 정보 관리 불가',
                    '❌ 관리 권한 부여 불가'
                ]
            },
            '4': {
                title: 'AAA 관리자 홈 (사업부장)',
                userGreeting: '(사업부장)',
                cards: {
                    card1: '사업부 소속 직원',
                    card2: '사업부 대화 현황',
                    card3: '사업부 활성 사용자',
                    card4: '관리 권한'
                },
                roleDesc: '사업부장',
                activityTitle: '최근 사업부장 활동',
                activities: [
                    { text: '사업부 직원 성과를 검토했습니다', time: '25분 전' },
                    { text: '사업부별 대화 분석을 실시했습니다', time: '1시간 전' },
                    { text: '팀 업무 배정을 조정했습니다', time: '2시간 전' }
                ],
                showNotice: true,
                noticeTitle: '사업부장 권한 안내',
                notices: [
                    '✅ 해당 사업부의 모든 데이터 열람 가능',
                    '✅ 사업부 직원 업무 관리',
                    '✅ 사업부별 통계 및 보고서 열람',
                    '❌ 타 사업부 정보 관리 불가',
                    '❌ 관리 권한 부여 불가'
                ]
            },
            '5': {
                title: 'AAA 관리자 홈 (일반위원)',
                userGreeting: '(일반위원)',
                cards: {
                    card1: '담당 업무',
                    card2: '나의 대화',
                    card3: '개인 활동',
                    card4: '권한'
                },
                roleDesc: '일반위원',
                activityTitle: '최근 개인 활동',
                activities: [
                    { text: '담당 CSR 업무를 처리했습니다', time: '30분 전' },
                    { text: '개인 정보를 업데이트했습니다', time: '2시간 전' },
                    { text: '업무 보고서를 작성했습니다', time: '4시간 전' }
                ],
                showNotice: true,
                noticeTitle: '일반위원 권한 안내',
                notices: [
                    '✅ 본인이 담당하는 CSR 열람 가능',
                    '✅ 본인 인사정보 열람 가능',
                    '✅ 개인 업무 관련 대화 열람',
                    '❌ 타인 정보 열람 불가',
                    '❌ 관리 기능 사용 불가'
                ]
            }
        };

        // role에 따른 페이지 설정
        function setupPageByRole() {
            const adminRole = localStorage.getItem('adminRole');
            const username = localStorage.getItem('username') || localStorage.getItem('userId');
            
            console.log('🔍 [Page Setup] 권한 확인:', { adminRole, username });
            console.log('🔍 [Page Setup] roleConfigs 키들:', Object.keys(roleConfigs));
            
            // 유효하지 않은 role 처리
            if (!roleConfigs[adminRole]) {
                console.error('❌ [Page Setup] 올바르지 않은 권한:', adminRole);
                alert(`올바르지 않은 권한입니다: ${adminRole}`);
                localStorage.clear();
                window.location.href = 'pages/login.html';
                return;
            }

            const config = roleConfigs[adminRole];
            
            // 페이지 제목 및 사이드바 제목 설정
            document.title = config.title;
            document.getElementById('sidebar-title').textContent = config.title;
            
            // 사용자 이름 표시는 main.js의 setupUserInfo에서 처리됨
            
            // 대시보드 카드 설정
            document.getElementById('card1-title').textContent = config.cards.card1;
            document.getElementById('card2-title').textContent = config.cards.card2;
            document.getElementById('card3-title').textContent = config.cards.card3;
            document.getElementById('card4-title').textContent = config.cards.card4;
            document.getElementById('role-description').textContent = config.roleDesc;
            
            // 활동 섹션 설정
            document.getElementById('activity-title').textContent = config.activityTitle;
            const activityList = document.getElementById('activity-list');
            activityList.innerHTML = '';
            
            config.activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div>${activity.text}</div>
                    <div class="activity-time">${activity.time}</div>
                `;
                activityList.appendChild(activityItem);
            });
            
            // 권한 안내 섹션 (role 2,3,4,5만 표시)
            const noticeElement = document.getElementById('admin-notice');
            if (config.showNotice) {
                document.getElementById('notice-title').textContent = config.noticeTitle;
                const noticeList = document.getElementById('notice-list');
                noticeList.innerHTML = '';
                
                config.notices.forEach(notice => {
                    const listItem = document.createElement('li');
                    listItem.textContent = notice;
                    noticeList.appendChild(listItem);
                });
                
                noticeElement.style.display = 'block';
            } else {
                noticeElement.style.display = 'none';
            }
            
            // adminRole === '0', '1'인 경우 실제 DB 데이터 로딩
            if (adminRole === '0' || adminRole === '1') {
                loadDashboardData();
            }
            // adminRole === '2'인 경우도 실제 DB 데이터 로딩 (전체회원 관리권한)
            else if (adminRole === '2') {
                loadDashboardData();
            }
            // adminRole === '3', '4'인 경우 부서별 DB 데이터 로딩
            else if (adminRole === '3' || adminRole === '4') {
                loadDashboardData();
            }
        }

        // 페이지 로드시 role에 따른 설정 적용
        setupPageByRole();

        // 로그아웃 처리는 main.js에서 처리됨 (중복 제거)

        // CSR 이상내역 관련 함수들
        let csrAbnormalData = [];
        let csrCurrentPage = 1;
        const csrItemsPerPage = 30;

        // CSR 이상내역 모달 열기
        function openCSRAbnormalModal() {
            document.getElementById('csr-abnormal-modal').style.display = 'block';
            loadCSRAbnormalData();
        }

        // CSR 이상내역 모달 닫기
        function closeCSRAbnormalModal() {
            document.getElementById('csr-abnormal-modal').style.display = 'none';
        }

        // CSR 이상내역 데이터 로드
        async function loadCSRAbnormalData() {
            try {
                console.log('새로고침 버튼 클릭 - CSR 이상내역 데이터 로드 시작');
                const filter = document.getElementById('abnormal-filter').value;
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch(`/api/main/csr-abnormal?filter=${filter}&page=${csrCurrentPage}&limit=${csrItemsPerPage}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('CSR 이상내역 조회 실패');
                }
                
                const data = await response.json();
                csrAbnormalData = data.abnormalList || [];
                
                displayCSRAbnormalData();
                updateCSRAbnormalPagination(data.totalPages, data.page, data.total);
                
            } catch (error) {
                console.error('CSR 이상내역 로드 오류:', error);
                alert('CSR 이상내역을 불러오는데 실패했습니다.');
                
                // 실패시 빈 테이블 표시
                const tbody = document.getElementById('csr-abnormal-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // CSR 이상내역 데이터 표시 (DB 구조에 맞게 수정)
        function displayCSRAbnormalData() {
            const tbody = document.getElementById('csr-abnormal-tbody');
            tbody.innerHTML = '';
            
            if (csrAbnormalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">이상내역이 없습니다.</td></tr>';
                return;
            }
            
            csrAbnormalData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.display_number || ((csrCurrentPage - 1) * csrItemsPerPage + index + 1)}</td>
                    <td>${formatDateTime(item.detect_date)}</td>
                    <td>${item.csr_id || '-'}</td>
                    <td>${item.abnormal_type || '-'}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.req_title || '-'}">${item.req_title || '-'}</td>
                    <td class="status-${getStatusClass(item.next_status)}">${getStatusText(item.next_status)}</td>
                `;
                
                // 행 클릭 이벤트 추가
                row.addEventListener('click', () => {
                    openCSRDetailModal(item.csr_id);
                });
                
                tbody.appendChild(row);
            });
        }

        // 날짜 시간 포맷
        function formatDateTime(dateTime) {
            if (!dateTime) return '-';
            const date = new Date(dateTime);
            return date.toLocaleString('ko-KR');
        }

        // 상태 클래스 반환 (새로운 상태값에 맞게 수정)
        function getStatusClass(status) {
            if (!status) return 'process';
            
            switch(status.toUpperCase()) {
                case 'COMPLETE':
                    return 'complete';
                case 'C_REJECT':
                    return 'reject';
                case 'CONFIRM':
                    return 'confirm';
                case 'DEVTEST':
                    return 'devtest';
                case 'TEST':
                    return 'test';
                case 'PROCESS':
                    return 'process';
                case 'HOLD':
                    return 'hold';
                case 'PLAN':
                    return 'plan';
                case 'QA':
                    return 'qa';
                case 'RELEASE':
                    return 'release';
                case 'RELEASE_FILE':
                    return 'release-file';
                default:
                    return 'process';
            }
        }

        // 상태 텍스트 반환 (새로운 상태값에 맞게 수정)
        function getStatusText(status) {
            if (!status) return '처리진행';
            
            switch(status.toUpperCase()) {
                case 'COMPLETE':
                    return '완료';
                case 'C_REJECT':
                    return '반려';
                case 'CONFIRM':
                    return '승인';
                case 'DEVTEST':
                    return '개발테스트';
                case 'TEST':
                    return '테스트';
                case 'PROCESS':
                    return '처리진행';
                case 'HOLD':
                    return '보류';
                case 'PLAN':
                    return '계획';
                case 'QA':
                    return '검증';
                case 'RELEASE':
                    return '배포';
                case 'RELEASE_FILE':
                    return '배포 파일 준비';
                default:
                    return status || '처리진행';
            }
        }

        // CSR 이상내역 페이지네이션 업데이트
        function updateCSRAbnormalPagination(totalPages, currentPage, totalCount) {
            const pagination = document.getElementById('csr-abnormal-pagination');
            pagination.innerHTML = '';
            
            // 데이터 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.className = 'pagination-info';
            infoDiv.innerHTML = `
                <span style="font-size: 12px; color: #666; margin-right: 15px;">
                    전체 ${totalCount || 0}건 • ${totalPages || 1}페이지 중 ${currentPage || 1}페이지
                </span>
            `;
            pagination.appendChild(infoDiv);
            
            if (totalPages <= 1) return;
            
            // 페이지 버튼 컨테이너
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'pagination-buttons';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '5px';
            buttonsDiv.style.marginTop = '8px';
            
            // 처음 버튼
            if (currentPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '처음';
                firstBtn.style.fontWeight = 'bold';
                firstBtn.onclick = () => {
                    csrCurrentPage = 1;
                    loadCSRAbnormalData();
                };
                buttonsDiv.appendChild(firstBtn);
            }
            
            // 이전 버튼
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '이전';
                prevBtn.onclick = () => {
                    csrCurrentPage = currentPage - 1;
                    loadCSRAbnormalData();
                };
                buttonsDiv.appendChild(prevBtn);
            }
            
            // 페이지 번호
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    csrCurrentPage = i;
                    loadCSRAbnormalData();
                };
                buttonsDiv.appendChild(pageBtn);
            }
            
            // 다음 버튼
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '다음';
                nextBtn.onclick = () => {
                    csrCurrentPage = currentPage + 1;
                    loadCSRAbnormalData();
                };
                buttonsDiv.appendChild(nextBtn);
            }
            
            // 마지막 버튼
            if (currentPage < totalPages) {
                const lastBtn = document.createElement('button');
                lastBtn.textContent = '마지막';
                lastBtn.style.fontWeight = 'bold';
                lastBtn.onclick = () => {
                    csrCurrentPage = totalPages;
                    loadCSRAbnormalData();
                };
                buttonsDiv.appendChild(lastBtn);
            }
            
            pagination.appendChild(buttonsDiv);
        }

        // CSR 이상내역 개수 로드 (대시보드 카드용)
        async function loadCSRAbnormalCount() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch('/api/main/csr-abnormal/count', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('csr-abnormal-count').textContent = data.count || 0;
                } else {
                    document.getElementById('csr-abnormal-count').textContent = '0';
                }
            } catch (error) {
                console.error('CSR 이상내역 개수 로드 오류:', error);
                document.getElementById('csr-abnormal-count').textContent = '0';
            }
        }

        // CSR 이상내역 필터 변경
        function filterCSRAbnormal() {
            csrCurrentPage = 1;
            loadCSRAbnormalData();
        }

        // CSR 이상내역 페이지 변경 함수 (HTML에서 호출용)
        function changeCSRPage(page) {
            csrCurrentPage = page;
            loadCSRAbnormalData();
        }

        // 페이지 로드시 CSR 이상내역 개수 로드
        setTimeout(() => {
            loadCSRAbnormalCount();
        }, 1000);

        // CSR 상세 모달 열기
        async function openCSRDetailModal(csrId) {
            document.getElementById('csr-detail-modal').style.display = 'block';
            
            // 로딩 상태 표시
            showCSRDetailLoading();
            
            try {
                // 실제 API 호출로 데이터 가져오기
                await loadCSRDetailData(csrId);
            } catch (error) {
                console.error('CSR 상세 정보 로드 실패:', error);
                alert('CSR 상세 정보를 불러오는데 실패했습니다: ' + error.message);
                closeCSRDetailModal();
            }
        }

        // CSR 상세 정보 로딩 상태 표시
        function showCSRDetailLoading() {
            // 1번 컨테이너 로딩 상태
            document.getElementById('req-csr-id').textContent = '로딩중...';
            document.getElementById('req-title').textContent = '로딩중...';
            document.getElementById('req-user-name').textContent = '로딩중...';
            document.getElementById('req-company-name').textContent = '로딩중...';
            document.getElementById('req-reg-date').textContent = '로딩중...';
            document.getElementById('req-comp-hope-date').textContent = '로딩중...';
            document.getElementById('req-comp-date').textContent = '로딩중...';
            document.getElementById('req-div-name').textContent = '로딩중...';
            document.getElementById('req-content').innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">요청 내용을 불러오는 중...</p>';
            
            // 2번 컨테이너 로딩 상태
            document.getElementById('prog-csm-nm').textContent = '로딩중...';
            document.getElementById('prog-proc-user-name').textContent = '로딩중...';
            document.getElementById('prog-dept').textContent = '로딩중...';
            document.getElementById('prog-depth1').textContent = '로딩중...';
            document.getElementById('prog-depth2').textContent = '로딩중...';
            document.getElementById('prog-plan-content').innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">처리계획을 불러오는 중...</p>';
            
            // 3번 컨테이너 로딩 상태
            document.getElementById('abnormal-list-container').innerHTML = '이상 탐지 내역을 불러오는 중...';
        }

        // 실제 CSR 상세 데이터 로드
        async function loadCSRDetailData(csrId) {
            console.log('=== CSR 상세 데이터 로드 시작 ===');
            console.log('csrId:', csrId);
            
            const adminToken = localStorage.getItem('adminToken');
            const adminRole = localStorage.getItem('adminRole');
            const userId = localStorage.getItem('userId');
            
            console.log('요청 파라미터:', { adminToken, adminRole, userId });
            
            const apiUrl = `/api/main/csr-detail/${csrId}`;
            console.log('API URL:', apiUrl);
            
            const headers = {
                'Authorization': `Bearer ${adminToken}`,
                'Content-Type': 'application/json',
                'x-admin-role': adminRole,
                'x-user-id': userId
            };
            
            console.log('요청 헤더:', headers);
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: headers
            });
            
            console.log('응답 상태:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('응답 오류:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const result = await response.json();
            console.log('응답 데이터:', result);
            
            if (result.success && result.data) {
                console.log('데이터 표시 시작');
                displayCSRDetailData(result.data);
                console.log('=== CSR 상세 데이터 로드 완료 ===');
            } else {
                console.error('응답 데이터 구조 오류:', result);
                throw new Error(result.message || '데이터를 불러올 수 없습니다.');
            }
        }

        // CSR 상세 모달 닫기
        function closeCSRDetailModal() {
            document.getElementById('csr-detail-modal').style.display = 'none';
        }

        // CSR 상세 데이터 표시
        function displayCSRDetailData(data) {
            // 1번 컨테이너: 요청서 상세보기 데이터 표시
            document.getElementById('req-csr-id').textContent = data.csr_id || '-';
            document.getElementById('req-title').textContent = data.req_title || '-';
            document.getElementById('req-user-name').textContent = data.req_user_name || '-';
            document.getElementById('req-company-name').textContent = data.company_name || '-';
            document.getElementById('req-reg-date').textContent = formatDateOnly(data.reg_date) || '-';
            document.getElementById('req-comp-hope-date').textContent = formatDateOnly(data.comp_hope_date) || '-';
            document.getElementById('req-comp-date').textContent = formatDateOnly(data.comp_date) || '-';
            document.getElementById('req-div-name').textContent = data.div_name || '-';
            // 마크다운 렌더링 적용
            document.getElementById('req-content').innerHTML = renderMarkdown(data.req_content || '요청 내용이 없습니다.');
            
            // 2번 컨테이너: 진행 내역 상세 데이터 표시
            document.getElementById('prog-csm-nm').textContent = data.csm_nm || '-';
            document.getElementById('prog-proc-user-name').textContent = data.proc_user_name || '-';
            document.getElementById('prog-dept').textContent = data.dept || '-';
            document.getElementById('prog-depth1').textContent = data.depth1 || '-';
            document.getElementById('prog-depth2').textContent = data.depth2 || '-';
            // 마크다운 렌더링 적용
            document.getElementById('prog-plan-content').innerHTML = renderMarkdown(data.plan_content || '처리계획이 없습니다.');
            
            // 3번 컨테이너: 이상 탐지 내역 표시
            displayAbnormalList(data.abnormalList || []);
        }

        // 이상 탐지 내역 리스트 표시
        function displayAbnormalList(abnormalList) {
            const container = document.getElementById('abnormal-list-container');
            
            if (!abnormalList || abnormalList.length === 0) {
                container.innerHTML = `
                    <div class="no-abnormal">
                        이상 탐지 내역이 없습니다.
                    </div>
                `;
                return;
            }
            
            let html = '';
            abnormalList.forEach((item, index) => {
                html += `
                    <div class="abnormal-item">
                        <div class="abnormal-header">
                            <span style="font-weight: 600; color: #2c3e50;">이상탐지 #${abnormalList.length - index}</span>
                            <span class="abnormal-time">${formatDateTime(item.detect_date)}</span>
                        </div>
                        <div class="abnormal-content">${item.abnormal_detail || '상세 내용이 없습니다.'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 날짜만 포맷팅 (시간 제외)
        function formatDateOnly(date) {
            if (!date) return '-';
            
            try {
                const dateObj = new Date(date);
                if (isNaN(dateObj.getTime())) {
                    // 날짜 형식이 올바르지 않은 경우 원본 반환
                    return date;
                }
                return dateObj.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                console.error('날짜 포맷팅 오류:', error);
                return date;
            }
        }

        // 기본 HTML 정화 함수 (XSS 방지)
        function sanitizeHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            
            // 위험한 태그 제거
            const dangerousTags = ['script', 'iframe', 'object', 'embed', 'form', 'input'];
            dangerousTags.forEach(tag => {
                const elements = div.querySelectorAll(tag);
                elements.forEach(el => el.remove());
            });
            
            // 위험한 속성 제거
            const allElements = div.querySelectorAll('*');
            allElements.forEach(el => {
                // onclick, onload 등 이벤트 속성 제거
                const attributes = [...el.attributes];
                attributes.forEach(attr => {
                    if (attr.name.startsWith('on') || attr.name === 'javascript:') {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            
            return div.innerHTML;
        }

        // 마크다운 렌더링 함수
        function renderMarkdown(text) {
            if (!text) return '<p style="color: #999; font-style: italic;">내용이 없습니다.</p>';
            
            try {
                let renderedHtml;
                
                // marked 라이브러리가 로드되었는지 확인
                if (typeof marked !== 'undefined') {
                    // marked 옵션 설정
                    marked.setOptions({
                        breaks: true, // 줄바꿈을 <br>로 변환
                        gfm: true,    // GitHub Flavored Markdown 사용
                        sanitize: false, // HTML 허용 (우리가 직접 정화)
                        smartypants: false
                    });
                    
                    renderedHtml = marked.parse(text);
                } else {
                    // marked가 로드되지 않은 경우 기본 처리
                    // 줄바꿈을 <br>로 변환하고 간단한 마크다운 처리
                    renderedHtml = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **bold**
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')             // *italic*
                        .replace(/`(.*?)`/g, '<code>$1</code>')           // `code`
                        .replace(/### (.*)/g, '<h3>$1</h3>')             // ### heading
                        .replace(/## (.*)/g, '<h2>$1</h2>')              // ## heading
                        .replace(/# (.*)/g, '<h1>$1</h1>')               // # heading
                        .replace(/\n\n/g, '</p><p>')                     // 단락 구분
                        .replace(/\n/g, '<br>');                         // 줄바꿈
                    
                    // 단락으로 감싸기
                    if (!renderedHtml.includes('<p>')) {
                        renderedHtml = '<p>' + renderedHtml + '</p>';
                    }
                }
                
                // HTML 정화
                return sanitizeHtml(renderedHtml);
                
            } catch (error) {
                console.error('마크다운 렌더링 오류:', error);
                // 오류 발생시 기본 줄바꿈 처리
                return sanitizeHtml(text.replace(/\n/g, '<br>'));
            }
        }

        // 모달 외부 클릭시 닫기
        window.addEventListener('click', function(event) {
            const abnormalModal = document.getElementById('csr-abnormal-modal');
            const detailModal = document.getElementById('csr-detail-modal');
            const appVersionModal = document.getElementById('app-version-modal');
            const unusedUsersModal = document.getElementById('unused-users-modal');
            const privacyConsentModal = document.getElementById('privacy-consent-modal');
            const privacyDetailModal = document.getElementById('privacy-detail-modal');
            const chuseokGiftModal = document.getElementById('chuseok-gift-modal');

            if (event.target === abnormalModal) {
                closeCSRAbnormalModal();
            }
            if (event.target === detailModal) {
                closeCSRDetailModal();
            }
            if (event.target === appVersionModal) {
                closeAppVersionModal();
            }
            if (event.target === unusedUsersModal) {
                closeUnusedUsersModal();
            }
            if (event.target === privacyConsentModal) {
                closePrivacyConsentModal();
            }
            if (event.target === privacyDetailModal) {
                closePrivacyDetailModal();
            }
            if (event.target === chuseokGiftModal) {
                closeChuseokGiftModal();
            }

            // 드롭다운 외부 클릭 시 닫기
            const deptDropdown = document.getElementById('dept-filter-dropdown-chuseok');
            const giftStatusDropdown = document.getElementById('gift-status-filter-dropdown');

            if (deptDropdown && !event.target.closest('.dept-filter-header-chuseok')) {
                deptDropdown.classList.remove('show');
            }

            if (giftStatusDropdown && !event.target.closest('.gift-status-filter-header')) {
                giftStatusDropdown.classList.remove('show');
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const privacyDetailModal = document.getElementById('privacy-detail-modal');
                if (privacyDetailModal && privacyDetailModal.style.display === 'block') {
                    closePrivacyDetailModal();
                }
            }
        });

        // 페이지 로드시 CSR 이상내역 개수 로드
        setTimeout(() => {
            loadCSRAbnormalCount();
        }, 1000);

        // AAA 미사용자 명단 관련 함수들
        let unusedUsersData = [];
        let unusedCurrentPage = 1;
        const unusedItemsPerPage = 30;

        // 부서 필터 관련 함수들
        let selectedDept = '전체';
        let allDeptList = [];

        // 부서 목록을 서버에서 가져오기
        async function loadDepartmentList() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch('/api/main/unused-users/departments', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allDeptList = ['전체', ...data.departments];
                } else {
                    allDeptList = ['전체'];
                }
            } catch (error) {
                console.error('부서 목록 로드 오류:', error);
                allDeptList = ['전체'];
            }
        }

        function toggleDeptFilter() {
            const dropdown = document.getElementById('dept-filter-dropdown');
            dropdown.classList.toggle('show');
            
            // 드롭다운이 열릴 때 부서 목록 업데이트
            if (dropdown.classList.contains('show')) {
                updateDeptDropdown();
            }
        }

        function updateDeptDropdown() {
            const dropdown = document.getElementById('dept-filter-dropdown');
            
            // 드롭다운 옵션 생성
            dropdown.innerHTML = '';
            allDeptList.forEach(dept => {
                const option = document.createElement('div');
                option.className = 'dept-filter-option';
                option.textContent = dept;
                option.onclick = (e) => {
                    e.stopPropagation();
                    filterByDept(dept);
                };
                
                if (dept === selectedDept) {
                    option.classList.add('selected');
                }
                
                dropdown.appendChild(option);
            });
        }

        async function filterByDept(dept) {
            selectedDept = dept;
            console.log('부서 필터 선택:', dept);
            
            // 필터 아이콘 회전
            const filterIcon = document.querySelector('.filter-icon');
            filterIcon.style.transform = 'rotate(0deg)';
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('dept-filter-dropdown');
            dropdown.classList.remove('show');
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            unusedCurrentPage = 1;
            await loadUnusedUsersData();
        }

        // AAA 미사용자 데이터 로드 (부서 필터 지원)
        async function loadUnusedUsersData() {
            try {
                console.log('AAA 미사용자 데이터 로드 시작');
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                let url = `/api/main/unused-users?days=30&page=${unusedCurrentPage}&limit=${unusedItemsPerPage}`;
                
                // 부서 필터가 '전체'가 아닌 경우에만 dept 파라미터 추가
                if (selectedDept !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDept)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('미사용자 명단 조회 실패');
                }
                
                const data = await response.json();
                unusedUsersData = data.unusedUsers || [];
                
                displayUnusedUsersData();
                updateUnusedUsersPagination(data.totalPages, data.page, data.total);
                
            } catch (error) {
                console.error('미사용자 명단 로드 오류:', error);
                alert('미사용자 명단을 불러오는데 실패했습니다.');
                
                // 실패시 빈 테이블 표시
                const tbody = document.getElementById('unused-users-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 기존의 클라이언트 사이드 필터링 함수들 제거하고 단순화
        function displayUnusedUsersData() {
            const tbody = document.getElementById('unused-users-tbody');
            tbody.innerHTML = '';
            
            if (unusedUsersData.length === 0) {
                const message = selectedDept !== '전체' ? 
                    `선택한 부서(${selectedDept})에 미사용자가 없습니다.` : 
                    '미사용자가 없습니다.';
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">${message}</td></tr>`;
                return;
            }
            
            unusedUsersData.forEach((user, index) => {
                const row = document.createElement('tr');
                
                // 대화 상태 표시
                let inactiveDays = '-';
                if (user.last_chat_date) {
                    inactiveDays = '대화 기록 있음';
                } else {
                    inactiveDays = '대화 기록 없음';
                }
                
                row.innerHTML = `
                    <td>${user.display_number}</td>
                    <td style="font-weight: bold;">${user.user_id || '-'}</td>
                    <td>${user.name || '-'}</td>
                    <td>${user.dept || '-'}</td>
                    <td>${formatDateTime(user.last_chat_date) || '대화 기록 없음'}</td>
                    <td>${inactiveDays}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // AAA 미사용자 명단 모달 열기 (수정)
        async function openUnusedUsersModal() {
            document.getElementById('unused-users-modal').style.display = 'block';

            // 부서 목록 먼저 로드
            await loadDepartmentList();

            // 그 다음 데이터 로드
            loadUnusedUsersData();

            // 주간 비교 정보 로드
            loadUnusedUsersWeeklyComparison();
        }


        // 미사용자 페이지네이션 업데이트
        function updateUnusedUsersPagination(totalPages, currentPage, totalCount) {
            const pagination = document.getElementById('unused-users-pagination');
            pagination.innerHTML = '';
            
            // 데이터 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.className = 'pagination-info';
            infoDiv.innerHTML = `
                <span style="font-size: 12px; color: #666; margin-right: 15px;">
                    전체 ${totalCount || 0}명 • ${totalPages || 1}페이지 중 ${currentPage || 1}페이지
                </span>
            `;
            pagination.appendChild(infoDiv);
            
            if (totalPages <= 1) return;
            
            // 페이지 버튼 컨테이너
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'pagination-buttons';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '5px';
            buttonsDiv.style.marginTop = '8px';
            
            // 처음 버튼
            if (currentPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '처음';
                firstBtn.style.fontWeight = 'bold';
                firstBtn.onclick = () => {
                    unusedCurrentPage = 1;
                    loadUnusedUsersData();
                };
                buttonsDiv.appendChild(firstBtn);
            }
            
            // 이전 버튼
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '이전';
                prevBtn.onclick = () => {
                    unusedCurrentPage = currentPage - 1;
                    loadUnusedUsersData();
                };
                buttonsDiv.appendChild(prevBtn);
            }
            
            // 페이지 번호
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    unusedCurrentPage = i;
                    loadUnusedUsersData();
                };
                buttonsDiv.appendChild(pageBtn);
            }
            
            // 다음 버튼
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '다음';
                nextBtn.onclick = () => {
                    unusedCurrentPage = currentPage + 1;
                    loadUnusedUsersData();
                };
                buttonsDiv.appendChild(nextBtn);
            }
            
            // 마지막 버튼
            if (currentPage < totalPages) {
                const lastBtn = document.createElement('button');
                lastBtn.textContent = '마지막';
                lastBtn.style.fontWeight = 'bold';
                lastBtn.onclick = () => {
                    unusedCurrentPage = totalPages;
                    loadUnusedUsersData();
                };
                buttonsDiv.appendChild(lastBtn);
            }
            
            pagination.appendChild(buttonsDiv);
        }

        // AAA 미사용자 수 로드 (대시보드 카드용)
        async function loadUnusedUsersCount() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch('/api/main/unused-users/count?days=30', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('unused-users-count').textContent = data.count || 0;
                } else {
                    document.getElementById('unused-users-count').textContent = '0';
                }
            } catch (error) {
                console.error('미사용자 수 로드 오류:', error);
                document.getElementById('unused-users-count').textContent = '0';
            }
        }

        // 페이지 로드시 미사용자 수 로드
        setTimeout(() => {
            loadUnusedUsersCount();
        }, 1500);

        // AAA 미사용자 명단 모달 닫기
        function closeUnusedUsersModal() {
            document.getElementById('unused-users-modal').style.display = 'none';
            // 필터 초기화
            selectedDept = '전체';
        }


        // 모달 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dept-filter-dropdown');
            const header = document.querySelector('.dept-filter-header');
            
            if (dropdown && header && !header.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // 사용자 앱 버전 내역 관련 함수들
        let appVersionData = []; // 현재 페이지 데이터
        let allAppVersionData = []; // 전체 데이터 (정렬용)
        let appVersionCurrentPage = 1;
        const appVersionItemsPerPage = 30;
        let selectedVersion = '전체';
        let selectedDeptAppVersion = '전체';
        let selectedConsentAppVersion = '전체'; // 새로 추가
        let allDeptListAppVersion = [];
        let appVersionSortOrder = 'asc'; // 정렬 순서 추적: 'asc' 또는 'desc'
        let isAppVersionSorted = false; // 정렬 상태 추적

        // 사용자 앱 버전 내역 모달 열기
        function openAppVersionModal() {
            document.getElementById('app-version-modal').style.display = 'block';
            selectedVersion = '전체'; // 모달 열 때 필터 초기화
            selectedDeptAppVersion = '전체'; // 부서 필터도 초기화
            selectedConsentAppVersion = '전체'; // 동의 현황 필터도 초기화
            
            // 정렬 상태 초기화
            isAppVersionSorted = false;
            appVersionSortOrder = 'asc';
            const sortIcon = document.getElementById('dept-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '부서명 정렬';
            }
            
            // 부서 목록 초기화
            if (allDeptListAppVersion.length === 0) {
                allDeptListAppVersion = [
                    '솔루션사업부', 'DTE본부', 'SCM사업부', 'HRS사업부', '남부지사', 
                    'FCM사업부', 'BDS사업부', 'BAC사업부', '중국지사', '인턴', 
                    'PUBLIC CLOUD사업부', 'New Tech사업부', 'Biz AI사업부', 
                    'ITS사업부', 'Innovation Center', '경영관리실'
            ];
                updateDeptDropdownAppVersion();
            }
            
            // 부서 필터 옵션 리스너 설정 (정적 옵션들 포함)
            setupDeptOptionListenersAppVersion();

            loadAppVersionData();
            loadV131WeeklyComparison();
        }

        // 사용자 앱 버전 내역 모달 닫기
        function closeAppVersionModal() {
            document.getElementById('app-version-modal').style.display = 'none';
        }

        // 사용자 앱 버전 내역 필터 초기화
        function resetAppVersionFilters() {
            console.log('사용자 앱 버전 내역 필터 초기화 시작');
            
            // 필터 값들 초기화
            selectedVersion = '전체';
            selectedDeptAppVersion = '전체';
            selectedConsentAppVersion = '전체';
            appVersionSortOrder = null;
            appVersionCurrentPage = 1;
            isAppVersionSorted = false;
            allAppVersionData = [];
            
            // UI에서 필터 표시 업데이트
            const versionFilterOptions = document.querySelectorAll('.version-filter-option');
            versionFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            const deptFilterOptions = document.querySelectorAll('.dept-filter-option-appversion');
            deptFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            const consentFilterOptions = document.querySelectorAll('.consent-filter-option-appversion');
            consentFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            // 헤더 텍스트 업데이트
            const versionFilterIcon = document.querySelector('.version-filter-icon');
            const deptFilterIcon = document.querySelector('.dept-filter-icon-appversion');
            const consentFilterIcon = document.querySelector('.consent-filter-icon-appversion');
            
            if (versionFilterIcon) versionFilterIcon.textContent = '▼';
            if (deptFilterIcon) deptFilterIcon.textContent = '▼';
            if (consentFilterIcon) consentFilterIcon.textContent = '▼';
            
            // 부서 정렬 아이콘 초기화
            const sortIcon = document.getElementById('dept-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '부서명 정렬';
            }
            
            console.log('필터 초기화 완료, 데이터 새로고침');
            
            // 데이터 새로고침
            loadAppVersionData();
        }

        // 부서별 정렬 함수
        async function sortAppVersionByDept() {
            console.log('부서 정렬 시작, 현재 순서:', appVersionSortOrder);
            
            try {
                // 먼저 전체 데이터를 가져옴 (정렬을 위해)
                await loadAllAppVersionData();
                
                // 정렬 순서 토글
                appVersionSortOrder = appVersionSortOrder === 'asc' ? 'desc' : 'asc';
                
                // 아이콘 업데이트
                const sortIcon = document.getElementById('dept-sort-icon');
                if (appVersionSortOrder === 'asc') {
                    sortIcon.textContent = '↑';
                    sortIcon.title = '오름차순 정렬';
                } else {
                    sortIcon.textContent = '↓';
                    sortIcon.title = '내림차순 정렬';
                }
                
                // 전체 데이터 정렬
                allAppVersionData.sort((a, b) => {
                    const deptA = a.dept || '';
                    const deptB = b.dept || '';
                    
                    if (appVersionSortOrder === 'asc') {
                        return deptA.localeCompare(deptB, 'ko-KR');
                    } else {
                        return deptB.localeCompare(deptA, 'ko-KR');
                    }
                });
                
                console.log('정렬 완료, 새로운 순서:', appVersionSortOrder);
                console.log('정렬된 전체 데이터 수:', allAppVersionData.length);
                
                // 정렬 상태 설정 및 페이지를 1로 리셋하고 정렬된 데이터로 페이지네이션 적용
                isAppVersionSorted = true;
                appVersionCurrentPage = 1;
                displaySortedAppVersionData();
                
            } catch (error) {
                console.error('부서 정렬 중 오류:', error);
                alert('부서 정렬 중 오류가 발생했습니다. 기본 페이지네이션을 사용합니다.');
                
                // 정렬 상태 초기화하고 기본 로드 방식 사용
                isAppVersionSorted = false;
                const sortIcon = document.getElementById('dept-sort-icon');
                if (sortIcon) {
                    sortIcon.textContent = '⇅';
                    sortIcon.title = '부서명 정렬';
                }
                
                // 기본 데이터 로드
                loadAppVersionData();
            }
        }

        // 전체 데이터를 가져오는 함수 (정렬용)
        async function loadAllAppVersionData() {
            console.log('전체 데이터 로드 시작');
            
            const adminRole = localStorage.getItem('adminRole');
            const userId = localStorage.getItem('userId');
            
            // 큰 limit로 전체 데이터 요청 (서버 제한을 고려하여 1000으로 설정)
            let url = `/api/main/app-version?page=1&limit=1000`;
            
            // 현재 적용된 필터들 추가
            if (selectedVersion !== '전체') {
                url += `&version=${encodeURIComponent(selectedVersion)}`;
            }
            
            if (selectedDeptAppVersion !== '전체' && selectedDeptAppVersion !== '중국지사 제외') {
                url += `&dept=${encodeURIComponent(selectedDeptAppVersion)}`;
            }
            
            if (selectedConsentAppVersion !== '전체') {
                let consentValue;
                if (selectedConsentAppVersion === '동의함') {
                    consentValue = '1';
                } else if (selectedConsentAppVersion === '동의안함') {
                    consentValue = '0';
                }
                url += `&consent=${consentValue}`;
            }
            
            console.log('전체 데이터 요청 URL:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json',
                    'X-Admin-Role': adminRole,
                    'X-User-ID': userId
                }
            });
            
            if (!response.ok) {
                console.error('API 응답 오류:', response.status, response.statusText);
                const errorText = await response.text();
                console.error('오류 응답 내용:', errorText);
                throw new Error(`전체 데이터 조회 실패: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            allAppVersionData = data.versionList || [];
            
            console.log('전체 데이터 로드 완료:', allAppVersionData.length, '건');
        }

        // 정렬된 데이터를 페이지네이션으로 표시하는 함수
        function displaySortedAppVersionData() {
            const tbody = document.getElementById('app-version-tbody');
            tbody.innerHTML = '';
            
            // 중국지사 제외 필터 적용
            let filteredAllData = allAppVersionData;
            if (selectedDeptAppVersion === '중국지사 제외') {
                filteredAllData = allAppVersionData.filter(item => {
                    return item.dept !== '중국지사';
                });
                console.log(`정렬된 데이터에서 중국지사 제외 필터 적용: ${allAppVersionData.length}명 중 ${filteredAllData.length}명`);
            }
            
            if (filteredAllData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">버전 내역이 없습니다.</td></tr>';
                updateAppVersionPagination(1, 1, 0);
                return;
            }
            
            // 현재 페이지에 해당하는 데이터만 추출
            const startIndex = (appVersionCurrentPage - 1) * appVersionItemsPerPage;
            const endIndex = startIndex + appVersionItemsPerPage;
            const pageData = filteredAllData.slice(startIndex, endIndex);
            
            console.log(`페이지 ${appVersionCurrentPage}: ${startIndex}-${endIndex-1} (총 ${filteredAllData.length}건)`);
            
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                const consentStatus = item.is_agreed == 1 ? '동의함' : '동의안함';
                const consentClass = item.is_agreed == 1 ? 'consent-agreed' : 'consent-disagreed';
                
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td style="font-weight: bold;">${item.user_id || '-'}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.dept || '-'}</td>
                    <td class="version-${getVersionClass(item.version_info)}">${getVersionText(item.version_info)}</td>
                    <td class="${consentClass}">${consentStatus}</td>
                `;
                tbody.appendChild(row);
            });
            
            // 페이지네이션 업데이트 (필터링된 데이터 기준)
            const totalPages = Math.ceil(filteredAllData.length / appVersionItemsPerPage);
            updateAppVersionPagination(totalPages, appVersionCurrentPage, filteredAllData.length);
        }

        // 사용자 앱 버전 내역 데이터 로드
        async function loadAppVersionData() {
            try {
                console.log('=== 사용자 앱 버전 내역 데이터 로드 시작 ===');
                
                // 새로고침 시 정렬 상태 초기화
                isAppVersionSorted = false;
                const sortIcon = document.getElementById('dept-sort-icon');
                if (sortIcon) {
                    sortIcon.textContent = '⇅';
                    sortIcon.title = '부서명 정렬';
                }
                        console.log('현재 필터 상태:');
        console.log('  - selectedVersion:', selectedVersion);
        console.log('  - selectedDeptAppVersion:', selectedDeptAppVersion);
        console.log('  - selectedConsentAppVersion:', selectedConsentAppVersion);
        console.log('  - appVersionCurrentPage:', appVersionCurrentPage);
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                let url = `/api/main/app-version?page=${appVersionCurrentPage}&limit=${appVersionItemsPerPage}`;
                
                // 버전 필터가 '전체'가 아닌 경우에만 version 파라미터 추가
                if (selectedVersion !== '전체') {
                    url += `&version=${encodeURIComponent(selectedVersion)}`;
                    console.log('버전 필터 추가됨:', selectedVersion);
                }
                
                        // 부서 필터가 '전체'가 아닌 경우에만 dept 파라미터 추가
        if (selectedDeptAppVersion !== '전체' && selectedDeptAppVersion !== '중국지사 제외') {
            url += `&dept=${encodeURIComponent(selectedDeptAppVersion)}`;
            console.log('부서 필터 추가됨:', selectedDeptAppVersion);
        }
        
        // 동의 현황 필터가 '전체'가 아닌 경우에만 consent 파라미터 추가
        if (selectedConsentAppVersion !== '전체') {
            let consentValue;
            if (selectedConsentAppVersion === '동의함') {
                consentValue = '1';
            } else if (selectedConsentAppVersion === '동의안함') {
                consentValue = '0';
            }
            url += `&consent=${consentValue}`;
            console.log('동의 현황 필터 추가됨:', selectedConsentAppVersion, '(값:', consentValue + ')');
        }
                
                console.log('최종 API URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('사용자 앱 버전 내역 조회 실패');
                }
                
                const data = await response.json();
                appVersionData = data.versionList || [];
                
                console.log('API 응답 받음:');
                console.log('  - 조회된 사용자 수:', appVersionData.length);
                console.log('  - 전체 사용자 수:', data.total);
                console.log('  - 현재 페이지:', data.page);
                console.log('  - 전체 페이지:', data.totalPages);
                
                // 부서 목록 업데이트 (백엔드에서 받은 것이 있으면 사용, 없으면 하드코딩 사용)
                if (data.departmentList && data.departmentList.length > 0) {
                    console.log('백엔드에서 받은 부서 목록:', data.departmentList);
                    allDeptListAppVersion = data.departmentList;
                } else if (allDeptListAppVersion.length === 0) {
                    console.log('하드코딩된 부서 목록 사용');
                    allDeptListAppVersion = [
                        '솔루션사업부', 'DTE본부', 'SCM사업부', 'HRS사업부', '남부지사', 
                        'FCM사업부', 'BDS사업부', 'BAC사업부', '중국지사', '인턴', 
                        'PUBLIC CLOUD사업부', 'New Tech사업부', 'Biz AI사업부', 
                        'ITS사업부', 'Innovation Center', '경영관리실'
                    ];
                }
                
                // 부서 드롭다운이 이미 열려있다면 업데이트
                const dropdown = document.getElementById('dept-filter-dropdown-appversion');
                if (dropdown && dropdown.classList.contains('show')) {
                    updateDeptDropdownAppVersion();
                }
                
                displayAppVersionData();
                
                // 중국지사 제외 필터가 아닌 경우에만 서버 페이지네이션 정보 사용
                if (selectedDeptAppVersion !== '중국지사 제외') {
                    updateAppVersionPagination(data.totalPages, data.page, data.total);
                }
                
            } catch (error) {
                console.error('사용자 앱 버전 내역 로드 오류:', error);
                alert('사용자 앱 버전 내역을 불러오는데 실패했습니다.');
                
                // 실패시 빈 테이블 표시
                const tbody = document.getElementById('app-version-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 사용자 앱 버전 내역 데이터 표시
        function displayAppVersionData() {
            const tbody = document.getElementById('app-version-tbody');
            tbody.innerHTML = '';
            
            // 중국지사 제외 필터 적용
            let filteredData = appVersionData;
            if (selectedDeptAppVersion === '중국지사 제외') {
                filteredData = appVersionData.filter(item => {
                    return item.dept !== '중국지사';
                });
                console.log(`중국지사 제외 필터 적용: ${appVersionData.length}명 중 ${filteredData.length}명`);
            }
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">버전 내역이 없습니다.</td></tr>';
                return;
            }
            
            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                        // 개인정보 동의 현황 표시
        const consentStatus = item.is_agreed == 1 ? '동의함' : '동의안함';
        const consentClass = item.is_agreed == 1 ? 'consent-agreed' : 'consent-disagreed';
        
        row.innerHTML = `
            <td>${item.display_number || ((appVersionCurrentPage - 1) * appVersionItemsPerPage + index + 1)}</td>
            <td style="font-weight: bold;">${item.user_id || '-'}</td>
            <td>${item.name || '-'}</td>
            <td>${item.dept || '-'}</td>
            <td class="version-${getVersionClass(item.version_info)}">${getVersionText(item.version_info)}</td>
            <td class="${consentClass}">${consentStatus}</td>
        `;
                
                tbody.appendChild(row);
            });
            
            // 중국지사 제외 필터 적용 시 페이지네이션도 필터링된 데이터 기준으로 업데이트
            if (selectedDeptAppVersion === '중국지사 제외') {
                // 클라이언트에서 필터링된 데이터 기준으로 페이지네이션 계산
                const totalFilteredPages = Math.ceil(filteredData.length / appVersionItemsPerPage);
                updateAppVersionPagination(totalFilteredPages, appVersionCurrentPage, filteredData.length);
            }
        }

        // 버전 클래스 반환
        function getVersionClass(version) {
            if (version === '1.3.1') return 'latest';
            if (version === '1.3.0') return 'latest';
            if (version === '1.2.1') return 'latest';
            if (version === '1.2.0') return 'latest';
            return 'old';
        }

        // 버전 텍스트 반환
        function getVersionText(version) {
            return version || '없음';
        }

        // 사용자 앱 버전 내역 페이지네이션 업데이트
        function updateAppVersionPagination(totalPages, currentPage, totalCount) {
            const pagination = document.getElementById('app-version-pagination');
            pagination.innerHTML = '';
            
            // 데이터 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.className = 'pagination-info';
            infoDiv.innerHTML = `
                <span style="font-size: 12px; color: #666; margin-right: 15px;">
                    전체 ${totalCount || 0}명 • ${totalPages || 1}페이지 중 ${currentPage || 1}페이지
                </span>
            `;
            pagination.appendChild(infoDiv);
            
            if (totalPages <= 1) return;
            
            // 페이지 버튼 컨테이너
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'pagination-buttons';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '5px';
            buttonsDiv.style.marginTop = '8px';
            
            // 처음 버튼
            if (currentPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '처음';
                firstBtn.style.fontWeight = 'bold';
                firstBtn.onclick = () => {
                    appVersionCurrentPage = 1;
                    if (isAppVersionSorted) {
                        displaySortedAppVersionData();
                    } else {
                        loadAppVersionData();
                    }
                };
                buttonsDiv.appendChild(firstBtn);
            }
            
            // 이전 버튼
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '이전';
                prevBtn.onclick = () => {
                    appVersionCurrentPage = currentPage - 1;
                    if (isAppVersionSorted) {
                        displaySortedAppVersionData();
                    } else {
                        loadAppVersionData();
                    }
                };
                buttonsDiv.appendChild(prevBtn);
            }
            
            // 페이지 번호
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    appVersionCurrentPage = i;
                    if (isAppVersionSorted) {
                        displaySortedAppVersionData();
                    } else {
                        loadAppVersionData();
                    }
                };
                buttonsDiv.appendChild(pageBtn);
            }
            
            // 다음 버튼
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '다음';
                nextBtn.onclick = () => {
                    appVersionCurrentPage = currentPage + 1;
                    if (isAppVersionSorted) {
                        displaySortedAppVersionData();
                    } else {
                        loadAppVersionData();
                    }
                };
                buttonsDiv.appendChild(nextBtn);
            }
            
            // 마지막 버튼
            if (currentPage < totalPages) {
                const lastBtn = document.createElement('button');
                lastBtn.textContent = '마지막';
                lastBtn.style.fontWeight = 'bold';
                lastBtn.onclick = () => {
                    appVersionCurrentPage = totalPages;
                    if (isAppVersionSorted) {
                        displaySortedAppVersionData();
                    } else {
                        loadAppVersionData();
                    }
                };
                buttonsDiv.appendChild(lastBtn);
            }
            
            pagination.appendChild(buttonsDiv);
        }

        // 앱 버전 요약 정보 로드 (대시보드 카드용)
        async function loadAppVersionSummary() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch('/api/main/app-version/summary', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const summaryText = `v1.3.1: ${data.v131_count || 0}명, v1.3.0: ${data.v130_count || 0}명, v1.2.1: ${data.v121_count || 0}명, v1.2.0: ${data.v120_count || 0}명, v1.1.0: ${data.v110_count || 0}명`;
                    document.getElementById('app-version-summary').textContent = summaryText;
                } else {
                    document.getElementById('app-version-summary').textContent = '로드 실패';
                }
            } catch (error) {
                console.error('앱 버전 요약 정보 로드 오류:', error);
                document.getElementById('app-version-summary').textContent = '로드 실패';
            }
        }

        // 버전 필터 드롭다운 토글
        function toggleVersionFilter(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('version-filter-dropdown');
            dropdown.classList.toggle('show');
            
            // 드롭다운이 열릴 때 선택된 옵션 업데이트
            if (dropdown.classList.contains('show')) {
                updateVersionDropdown();
                setupVersionOptionListeners();
            }
        }

        function setupVersionOptionListeners() {
            const options = document.querySelectorAll('.version-filter-option');
            console.log('버전 옵션 리스너 설정:', options.length, '개');
            options.forEach(option => {
                option.onclick = function(event) {
                    event.stopPropagation();
                    const version = this.getAttribute('data-version');
                    console.log('버전 옵션 클릭됨:', version);
                    filterByVersion(version);
                };
            });
        }

        function updateVersionDropdown() {
            const dropdown = document.getElementById('version-filter-dropdown');
            const options = dropdown.querySelectorAll('.version-filter-option');
            
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-version') === selectedVersion) {
                    option.classList.add('selected');
                }
            });
        }

        async function filterByVersion(version) {
            selectedVersion = version;
            console.log('버전 필터 선택:', version);
            
            // 필터 변경 시 정렬 상태 초기화
            isAppVersionSorted = false;
            const sortIcon = document.getElementById('dept-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '부서명 정렬';
            }
            
            // 필터 아이콘 회전
            const filterIcon = document.querySelector('.version-filter-icon');
            filterIcon.style.transform = 'rotate(0deg)';
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('version-filter-dropdown');
            dropdown.classList.remove('show');
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            appVersionCurrentPage = 1;
            await loadAppVersionData();
        }

        // 개인정보 동의 현황 관련 함수들
        let privacyConsentData = []; // 현재 페이지 데이터
        let allPrivacyConsentData = []; // 정렬용 전체 데이터
        let privacyConsentCurrentPage = 1;
        const privacyConsentItemsPerPage = 30;
        let selectedConsent = '전체';
        let selectedDeptPrivacy = '전체';
        let selectedBirthdayMonth = '전체';
        let birthdaySortOrder = null; // null, 'birthday_asc', 'birthday_desc'
        let allDeptListPrivacy = [];
        let monthlyBirthdayCounts = {};
        let isFullDataSorted = false; // 전체 데이터 정렬 상태
        let selectedYear = 2025; // 현재 선택된 연도 (기본값: 2025년)
        let globalTotalCount = 0; // 전체 인원수 (필터 무관)
        let globalNoBirthdayCount = 0; // 전체 미작성 인원수 (필터 무관)
        let searchNameTerm = ''; // 이름 검색어
        let isSeniorEmployeeFilterActive = false; // 3개월 이상 근무자 필터 활성화 상태

        // 개인정보 동의 현황 추이 조회
        async function getPrivacyTrend() {
            try {
                const startDateInput = document.getElementById('privacy-trend-start-date').value;
                const endDateInput = document.getElementById('privacy-trend-end-date').value;
                const resultSpan = document.getElementById('privacy-trend-result');

                if (!startDateInput || !endDateInput) {
                    resultSpan.textContent = '⚠️ 시작일과 종료일을 모두 입력해주세요';
                    resultSpan.style.color = '#dc3545';
                    return;
                }

                // ISO 8601 형식으로 변환 (UTC)
                const startDate = new Date(startDateInput + 'T00:00:00Z').toISOString();
                const endDate = new Date(endDateInput + 'T23:59:59Z').toISOString();

                resultSpan.textContent = '조회 중...';
                resultSpan.style.color = '#6c757d';

                const response = await fetch('https://ai2great.com:8060/api/getUpdatePrivacyCount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                if (!response.ok) {
                    throw new Error('API 요청 실패');
                }

                const data = await response.json();

                if (data.error) {
                    resultSpan.textContent = `⚠️ ${data.error}`;
                    resultSpan.style.color = '#dc3545';
                } else {
                    resultSpan.textContent = `✅ 증가: ${data.count || 0}명`;
                    resultSpan.style.color = '#28a745';
                }

            } catch (error) {
                console.error('개인정보 동의 추이 조회 오류:', error);
                const resultSpan = document.getElementById('privacy-trend-result');
                resultSpan.textContent = '⚠️ 조회 실패';
                resultSpan.style.color = '#dc3545';
            }
        }

        // 개인정보 동의 현황 모달 열기
        function openPrivacyConsentModal() {
            document.getElementById('privacy-consent-modal').style.display = 'block';
            selectedConsent = '전체'; // 모달 열 때 필터 초기화
            selectedDeptPrivacy = '전체'; // 부서 필터도 초기화
            selectedBirthdayMonth = '전체'; // 생일 월 필터도 초기화
            birthdaySortOrder = null; // 정렬 상태 초기화
            searchNameTerm = ''; // 이름 검색어 초기화
            isSeniorEmployeeFilterActive = false; // 3개월 이상 근무자 필터 초기화
            
            // 이름 검색 입력 필드 초기화
            const nameSearchInput = document.getElementById('name-search-input');
            if (nameSearchInput) {
                nameSearchInput.value = '';
            }
            
            // 3개월 이상 근무자 필터 버튼 상태 초기화
            const seniorFilterBtn = document.getElementById('senior-employee-filter-btn');
            if (seniorFilterBtn) {
                seniorFilterBtn.style.backgroundColor = '#28a745';
                seniorFilterBtn.style.color = '#fff';
                seniorFilterBtn.textContent = '3개월+';
            }
            
            // 부서 목록 초기화
            if (allDeptListPrivacy.length === 0) {
                allDeptListPrivacy = [
                    '대표이사', '부문대표', 'IES본부', 'NGE본부',
                    '솔루션사업부', 'DTE본부', 'SCM사업부', 'HRS사업부', '남부지사', 
                    'FCM사업부', 'BDS사업부', 'BAC사업부', '중국지사', '인턴', 
                    'PUBLIC CLOUD사업부', 'New Tech사업부', 'Biz AI사업부', 
                    'ITS사업부', 'Innovation Center', '경영관리실'
                ];
            }
            
            // 전체 인원수를 먼저 로드한 후 다른 데이터 로드
            loadGlobalCounts().then(() => {
                loadPrivacyConsentData();
                loadBirthdayCountByMonth();
                updateFilterStatusDisplay(); // 필터 상태 초기화
            });
        }

        // 개인정보 동의 현황 모달 닫기
        function closePrivacyConsentModal() {
            document.getElementById('privacy-consent-modal').style.display = 'none';
            // 필터 초기화
            selectedConsent = '전체';
            selectedDeptPrivacy = '전체';
            selectedBirthdayMonth = '전체';
            birthdaySortOrder = null;
            searchNameTerm = ''; // 이름 검색어 초기화
            isSeniorEmployeeFilterActive = false; // 3개월 이상 근무자 필터 초기화
            
            // 이름 검색 입력 필드 초기화
            const nameSearchInput = document.getElementById('name-search-input');
            if (nameSearchInput) {
                nameSearchInput.value = '';
            }
            
            // 3개월 이상 근무자 필터 버튼 상태 초기화
            const seniorFilterBtn = document.getElementById('senior-employee-filter-btn');
            if (seniorFilterBtn) {
                seniorFilterBtn.style.backgroundColor = '#28a745';
                seniorFilterBtn.style.color = '#fff';
                seniorFilterBtn.textContent = '3개월+';
            }
            
            // 월별 생일자 현황 아이템들의 선택 상태 리셋
            const birthdayCountItems = document.querySelectorAll('.birthday-count-item');
            birthdayCountItems.forEach(item => {
                item.classList.remove('selected');
            });
        }

        // 토스 스타일 개인정보 상세보기 모달 열기
        function openPrivacyDetailModal(userData) {
            const modal = document.getElementById('privacy-detail-modal');
            
            // 사용자 이름 첫 글자로 아바타 생성
            const userInitial = (userData.name && userData.name.length > 0) ? userData.name.charAt(0) : '?';
            document.getElementById('detail-user-initial').textContent = userInitial;
            
            // 기본 정보 설정
            document.getElementById('detail-user-name').textContent = userData.name || '-';
            document.getElementById('detail-user-dept').textContent = userData.dept || '-';
            document.getElementById('detail-user-id').textContent = userData.user_id || '-';
            
            // 생일 정보 설정
            let birthdayDisplay = '인사기록카드 미작성';
            if (userData.birthday && userData.birthday !== '인사기록카드 미작성') {
                try {
                    // YYYY-MM-DD 또는 MM-DD 형식 처리
                    const birthdayParts = userData.birthday.split('-');
                    if (birthdayParts.length >= 2) {
                        const month = birthdayParts[birthdayParts.length - 2];
                        const day = birthdayParts[birthdayParts.length - 1];
                        birthdayDisplay = `${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    } else {
                        birthdayDisplay = userData.birthday;
                    }
                } catch (error) {
                    birthdayDisplay = userData.birthday;
                }
            }
            document.getElementById('detail-user-birthday').textContent = birthdayDisplay;
            
            // 개인정보 동의 상태 설정
            const consentElement = document.getElementById('detail-user-consent');
            const isAgreed = userData.is_agreed == 1;
            consentElement.textContent = isAgreed ? '동의함' : '미동의';
            consentElement.className = 'toss-info-value toss-consent-badge ' + (isAgreed ? 'agreed' : 'disagreed');
            
            // 추가 정보 설정 (기본값 또는 실제 데이터가 있다면 표시)
            document.getElementById('detail-user-phone').textContent = userData.phone || '정보 없음';
            document.getElementById('detail-user-hire-date').textContent = userData.hire_date || '정보 없음';
            document.getElementById('detail-user-position').textContent = userData.position || '정보 없음';
            
            // 모달 표시
            modal.style.display = 'block';
        }

        // 토스 스타일 개인정보 상세보기 모달 닫기
        function closePrivacyDetailModal() {
            const modal = document.getElementById('privacy-detail-modal');
            modal.style.display = 'none';
        }

        // 쿠폰 정보 파싱 함수
        function parseCouponInfo(couponsData, birthdayMessageData, targetYear) {
            const result = {
                status: '미발송',
                expiry: '-',
                usage: '-'
            };

            try {
                let targetCoupon = null;
                
                // coupons JSON 파싱 및 해당 연도 쿠폰 찾기
                if (couponsData) {
                    let coupons;
                    if (typeof couponsData === 'string') {
                        coupons = JSON.parse(couponsData);
                    } else if (Array.isArray(couponsData)) {
                        coupons = couponsData;
                    }

                    if (Array.isArray(coupons) && coupons.length > 0) {
                        // 해당 연도의 쿠폰 찾기
                        targetCoupon = coupons.find(coupon => {
                            if (coupon.tr_id) {
                                const yearFromTrId = coupon.tr_id.substring(0, 2);
                                return yearFromTrId === String(targetYear).substring(2);
                            }
                            return false;
                        });
                    }
                }

                // 해당 연도의 쿠폰이 있는 경우에만 처리
                if (targetCoupon) {
                    // birthday_message 테이블에서 gift 큐 확인 (해당 연도 쿠폰이 있을 때만)
                    if (birthdayMessageData && birthdayMessageData.queue_name === 'gift' && birthdayMessageData.send_time) {
                        const sendDate = new Date(birthdayMessageData.send_time);
                        result.status = `발송(${sendDate.getFullYear()}-${String(sendDate.getMonth() + 1).padStart(2, '0')}-${String(sendDate.getDate()).padStart(2, '0')})`;
                    }

                    // 유효기간 설정
                    if (targetCoupon.coupon_end_date) {
                        const endDate = new Date(targetCoupon.coupon_end_date);
                        result.expiry = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                    }

                    // 사용여부 설정
                    if (targetCoupon.coupon_status) {
                        result.usage = targetCoupon.coupon_status;
                    }
                } else {
                    // 해당 연도의 쿠폰이 없는 경우 - 모든 값을 기본값으로 유지
                    console.log(`${targetYear}년도 쿠폰이 없습니다.`);
                }
                
            } catch (error) {
                console.error('쿠폰 정보 파싱 오류:', error);
            }

            return result;
        }

        // 추석 선물 모니터링 현황 관련 함수들
        let chuseokGiftData = [];
        let chuseokCurrentPage = 1;
        const chuseokItemsPerPage = 50;
        let selectedChuseokDept = '전체';
        let selectedGiftStatus = '전체';
        let isChuseokSeniorEmployeeFilterActive = false;

        // 추석 선물 모니터링 현황 모달 열기
        function openChuseokGiftModal() {
            document.getElementById('chuseok-gift-modal').style.display = 'block';
            // 필터 초기화
            selectedChuseokDept = '전체';
            selectedGiftStatus = '전체';
            chuseokCurrentPage = 1;

            loadChuseokGiftData();
        }

        // 추석 선물 모니터링 현황 모달 닫기
        function closeChuseokGiftModal() {
            document.getElementById('chuseok-gift-modal').style.display = 'none';
        }

        // 추석 선물 모니터링 현황 데이터 로드
        async function loadChuseokGiftData() {
            try {
                console.log('추석 선물 모니터링 현황 데이터 로드 시작');

                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                const params = new URLSearchParams({
                    page: chuseokCurrentPage,
                    limit: chuseokItemsPerPage
                });

                if (selectedChuseokDept !== '전체') {
                    params.append('dept', selectedChuseokDept);
                }

                // gift_status 필터는 클라이언트에서 처리

                const response = await fetch(`/api/main/chuseok-gift?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });

                if (!response.ok) {
                    throw new Error('추석 선물 모니터링 현황 조회 실패');
                }

                const result = await response.json();
                console.log('서버 응답:', result);

                chuseokGiftData = result.chuseokGiftList || result.data || [];

                // 부서 목록 추출 및 드롭다운 업데이트 (첫 페이지 로딩시)
                if (chuseokCurrentPage === 1) {
                    // 서버에서 부서 목록을 제공하면 사용, 없으면 데이터에서 추출
                    let departments = result.departmentList || [];
                    if (departments.length === 0 && chuseokGiftData.length > 0) {
                        // 데이터에서 고유한 부서 목록 추출
                        const deptSet = new Set();
                        chuseokGiftData.forEach(item => {
                            if (item.dept) {
                                deptSet.add(item.dept);
                            }
                        });
                        departments = Array.from(deptSet).sort();
                    }
                    if (departments.length > 0) {
                        updateChuseokDeptDropdown(departments);
                    }
                }

                displayChuseokGiftData();

                // pagination 데이터 안전하게 처리
                const totalPages = result.totalPages || Math.ceil((result.total || chuseokGiftData.length) / chuseokItemsPerPage);
                const currentPage = result.page || chuseokCurrentPage;
                const total = result.total || chuseokGiftData.length;

                updateChuseokGiftPagination(totalPages, currentPage, total);

                console.log('추석 선물 모니터링 현황 데이터 로드 완료');

            } catch (error) {
                console.error('추석 선물 모니터링 현황 로드 오류:', error);
                console.error('에러 상세:', error.message);
                alert('추석 선물 모니터링 현황을 불러오는데 실패했습니다: ' + error.message);

                const tbody = document.getElementById('chuseok-gift-tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 추석 선물 모니터링 현황 데이터 표시
        function displayChuseokGiftData() {
            const tbody = document.getElementById('chuseok-gift-tbody');
            tbody.innerHTML = '';

            if (chuseokGiftData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">데이터가 없습니다.</td></tr>';
                return;
            }

            let filteredData = chuseokGiftData;

            // 수령여부 필터 적용
            if (selectedGiftStatus !== '전체') {
                filteredData = chuseokGiftData.filter(item => {
                    let giftStatus = '미수령';

                    if (item.coupons) {
                        try {
                            const coupons = typeof item.coupons === 'string' ? JSON.parse(item.coupons) : item.coupons;
                            const couponWithE = coupons.find(c => c.tr_id && c.tr_id.includes('_e'));

                            if (couponWithE && item.queue_name === 'gift') {
                                giftStatus = '수령';
                            }
                        } catch (e) {
                            console.error('쿠폰 데이터 파싱 오류:', e);
                        }
                    }

                    return giftStatus === selectedGiftStatus;
                });
            }

            // 서버에서 이미 정렬되어 옴 (수령 먼저, 미수령 나중)

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">필터 조건에 맞는 데이터가 없습니다.</td></tr>';
                return;
            }

            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');

                // 추석 선물 발송 상태 및 쿠폰 만료일 추출
                let giftStatus = '미수령';
                let giftStatusClass = 'not-sent';
                let couponEndDate = '-';

                if (item.coupons) {
                    try {
                        const coupons = typeof item.coupons === 'string' ? JSON.parse(item.coupons) : item.coupons;
                        const couponWithE = coupons.find(c => c.tr_id && c.tr_id.includes('_e'));

                        // queue_name이 'gift'이고 tr_id에 '_e'가 있는 경우 수령
                        if (couponWithE && item.queue_name === 'gift') {
                            giftStatus = '수령';
                            giftStatusClass = 'sent';
                        }

                        // 쿠폰 만료일 추출 (연월일만)
                        if (couponWithE && couponWithE.coupon_end_date) {
                            const endDate = couponWithE.coupon_end_date.split(' ')[0]; // YYYY-MM-DD 부분만 추출
                            couponEndDate = endDate;
                        }
                    } catch (e) {
                        console.error('쿠폰 데이터 파싱 오류:', e);
                    }
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.dept || '-'}</td>
                    <td>${item.user_id || '-'}</td>
                    <td>
                        <span class="gift-status ${giftStatusClass}">
                            ${giftStatus}
                        </span>
                    </td>
                    <td>${couponEndDate}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // 추석 선물 모니터링 현황 페이지네이션 업데이트
        function updateChuseokGiftPagination(totalPages, currentPage, totalCount) {
            const pagination = document.getElementById('chuseok-gift-pagination');
            pagination.innerHTML = '';

            // 데이터 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.className = 'pagination-info';
            infoDiv.innerHTML = `
                <span style="font-size: 12px; color: #666; margin-right: 15px;">
                    전체 ${totalCount || 0}건 • ${totalPages || 1}페이지 중 ${currentPage || 1}페이지
                </span>
            `;
            pagination.appendChild(infoDiv);

            if (totalPages <= 1) return;

            // 페이지 버튼 컨테이너
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'pagination-buttons';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '5px';
            buttonsDiv.style.marginTop = '8px';

            // 이전 페이지
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '이전';
                prevBtn.onclick = () => {
                    chuseokCurrentPage = currentPage - 1;
                    loadChuseokGiftData();
                };
                buttonsDiv.appendChild(prevBtn);
            }

            // 페이지 번호들
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.style.fontWeight = i === currentPage ? 'bold' : 'normal';
                pageBtn.style.backgroundColor = i === currentPage ? '#007bff' : '#f8f9fa';
                pageBtn.style.color = i === currentPage ? 'white' : '#333';
                pageBtn.onclick = () => {
                    chuseokCurrentPage = i;
                    loadChuseokGiftData();
                };
                buttonsDiv.appendChild(pageBtn);
            }

            // 다음 페이지
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '다음';
                nextBtn.onclick = () => {
                    chuseokCurrentPage = currentPage + 1;
                    loadChuseokGiftData();
                };
                buttonsDiv.appendChild(nextBtn);
            }

            pagination.appendChild(buttonsDiv);
        }



        // 3개월 이상 근무자 필터 토글
        function toggleChuseokSeniorEmployeeFilter() {
            isChuseokSeniorEmployeeFilterActive = !isChuseokSeniorEmployeeFilterActive;

            const btn = document.getElementById('chuseok-senior-employee-filter-btn');
            if (isChuseokSeniorEmployeeFilterActive) {
                btn.style.backgroundColor = '#dc3545';
                btn.style.color = '#fff';
                btn.textContent = '3개월+ ON';
            } else {
                btn.style.backgroundColor = '#28a745';
                btn.style.color = '#fff';
                btn.textContent = '3개월+';
            }

            chuseokCurrentPage = 1;
            loadChuseokGiftData();
        }

        // 필터 초기화
        function resetChuseokGiftFilters() {
            selectedChuseokDept = '전체';
            selectedGiftStatus = '전체';
            chuseokCurrentPage = 1;

            // 드롭다운 선택 상태 초기화
            updateChuseokDeptFilterDisplay();
            updateGiftStatusFilterDisplay();

            // 필터 버튼 상태 초기화
            const seniorFilterBtn = document.getElementById('chuseok-senior-employee-filter-btn');
            if (seniorFilterBtn) {
                seniorFilterBtn.style.backgroundColor = '#28a745';
                seniorFilterBtn.style.color = '#fff';
                seniorFilterBtn.textContent = '3개월+';
            }

            // 드롭다운 표시 업데이트
            updateChuseokDeptFilterDisplay();

            // 선택 상태 업데이트
            const deptOptions = document.querySelectorAll('.chuseok-dept-filter-option');
            deptOptions.forEach(option => {
                option.classList.toggle('selected', option.getAttribute('data-dept') === '전체');
            });

            loadChuseokGiftData();
        }

        // 부서 필터 토글
        function toggleDeptFilterChuseok(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('dept-filter-dropdown-chuseok');
            const isVisible = dropdown.classList.contains('show');

            if (isVisible) {
                dropdown.classList.remove('show');
            } else {
                // 드롭다운 위치 계산
                const rect = event.currentTarget.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom}px`;
                dropdown.style.left = `${rect.left}px`;

                dropdown.classList.add('show');
                updateChuseokDeptFilterDisplay();
            }
        }

        // 부서 드롭다운 업데이트
        function updateChuseokDeptDropdown(departments) {
            const dropdown = document.getElementById('dept-filter-dropdown-chuseok');
            dropdown.innerHTML = '';

            // '전체' 옵션 추가
            const allOption = document.createElement('div');
            allOption.className = 'dept-filter-option-chuseok';
            allOption.setAttribute('data-dept', '전체');
            allOption.textContent = '전체';
            allOption.onclick = function() {
                filterChuseokByDept('전체');
            };
            dropdown.appendChild(allOption);

            // 각 부서 옵션 추가
            departments.forEach(dept => {
                const option = document.createElement('div');
                option.className = 'dept-filter-option-chuseok';
                option.setAttribute('data-dept', dept);
                option.textContent = dept;
                option.onclick = function() {
                    filterChuseokByDept(dept);
                };
                dropdown.appendChild(option);
            });

            updateChuseokDeptFilterDisplay();
        }

        // 부서 필터 표시 업데이트
        function updateChuseokDeptFilterDisplay() {
            const options = document.querySelectorAll('.dept-filter-option-chuseok');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-dept') === selectedChuseokDept) {
                    option.classList.add('selected');
                }
            });
        }

        // 부서 필터 적용
        function filterChuseokByDept(dept) {
            selectedChuseokDept = dept;
            chuseokCurrentPage = 1;

            const dropdown = document.getElementById('dept-filter-dropdown-chuseok');
            dropdown.classList.remove('show');

            updateChuseokDeptFilterDisplay();
            loadChuseokGiftData();
        }

        // 발송 상태 필터 토글
        function toggleGiftStatusFilter(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('gift-status-filter-dropdown');
            const isVisible = dropdown.classList.contains('show');

            if (isVisible) {
                dropdown.classList.remove('show');
            } else {
                // 드롭다운 위치 계산
                const rect = event.currentTarget.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom}px`;
                dropdown.style.left = `${rect.left}px`;

                dropdown.classList.add('show');
                updateGiftStatusFilterDisplay();
            }
        }

        // 발송 상태 필터 표시 업데이트
        function updateGiftStatusFilterDisplay() {
            const options = document.querySelectorAll('.gift-status-filter-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-status') === selectedGiftStatus) {
                    option.classList.add('selected');
                }

                option.onclick = function() {
                    filterByGiftStatus(this.getAttribute('data-status'));
                };
            });
        }

        // 발송 상태 필터 적용
        function filterByGiftStatus(status) {
            selectedGiftStatus = status;
            chuseokCurrentPage = 1;

            const dropdown = document.getElementById('gift-status-filter-dropdown');
            dropdown.classList.remove('show');

            updateGiftStatusFilterDisplay();
            loadChuseokGiftData();
        }

        // Excel 내보내기
        async function exportChuseokGiftToExcel() {
            try {
                console.log('추석 선물 모니터링 현황 Excel 내보내기 시작');

                // 전체 데이터 조회
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                const params = new URLSearchParams({
                    page: 1,
                    limit: 10000, // 충분히 큰 값
                    dept: selectedChuseokDept === '전체' ? '' : selectedChuseokDept,
                    senior_employee: isChuseokSeniorEmployeeFilterActive.toString()
                });

                const response = await fetch(`/api/main/chuseok-gift?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'admin-role': adminRole,
                        'user-id': userId
                    }
                });

                if (!response.ok) {
                    throw new Error('데이터 조회 실패');
                }

                const data = await response.json();
                const allData = data.chuseokGiftList || [];

                // Excel 데이터 구성
                const worksheetData = [
                    ['번호', '이름', '부서', '사용자 ID', '수령여부', '쿠폰 만료일']
                ];

                allData.forEach((item, index) => {
                    let giftStatus = '미수령';
                    let couponEndDate = '-';

                    if (item.coupons) {
                        try {
                            const coupons = typeof item.coupons === 'string' ? JSON.parse(item.coupons) : item.coupons;
                            const couponWithE = coupons.find(c => c.tr_id && c.tr_id.includes('_e'));

                            if (couponWithE && item.queue_name === 'gift') {
                                giftStatus = '수령';
                            }

                            if (couponWithE && couponWithE.coupon_end_date) {
                                couponEndDate = couponWithE.coupon_end_date.split(' ')[0];
                            }
                        } catch (e) {
                            console.error('쿠폰 데이터 파싱 오류:', e);
                        }
                    }

                    worksheetData.push([
                        index + 1,
                        item.name || '-',
                        item.dept || '-',
                        item.user_id || '-',
                        giftStatus,
                        couponEndDate
                    ]);
                });

                // SheetJS를 사용하여 Excel 파일 생성
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '추석 선물 모니터링 현황');

                // 컬럼 너비 설정
                worksheet['!cols'] = [
                    { width: 8 },   // 번호
                    { width: 12 },  // 이름
                    { width: 20 },  // 부서
                    { width: 25 },  // 사용자 ID
                    { width: 15 },  // 수령여부
                    { width: 20 }   // 쿠폰 만료일
                ];

                // 파일명 생성
                const now = new Date();
                const dateStr = now.toISOString().substring(0, 10).replace(/-/g, '');

                let filterInfo = '';
                if (selectedChuseokDept !== '전체') filterInfo += `_부서${selectedChuseokDept}`;
                if (isChuseokSeniorEmployeeFilterActive) filterInfo += '_3개월이상';

                const filename = `추석_선물_모니터링_현황_${dateStr}${filterInfo}.xlsx`;

                // 파일 다운로드
                XLSX.writeFile(workbook, filename);

                console.log('Excel 파일 다운로드 완료:', filename);

            } catch (error) {
                console.error('추석 선물 모니터링 현황 Excel 내보내기 오류:', error);
                alert('Excel 파일 내보내기에 실패했습니다.');
            }
        }

        // 연도 탭 전환 함수
        function switchYearTab(year) {
            console.log('연도 탭 전환:', year);
            
            // 이전 활성 탭 제거
            document.querySelectorAll('.year-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 새로운 활성 탭 설정
            document.getElementById(`year-tab-${year}`).classList.add('active');
            
            // 선택된 연도 업데이트
            selectedYear = year;
            
            // 페이지 초기화
            privacyConsentCurrentPage = 1;
            
            // 데이터 다시 로드
            loadPrivacyConsentData();
        }

        // 전체 인원수 로드 (필터 무관 고정값)
        async function loadGlobalCounts() {
            try {
                console.log('전체 인원수 로드 시작 (필터 무관)');
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                // 필터 없이 전체 데이터 조회
                const url = `/api/main/privacy-consent?page=1&limit=10000`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('전체 인원수 조회 실패');
                }
                
                const data = await response.json();
                console.log('전체 데이터 조회 결과:', data);
                
                if (data.success && data.consentList) {
                    globalTotalCount = data.consentList.length;
                    
                    // 미작성 인원수 계산 (다양한 조건 확인)
                    const noBirthdayList = data.consentList.filter(item => {
                        const birthday = item.birthday;
                        return !birthday || 
                               birthday === null || 
                               birthday === undefined || 
                               birthday === '' || 
                               birthday === '인사기록카드 미작성' ||
                               birthday.trim() === '';
                    });
                    
                    globalNoBirthdayCount = noBirthdayList.length;
                    
                    console.log('=== 전체 데이터 분석 ===');
                    console.log('전체 인원수:', globalTotalCount);
                    console.log('미작성 인원수:', globalNoBirthdayCount);
                    console.log('샘플 미작성 데이터:', noBirthdayList.slice(0, 3).map(item => ({
                        name: item.name,
                        birthday: item.birthday
                    })));
                    
                    // 즉시 표시 업데이트
                    updateGlobalCountDisplay();
                    
                    // 월별 현황에서 미작성 항목도 업데이트
                    updateNoBirthdayItemDisplay();
                }
                
            } catch (error) {
                console.error('전체 인원수 로드 오류:', error);
                globalTotalCount = 0;
                globalNoBirthdayCount = 0;
                updateGlobalCountDisplay();
            }
        }

        // 전체 인원수 표시 업데이트
        function updateGlobalCountDisplay() {
            const totalCountElement = document.getElementById('total-birthday-count');
            const noBirthdayCountElement = document.getElementById('no-birthday-count');
            
            if (totalCountElement) {
                totalCountElement.textContent = globalTotalCount;
            }
            if (noBirthdayCountElement) {
                noBirthdayCountElement.textContent = globalNoBirthdayCount;
            }
        }

        // 월별 현황에서 미작성 항목 업데이트
        function updateNoBirthdayItemDisplay() {
            const noBirthdayItems = document.querySelectorAll('.no-birthday-item .month-count');
            noBirthdayItems.forEach(item => {
                item.textContent = `${globalNoBirthdayCount}명`;
            });
            console.log('미작성 항목 업데이트:', globalNoBirthdayCount + '명');
        }

        // 개인정보 동의 현황 필터 초기화
        function resetPrivacyConsentFilters() {
            console.log('개인정보 동의 현황 필터 초기화 시작');
            
            // 필터 값들 초기화
            selectedConsent = '전체';
            selectedDeptPrivacy = '전체';  
            selectedBirthdayMonth = '전체';
            birthdaySortOrder = null;
            privacyConsentCurrentPage = 1;
            isFullDataSorted = false;
            allPrivacyConsentData = [];
            searchNameTerm = ''; // 이름 검색어 초기화
            isSeniorEmployeeFilterActive = false; // 3개월 이상 근무자 필터 초기화
            
            // 이름 검색 입력 필드 초기화
            const nameSearchInput = document.getElementById('name-search-input');
            if (nameSearchInput) {
                nameSearchInput.value = '';
            }
            
            // 3개월 이상 근무자 필터 버튼 상태 초기화
            const seniorFilterBtn = document.getElementById('senior-employee-filter-btn');
            if (seniorFilterBtn) {
                seniorFilterBtn.style.backgroundColor = '#28a745';
                seniorFilterBtn.style.color = '#fff';
                seniorFilterBtn.textContent = '3개월+';
            }
            
            // UI에서 필터 표시 업데이트
            const consentFilterOptions = document.querySelectorAll('.consent-filter-option');
            consentFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            const deptFilterOptions = document.querySelectorAll('.dept-filter-option-privacy');
            deptFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            const birthdayFilterOptions = document.querySelectorAll('.birthday-filter-option');
            birthdayFilterOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === '전체') {
                    option.classList.add('selected');
                }
            });
            
            // 월별 생일자 현황 아이템들의 선택 상태 리셋
            const birthdayCountItems = document.querySelectorAll('.birthday-count-item');
            birthdayCountItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // 헤더 텍스트 업데이트
            const consentFilterIcon = document.querySelector('.consent-filter-icon');
            const deptFilterIcon = document.querySelector('.dept-filter-icon-privacy');
            const birthdayFilterIcon = document.querySelector('.birthday-filter-icon');
            
            if (consentFilterIcon) consentFilterIcon.textContent = '▼';
            if (deptFilterIcon) deptFilterIcon.textContent = '▼';
            if (birthdayFilterIcon) birthdayFilterIcon.textContent = '▼';
            
            // 생일 정렬 아이콘 초기화
            const sortIcon = document.querySelector('.birthday-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '생일 정렬';
            }
            
            console.log('필터 초기화 완료, 데이터 새로고침');
            
            // 데이터 새로고침
            loadPrivacyConsentData();
            
            // 월별 생일자 현황도 즉시 업데이트
            loadBirthdayCountByMonth();
            
            // 필터 상태 업데이트
            updateFilterStatusDisplay();
        }

        // 개인정보 동의 현황 데이터 로드
        async function loadPrivacyConsentData() {
            try {
                console.log('=== 개인정보 동의 현황 데이터 로드 시작 ===');
                console.log('현재 필터 상태:');
                console.log('  - selectedConsent:', selectedConsent);
                console.log('  - privacyConsentCurrentPage:', privacyConsentCurrentPage);
                
                // 로딩 중일 때 카운터 초기화
                const totalCountElement = document.getElementById('total-birthday-count');
                const noBirthdayCountElement = document.getElementById('no-birthday-count');
                if (totalCountElement) totalCountElement.textContent = '로딩중...';
                if (noBirthdayCountElement) noBirthdayCountElement.textContent = '로딩중...';
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                let url = `/api/main/privacy-consent?page=${privacyConsentCurrentPage}&limit=${privacyConsentItemsPerPage}`;
                
                // 동의 현황 필터가 '전체'가 아닌 경우에만 consent 파라미터 추가
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    url += `&consent=${consentValue}`;
                    console.log('동의 현황 필터 추가됨:', selectedConsent, '(값:', consentValue + ')');
                }
                
                // 부서 필터가 '전체'가 아닌 경우에만 dept 파라미터 추가
                if (selectedDeptPrivacy !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDeptPrivacy)}`;
                    console.log('부서 필터 추가됨:', selectedDeptPrivacy);
                }
                
                // 생일 월 필터가 '전체'가 아닌 경우에만 month 파라미터 추가
                if (selectedBirthdayMonth !== '전체') {
                    url += `&month=${selectedBirthdayMonth}`;
                    console.log('생일 월 필터 추가됨:', selectedBirthdayMonth);
                }
                
                // 3개월 이상 근무자 필터가 활성화된 경우 senior_employee 파라미터 추가
                if (isSeniorEmployeeFilterActive) {
                    url += '&senior_employee=true';
                    console.log('3개월 이상 근무자 필터 추가됨');
                }
                
                // 생일 정렬은 클라이언트에서 처리하므로 서버 정렬 파라미터 제거
                // (클라이언트에서 월-일만 고려하여 정렬)
                
                console.log('최종 API URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('개인정보 동의 현황 조회 실패');
                }
                
                const data = await response.json();
                privacyConsentData = data.consentList || [];
                
                console.log('API 응답 받음:');
                console.log('  - 조회된 사용자 수:', privacyConsentData.length);
                console.log('  - 전체 사용자 수:', data.total);
                console.log('  - 현재 페이지:', data.page);
                console.log('  - 전체 페이지:', data.totalPages);
                
                // 전체 데이터 기준으로 카운트 정보 저장
                window.privacyConsentTotalCount = data.total;
                window.privacyConsentNoBirthdayCount = data.noBirthdayCount || 0; // API에서 제공하는 미작성 인원수
                
                // 미작성 인원수가 API에서 제공되지 않는 경우, 전체 데이터를 조회하여 계산
                if (data.noBirthdayCount === undefined || data.noBirthdayCount === null) {
                    await calculateTotalNoBirthdayCount();
                }
                
                displayPrivacyConsentData();
                updatePrivacyConsentPagination(data.totalPages, data.page, data.total);
                
                // 생일 정렬이 설정되어 있으면 클라이언트에서 적용
                if (birthdaySortOrder) {
                    sortPrivacyConsentDataByBirthday();
                }
                
            } catch (error) {
                console.error('개인정보 동의 현황 로드 오류:', error);
                alert('개인정보 동의 현황을 불러오는데 실패했습니다.');
                
                // 실패시 빈 테이블 표시
                const tbody = document.getElementById('privacy-consent-tbody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666; padding: 20px;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 개인정보 동의현황 부서 필터 드롭다운 토글
        function toggleDeptFilterPrivacy(event) {
            event.stopPropagation();
            console.log('개인정보 동의현황 부서 필터 토글 클릭됨');
            const dropdown = document.getElementById('dept-filter-dropdown-privacy');
            
            if (!dropdown) {
                console.error('개인정보 동의현황 부서 드롭다운을 찾을 수 없습니다');
                return;
            }
            
            dropdown.classList.toggle('show');
            console.log('드롭다운 show 클래스:', dropdown.classList.contains('show'));
            
            if (dropdown.classList.contains('show')) {
                // 부서 목록이 비어있으면 다시 초기화
                if (allDeptListPrivacy.length === 0) {
                    allDeptListPrivacy = [
                        '대표이사', '부문대표', 'IES본부', 'NGE본부',
                        '솔루션사업부', 'DTE본부', 'SCM사업부', 'HRS사업부', '남부지사', 
                        'FCM사업부', 'BDS사업부', 'BAC사업부', '중국지사', '인턴', 
                        'PUBLIC CLOUD사업부', 'New Tech사업부', 'Biz AI사업부', 
                        'ITS사업부', 'Innovation Center', '경영관리실'
                    ];
                }
                
                // 드롭다운 위치 계산 및 설정
                positionDeptDropdownPrivacy(event);
                
                updateDeptDropdownPrivacy();
                setupDeptOptionListenersPrivacy();
            }
        }

        function setupDeptOptionListenersPrivacy() {
            const options = document.querySelectorAll('.dept-filter-option-privacy');
            console.log('개인정보 동의현황 부서 옵션 리스너 설정:', options.length, '개');
            options.forEach(option => {
                option.onclick = function(event) {
                    event.stopPropagation();
                    const dept = this.getAttribute('data-dept');
                    console.log('개인정보 동의현황 부서 옵션 클릭됨:', dept);
                    filterByDeptPrivacy(dept);
                };
            });
        }

        // 드롭다운 위치 계산 및 설정 함수
        function positionDeptDropdownPrivacy(event) {
            const dropdown = document.getElementById('dept-filter-dropdown-privacy');
            const header = event.currentTarget;
            
            if (!dropdown || !header) return;
            
            // 헤더의 위치 정보 가져오기
            const headerRect = header.getBoundingClientRect();
            const modal = document.getElementById('privacy-consent-modal');
            const modalRect = modal.getBoundingClientRect();
            
            // 드롭다운 위치 계산
            const left = headerRect.left;
            const top = headerRect.bottom + 5; // 헤더 아래 5px 간격
            
            // 모달 경계를 벗어나지 않도록 조정
            const maxLeft = modalRect.right - dropdown.offsetWidth;
            const adjustedLeft = Math.max(modalRect.left, Math.min(left, maxLeft));
            
            // 위치 설정
            dropdown.style.left = adjustedLeft + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.width = Math.max(120, headerRect.width) + 'px';
        }

        function updateDeptDropdownPrivacy() {
            const dropdown = document.getElementById('dept-filter-dropdown-privacy');
            console.log('개인정보 동의현황 부서 드롭다운 업데이트 시작, 부서 수:', allDeptListPrivacy.length);
            
            if (!dropdown) {
                console.error('개인정보 동의현황 부서 드롭다운 요소를 찾을 수 없음');
                return;
            }
            
            // 기존 옵션들 제거 (전체 옵션 제외)
            const existingOptions = dropdown.querySelectorAll('.dept-filter-option-privacy:not([data-dept="전체"])');
            console.log('제거할 기존 옵션 수:', existingOptions.length);
            existingOptions.forEach(option => option.remove());
            
            // 새 부서 옵션들 추가
            allDeptListPrivacy.forEach((dept, index) => {
                if (dept && dept !== '전체') {
                    console.log(`개인정보 동의현황 부서 추가 ${index + 1}:`, dept);
                    const option = document.createElement('div');
                    option.className = 'dept-filter-option-privacy';
                    option.setAttribute('data-dept', dept);
                    option.textContent = dept;
                    dropdown.appendChild(option);
                }
            });
            
            // 선택된 옵션 업데이트
            const options = dropdown.querySelectorAll('.dept-filter-option-privacy');
            console.log('업데이트된 전체 옵션 수:', options.length);
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-dept') === selectedDeptPrivacy) {
                    option.classList.add('selected');
                    console.log('선택된 부서:', selectedDeptPrivacy);
                }
            });
        }

        async function filterByDeptPrivacy(dept) {
            selectedDeptPrivacy = dept;
            console.log('=== 개인정보 동의현황 부서 필터 선택됨 ===');
            console.log('선택된 부서:', dept);
            console.log('이전 selectedDeptPrivacy:', selectedDeptPrivacy);
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('dept-filter-dropdown-privacy');
            dropdown.classList.remove('show');
            
            // 정렬된 전체 데이터 초기화 (새로운 필터 조건으로 다시 로드하기 위해)
            isFullDataSorted = false;
            allPrivacyConsentData = [];
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            privacyConsentCurrentPage = 1;
            console.log('페이지를 1로 리셋, 데이터 새로 로드 시작');
            await loadPrivacyConsentData();
            await loadBirthdayCountByMonth(); // 월별 인원수도 다시 로드
            updateFilterStatusDisplay(); // 필터 상태 업데이트
            console.log('=== 개인정보 동의현황 부서 필터 적용 완료 ===');
        }

        // 생일 월 필터 드롭다운 토글
        function toggleBirthdayFilter(event) {
            event.stopPropagation();
            console.log('생일 월 필터 토글 클릭됨');
            const dropdown = document.getElementById('birthday-filter-dropdown');
            
            if (!dropdown) {
                console.error('생일 월 드롭다운을 찾을 수 없습니다');
                return;
            }
            
            dropdown.classList.toggle('show');
            console.log('드롭다운 show 클래스:', dropdown.classList.contains('show'));
            
            if (dropdown.classList.contains('show')) {
                // 드롭다운 위치 계산 및 설정
                positionBirthdayDropdown(event);
                setupBirthdayOptionListeners();
            }
        }

        function setupBirthdayOptionListeners() {
            const options = document.querySelectorAll('.birthday-filter-option');
            console.log('생일 월 옵션 리스너 설정:', options.length, '개');
            options.forEach(option => {
                option.onclick = function(event) {
                    event.stopPropagation();
                    const month = this.getAttribute('data-month');
                    console.log('생일 월 옵션 클릭됨:', month);
                    filterByBirthdayMonth(month);
                };
            });
        }

        // 드롭다운 위치 계산 및 설정 함수 (생일 월)
        function positionBirthdayDropdown(event) {
            const dropdown = document.getElementById('birthday-filter-dropdown');
            const header = event.currentTarget;
            
            if (!dropdown || !header) return;
            
            // 헤더의 위치 정보 가져오기
            const headerRect = header.getBoundingClientRect();
            const modal = document.getElementById('privacy-consent-modal');
            const modalRect = modal.getBoundingClientRect();
            
            // 드롭다운 위치 계산
            const left = headerRect.left;
            const top = headerRect.bottom + 5; // 헤더 아래 5px 간격
            
            console.log('생일 월 드롭다운 위치 설정:', { left, top });
            
            // 드롭다운에 위치 설정
            dropdown.style.position = 'fixed';
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.zIndex = '10001';
        }

        async function filterByBirthdayMonth(month) {
            selectedBirthdayMonth = month;
            console.log('=== 생일 월 필터 선택됨 ===');
            console.log('선택된 월:', month);
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('birthday-filter-dropdown');
            dropdown.classList.remove('show');
            
            // 정렬된 전체 데이터 초기화 (새로운 필터 조건으로 다시 로드하기 위해)
            isFullDataSorted = false;
            allPrivacyConsentData = [];
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            privacyConsentCurrentPage = 1;
            console.log('페이지를 1로 리셋, 데이터 새로 로드 시작');
            await loadPrivacyConsentData();
            await loadBirthdayCountByMonth(); // 월별 인원수도 다시 로드
            updateFilterStatusDisplay(); // 필터 상태 업데이트
            console.log('=== 생일 월 필터 적용 완료 ===');
        }

        // 생일 월 선택 (UI 상태 관리 포함)
        async function selectBirthdayMonth(month) {
            console.log('월별 생일자 현황 아이템 클릭:', month);
            
            // 모든 월별 아이템에서 선택 상태 제거
            document.querySelectorAll('.birthday-count-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 클릭된 아이템에 선택 상태 추가
            const clickedItem = month === 'no-birthday' ? 
                document.getElementById('month-item-no-birthday') : 
                document.getElementById(`month-item-${month}`);
            
            if (clickedItem) {
                clickedItem.classList.add('selected');
            }
            
            // 기존 필터링 로직 실행
            if (month === 'no-birthday') {
                await filterByNoBirthday();
            } else {
                // 해당 월로 필터링 후 생일 빠른 순서로 자동 정렬
                await filterByBirthdayMonth(month);
                
                // 생일 정렬을 오름차순(빠른 날짜부터)으로 설정하고 적용
                birthdaySortOrder = 'birthday_asc';
                updateBirthdaySortIcon();
                await sortPrivacyConsentDataByBirthday();
                updateFilterStatusDisplay();
            }
        }

        // 미작성 인원만 필터링하는 함수
        async function filterByNoBirthday() {
            console.log('=== 미작성 인원 필터 적용 ===');
            
            // 필터 상태 설정
            selectedBirthdayMonth = '미작성';
            privacyConsentCurrentPage = 1;
            isFullDataSorted = false;
            allPrivacyConsentData = [];
            
            try {
                console.log('미작성 인원 데이터 로드 시작');
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                // 전체 데이터를 조회하여 미작성 인원만 필터링
                let url = `/api/main/privacy-consent?page=1&limit=10000`;
                
                // 현재 적용된 다른 필터들도 적용
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    url += `&consent=${consentValue}`;
                }
                
                if (selectedDeptPrivacy !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDeptPrivacy)}`;
                }
                
                console.log('미작성 인원 조회 URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('미작성 인원 조회 실패');
                }
                
                const data = await response.json();
                console.log('전체 데이터 조회 결과:', data);
                
                if (data.success && data.consentList) {
                    // 미작성 인원만 필터링
                    const noBirthdayData = data.consentList.filter(item => {
                        const birthday = item.birthday;
                        return !birthday || 
                               birthday === null || 
                               birthday === undefined || 
                               birthday === '' || 
                               birthday === '인사기록카드 미작성' ||
                               birthday.trim() === '';
                    });
                    
                    console.log('필터링된 미작성 인원수:', noBirthdayData.length);
                    
                    // 현재 페이지 데이터 설정
                    const startIndex = (privacyConsentCurrentPage - 1) * privacyConsentItemsPerPage;
                    const endIndex = startIndex + privacyConsentItemsPerPage;
                    privacyConsentData = noBirthdayData.slice(startIndex, endIndex);
                    
                    // 전체 미작성 데이터 저장 (페이지네이션용)
                    allPrivacyConsentData = noBirthdayData;
                    
                    // 테이블 업데이트
                    displayPrivacyConsentData();
                    
                    // 페이지네이션 업데이트 (미작성 데이터 기준)
                    const totalPages = Math.ceil(noBirthdayData.length / privacyConsentItemsPerPage);
                    updatePrivacyConsentPagination(totalPages, privacyConsentCurrentPage, noBirthdayData.length);
                    
                    // 필터 상태 업데이트
                    updateFilterStatusDisplay();
                }
                
            } catch (error) {
                console.error('미작성 인원 필터 오류:', error);
                alert('미작성 인원을 불러오는데 실패했습니다: ' + error.message);
            }
            
            console.log('=== 미작성 인원 필터 적용 완료 ===');
        }

        // 생일 정렬 토글 함수 (클라이언트에서 월-일만 고려하여 정렬)
        function toggleBirthdaySort() {
            if (birthdaySortOrder === null) {
                birthdaySortOrder = 'birthday_asc';
            } else if (birthdaySortOrder === 'birthday_asc') {
                birthdaySortOrder = 'birthday_desc';
            } else {
                birthdaySortOrder = null;
            }
            
            console.log('생일 정렬 변경됨 (월-일만 고려):', birthdaySortOrder);
            updateBirthdaySortIcon();
            
            // 클라이언트에서 직접 정렬 적용
            sortPrivacyConsentDataByBirthday();
            
            // 필터 상태 업데이트
            updateFilterStatusDisplay();
        }

        // 생일 정렬 아이콘 업데이트
        function updateBirthdaySortIcon() {
            const icon = document.getElementById('birthday-sort-icon');
            if (birthdaySortOrder === 'birthday_asc') {
                icon.textContent = '↑';
                icon.title = '생일 오름차순 (빠른 날짜부터)';
            } else if (birthdaySortOrder === 'birthday_desc') {
                icon.textContent = '↓';
                icon.title = '생일 내림차순 (늦은 날짜부터)';
            } else {
                icon.textContent = '⇅';
                icon.title = '생일 정렬';
            }
        }

        // 전체 데이터 기반 생일 정렬 및 페이지네이션
        async function sortPrivacyConsentDataByBirthday() {
            if (!birthdaySortOrder) {
                // 정렬 해제시 원래 순서로 복원
                isFullDataSorted = false;
                allPrivacyConsentData = [];
                loadPrivacyConsentData();
                return;
            }
            
            console.log('전체 데이터 기반 생일 정렬 수행:', birthdaySortOrder);
            
            // 전체 데이터가 없다면 먼저 로드
            if (allPrivacyConsentData.length === 0) {
                await loadAllPrivacyConsentDataForSort();
            }
            
            // 전체 데이터 정렬
            allPrivacyConsentData.sort((a, b) => {
                // 생일 정보 추출 및 월-일 형식으로 변환
                let birthdayA = extractMonthDay(a.birthday);
                let birthdayB = extractMonthDay(b.birthday);
                
                // 생일 정보가 없는 경우 맨 뒤로 정렬
                if (!birthdayA && !birthdayB) return 0;
                if (!birthdayA) return 1;
                if (!birthdayB) return -1;
                
                // 월-일 비교
                const compareResult = birthdayA.localeCompare(birthdayB);
                
                return birthdaySortOrder === 'birthday_asc' ? compareResult : -compareResult;
            });
            
            isFullDataSorted = true;
            console.log('전체 데이터 정렬 완료, 현재 페이지로 분할');
            
            // 정렬된 전체 데이터에서 현재 페이지 데이터 추출
            updateCurrentPageFromSortedData();
        }

        // 정렬을 위한 전체 데이터 로드
        async function loadAllPrivacyConsentDataForSort() {
            try {
                console.log('정렬을 위한 전체 데이터 로드 시작');
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                // 전체 데이터를 조회하기 위해 매우 큰 limit 사용
                let url = `/api/main/privacy-consent?page=1&limit=10000`;
                
                // 현재 적용된 필터 조건들을 동일하게 적용
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    url += `&consent=${consentValue}`;
                }
                
                if (selectedDeptPrivacy !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDeptPrivacy)}`;
                }
                
                if (selectedBirthdayMonth !== '전체') {
                    url += `&month=${selectedBirthdayMonth}`;
                }
                
                // 3개월 이상 근무자 필터가 활성화된 경우 senior_employee 파라미터 추가
                if (isSeniorEmployeeFilterActive) {
                    url += '&senior_employee=true';
                }
                
                console.log('전체 데이터 로드 URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('전체 데이터 조회 실패');
                }
                
                const data = await response.json();
                console.log('정렬용 전체 데이터 로드 완료:', data.consentList?.length, '건');
                
                allPrivacyConsentData = data.consentList || [];
                
            } catch (error) {
                console.error('전체 데이터 로드 오류:', error);
                // 실패시 현재 페이지 데이터만 정렬
                allPrivacyConsentData = [...privacyConsentData];
            }
        }

        // 정렬된 전체 데이터에서 현재 페이지 데이터 추출
        function updateCurrentPageFromSortedData() {
            const startIndex = (privacyConsentCurrentPage - 1) * privacyConsentItemsPerPage;
            const endIndex = startIndex + privacyConsentItemsPerPage;
            
            privacyConsentData = allPrivacyConsentData.slice(startIndex, endIndex);
            
            console.log(`페이지 ${privacyConsentCurrentPage}: ${startIndex + 1}-${Math.min(endIndex, allPrivacyConsentData.length)} (총 ${allPrivacyConsentData.length}건)`);
            
            // 테이블 업데이트
            displayPrivacyConsentData();
            
            // 페이지네이션 업데이트 (전체 데이터 기준)
            const totalPages = Math.ceil(allPrivacyConsentData.length / privacyConsentItemsPerPage);
            updatePrivacyConsentPagination(totalPages, privacyConsentCurrentPage, allPrivacyConsentData.length);
        }

        // 정렬 상태를 고려한 페이지 변경 함수
        function goToPrivacyConsentPage(page) {
            privacyConsentCurrentPage = page;
            
            if (searchNameTerm) {
                // 이름 검색이 적용된 상태에서는 클라이언트에서 페이지 분할
                console.log('이름 검색 상태에서 페이지 변경:', page);
                const startIndex = (page - 1) * privacyConsentItemsPerPage;
                const endIndex = startIndex + privacyConsentItemsPerPage;
                privacyConsentData = allPrivacyConsentData.slice(startIndex, endIndex);
                displayPrivacyConsentData();
                
                // 페이지네이션 업데이트
                const totalPages = Math.ceil(allPrivacyConsentData.length / privacyConsentItemsPerPage);
                updatePrivacyConsentPagination(totalPages, page, allPrivacyConsentData.length);
            } else if (selectedBirthdayMonth === '미작성') {
                // 미작성 필터가 적용된 상태에서는 클라이언트에서 페이지 분할
                console.log('미작성 필터 상태에서 페이지 변경:', page);
                const startIndex = (page - 1) * privacyConsentItemsPerPage;
                const endIndex = startIndex + privacyConsentItemsPerPage;
                privacyConsentData = allPrivacyConsentData.slice(startIndex, endIndex);
                displayPrivacyConsentData();
                
                // 페이지네이션 업데이트
                const totalPages = Math.ceil(allPrivacyConsentData.length / privacyConsentItemsPerPage);
                updatePrivacyConsentPagination(totalPages, page, allPrivacyConsentData.length);
            } else if (isFullDataSorted && birthdaySortOrder) {
                // 정렬된 상태에서는 클라이언트에서 페이지 분할
                console.log('정렬된 데이터에서 페이지 변경:', page);
                updateCurrentPageFromSortedData();
            } else {
                // 일반 상태에서는 서버에서 페이지 데이터 로드
                console.log('서버에서 페이지 데이터 로드:', page);
                loadPrivacyConsentData();
            }
        }

        // 이름 검색 함수
        async function searchByName() {
            const nameInput = document.getElementById('name-search-input');
            const searchTerm = nameInput ? nameInput.value.trim() : '';
            
            // 검색어가 변경되었는지 확인
            if (searchNameTerm === searchTerm) {
                return; // 동일한 검색어면 처리하지 않음
            }
            
            searchNameTerm = searchTerm;
            console.log('이름 검색 실행:', searchNameTerm);
            
            // 페이지를 1로 리셋
            privacyConsentCurrentPage = 1;
            
            // 검색어가 있으면 전체 데이터를 가져와서 필터링
            if (searchNameTerm) {
                await loadAndFilterByName();
            } else {
                // 검색어가 없으면 일반 데이터 로드
                await loadPrivacyConsentData();
            }
            
            // 필터 상태 업데이트
            updateFilterStatusDisplay();
        }
        
        // 이름으로 필터링하여 데이터 로드
        async function loadAndFilterByName() {
            try {
                console.log('=== 이름 검색을 위한 전체 데이터 로드 시작 ===');
                
                // 전체 데이터 가져오기 (기존 fetchAllPrivacyConsentData 함수 활용)
                const allData = await fetchAllPrivacyConsentData();
                
                if (!allData || allData.length === 0) {
                    console.log('검색할 데이터가 없습니다.');
                    privacyConsentData = [];
                    displayPrivacyConsentData();
                    return;
                }
                
                // 이름으로 필터링
                const filteredData = allData.filter(item => {
                    return item.name && item.name.toLowerCase().includes(searchNameTerm.toLowerCase());
                });
                
                console.log(`이름 검색 결과: ${allData.length}명 중 ${filteredData.length}명`);
                
                // 전체 필터링된 데이터 저장
                allPrivacyConsentData = filteredData;
                
                // 현재 페이지에 맞게 데이터 분할
                const startIndex = (privacyConsentCurrentPage - 1) * privacyConsentItemsPerPage;
                const endIndex = startIndex + privacyConsentItemsPerPage;
                privacyConsentData = filteredData.slice(startIndex, endIndex);
                
                // 테이블 업데이트
                displayPrivacyConsentData();
                
                // 페이지네이션 업데이트
                const totalPages = Math.ceil(filteredData.length / privacyConsentItemsPerPage);
                updatePrivacyConsentPagination(totalPages, privacyConsentCurrentPage, filteredData.length);
                
            } catch (error) {
                console.error('이름 검색 중 오류:', error);
                alert('이름 검색 중 오류가 발생했습니다.');
            }
        }

        // 현재 적용된 필터 상태를 업데이트하는 함수
        function updateFilterStatusDisplay() {
            const filterStatusElement = document.getElementById('filter-status-display');
            if (!filterStatusElement) return;
            
            const filters = [];
            
            // 이름 검색 필터
            if (searchNameTerm) {
                filters.push(`이름: "${searchNameTerm}"`);
            }
            
            // 동의 현황 필터
            if (selectedConsent !== '전체') {
                filters.push(`개인정보동의: ${selectedConsent}`);
            }
            
            // 부서 필터
            if (selectedDeptPrivacy !== '전체') {
                filters.push(`부서: ${selectedDeptPrivacy}`);
            }
            
            // 생일 월 필터
            if (selectedBirthdayMonth !== '전체') {
                if (selectedBirthdayMonth === '미작성') {
                    filters.push(`생일: 미작성 인원만`);
                } else {
                    filters.push(`생일월: ${selectedBirthdayMonth}월`);
                }
            }
            
            // 3개월 이상 근무자 필터
            if (isSeniorEmployeeFilterActive) {
                filters.push('입사 3개월 이상만');
            }
            
            // 정렬 상태
            if (birthdaySortOrder) {
                const sortText = birthdaySortOrder === 'birthday_asc' ? '생일 오름차순' : '생일 내림차순';
                filters.push(`정렬: ${sortText}`);
            }
            
            // 필터 상태 표시
            if (filters.length === 0) {
                filterStatusElement.textContent = '필터 없음 (전체 데이터)';
                filterStatusElement.style.color = '#888';
            } else {
                filterStatusElement.textContent = `적용된 필터: ${filters.join(', ')}`;
                filterStatusElement.style.color = '#007bff';
            }
        }

        // 3개월 이상 근무자 필터 토글 함수
        async function toggleSeniorEmployeeFilter() {
            console.log('3개월 이상 근무자 필터 토글 클릭');
            
            // 필터 상태 토글
            isSeniorEmployeeFilterActive = !isSeniorEmployeeFilterActive;
            
            // 버튼 스타일 업데이트
            const filterBtn = document.getElementById('senior-employee-filter-btn');
            if (filterBtn) {
                if (isSeniorEmployeeFilterActive) {
                    filterBtn.style.backgroundColor = '#dc3545'; // 빨간색 (활성화)
                    filterBtn.style.color = '#fff';
                    filterBtn.textContent = '3개월+ ✓';
                } else {
                    filterBtn.style.backgroundColor = '#28a745'; // 초록색 (비활성화)
                    filterBtn.style.color = '#fff';
                    filterBtn.textContent = '3개월+';
                }
            }
            
            console.log('3개월 이상 근무자 필터 상태:', isSeniorEmployeeFilterActive);
            
            // 페이지를 1로 리셋
            privacyConsentCurrentPage = 1;
            allPrivacyConsentData = [];
            
            // 데이터 새로고침
            await loadPrivacyConsentData();
            
            // 월별 생일자 현황도 업데이트
            await loadBirthdayCountByMonth();
            
            // 필터 상태 업데이트
            updateFilterStatusDisplay();
        }

        // 생일에서 월-일만 추출하는 함수
        function extractMonthDay(birthday) {
            if (!birthday || birthday === '인사기록카드 미작성' || birthday === '') {
                return null;
            }
            
            try {
                // YYYY-MM-DD 또는 MM-DD 형식 처리
                const birthdayParts = birthday.split('-');
                if (birthdayParts.length >= 2) {
                    const month = birthdayParts[birthdayParts.length - 2];
                    const day = birthdayParts[birthdayParts.length - 1];
                    return `${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                return birthday;
            } catch (error) {
                console.error('생일 파싱 오류:', error, birthday);
                return birthday;
            }
        }

        // 전체 미작성 인원수 계산 (전체 데이터 조회)
        async function calculateTotalNoBirthdayCount() {
            try {
                console.log('전체 미작성 인원수 계산 시작');
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                // 전체 데이터를 조회하기 위해 매우 큰 limit 사용
                let url = `/api/main/privacy-consent?page=1&limit=10000`;
                
                // 현재 적용된 필터 조건들을 동일하게 적용
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    url += `&consent=${consentValue}`;
                }
                
                if (selectedDeptPrivacy !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDeptPrivacy)}`;
                }
                
                if (selectedBirthdayMonth !== '전체') {
                    url += `&month=${selectedBirthdayMonth}`;
                }
                
                // 3개월 이상 근무자 필터가 활성화된 경우 senior_employee 파라미터 추가
                if (isSeniorEmployeeFilterActive) {
                    url += '&senior_employee=true';
                }
                
                console.log('전체 데이터 조회 URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('전체 데이터 조회 실패');
                }
                
                const data = await response.json();
                console.log('전체 데이터 조회 결과:', data);
                
                if (data.success && data.consentList) {
                    // 전체 데이터에서 미작성 인원수 직접 계산
                    const allData = data.consentList;
                    const noBirthdayCount = allData.filter(item => 
                        !item.birthday || item.birthday === '인사기록카드 미작성' || item.birthday === ''
                    ).length;
                    
                    window.privacyConsentNoBirthdayCount = noBirthdayCount;
                    console.log('계산된 전체 미작성 인원수:', noBirthdayCount);
                }
                
            } catch (error) {
                console.error('전체 미작성 인원수 계산 오류:', error);
                console.log('미작성 인원수를 현재 페이지 데이터로 추정합니다.');
                
                // 오류시 현재 페이지 기준으로 추정
                const currentPageNoBirthday = privacyConsentData.filter(item => 
                    !item.birthday || item.birthday === '인사기록카드 미작성' || item.birthday === ''
                ).length;
                const currentPageTotal = privacyConsentData.length;
                const totalCount = window.privacyConsentTotalCount || 0;
                
                window.privacyConsentNoBirthdayCount = currentPageTotal > 0 ? 
                    Math.round((currentPageNoBirthday / currentPageTotal) * totalCount) : 0;
            }
        }

        // 월별 생일자 인원수 로드
        async function loadBirthdayCountByMonth() {
            try {
                console.log('월별 생일자 인원수 로드 시작');
                
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                let url = '/api/main/birthday-count-by-month';
                const params = new URLSearchParams();
                
                // 현재 적용된 필터들과 동일하게 적용
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    params.append('consent', consentValue);
                }
                
                if (selectedDeptPrivacy !== '전체') {
                    params.append('dept', selectedDeptPrivacy);
                }
                
                // 3개월 이상 근무자 필터가 활성화된 경우 senior_employee 파라미터 추가
                if (isSeniorEmployeeFilterActive) {
                    params.append('senior_employee', 'true');
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('월별 인원수 API URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('월별 생일자 인원수 조회 실패');
                }
                
                const data = await response.json();
                monthlyBirthdayCounts = data.monthCounts || {};
                
                console.log('월별 생일자 인원수 결과:', monthlyBirthdayCounts);
                displayBirthdayCountByMonth();
                
            } catch (error) {
                console.error('월별 생일자 인원수 로드 오류:', error);
            }
        }

        // 월별 생일자 인원수 표시
        function displayBirthdayCountByMonth() {
            const grid = document.getElementById('birthday-count-grid');
            grid.innerHTML = '';
            
            const months = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            
            // 1월부터 12월까지 표시
            months.forEach((monthName, index) => {
                const monthNum = index + 1;
                const count = monthlyBirthdayCounts[monthNum] || 0;
                
                const monthItem = document.createElement('div');
                monthItem.className = 'birthday-count-item';
                monthItem.id = `month-item-${monthNum}`;
                monthItem.innerHTML = `
                    <div class="month-name">${monthName}</div>
                    <div class="month-count">${count}명</div>
                `;
                
                // 현재 선택된 월인지 확인하여 선택 상태 적용
                if (selectedBirthdayMonth === monthNum.toString()) {
                    monthItem.classList.add('selected');
                }
                
                // 클릭시 해당 월로 필터링
                monthItem.onclick = () => selectBirthdayMonth(monthNum.toString());
                
                grid.appendChild(monthItem);
            });
            
            // 12월 뒤에 "미작성" 항목 추가
            const noBirthdayItem = document.createElement('div');
            noBirthdayItem.className = 'birthday-count-item no-birthday-item';
            noBirthdayItem.id = 'month-item-no-birthday';
            noBirthdayItem.innerHTML = `
                <div class="month-name">미작성</div>
                <div class="month-count">${globalNoBirthdayCount || 0}명</div>
            `;
            
            // 현재 "미작성"이 선택된 상태인지 확인
            if (selectedBirthdayMonth === 'no-birthday') {
                noBirthdayItem.classList.add('selected');
            }
            
            console.log('미작성 아이템 생성 시 globalNoBirthdayCount:', globalNoBirthdayCount);
            
            // 클릭시 미작성 인원 필터링
            noBirthdayItem.onclick = () => selectBirthdayMonth('no-birthday');
            
            grid.appendChild(noBirthdayItem);
        }

        // 생일자 개인정보 동의 현황 데이터 표시
        function displayPrivacyConsentData() {
            const tbody = document.getElementById('privacy-consent-tbody');
            tbody.innerHTML = '';
            
            // 전체 데이터 기준 고정값 사용 (필터에 영향받지 않음)
            updateGlobalCountDisplay();
            
            // 필터 상태 업데이트
            updateFilterStatusDisplay();
            
            if (privacyConsentData.length === 0) {
                const message = selectedDeptPrivacy !== '전체' ? 
                    `선택한 부서(${selectedDeptPrivacy})에 동의 현황이 없습니다.` : 
                    '동의 현황이 없습니다.';
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">${message}</td></tr>`;
                
                // 데이터가 없어도 전체 데이터 기준 고정값 유지
                updateGlobalCountDisplay();
                return;
            }
            
            privacyConsentData.forEach((item, index) => {
                const row = document.createElement('tr');
                const consentStatus = item.is_agreed == 1 ? '동의함' : '미동의';
                const consentClass = item.is_agreed == 1 ? 'consent-agreed' : 'consent-disagreed';
                
                // 생일 데이터에서 년도 제거하고 월-일만 표시
                let birthdayDisplay = '인사기록카드 미작성';
                if (item.birthday && item.birthday !== '인사기록카드 미작성') {
                    try {
                        // YYYY-MM-DD 또는 MM-DD 형식 처리
                        const birthdayParts = item.birthday.split('-');
                        if (birthdayParts.length >= 2) {
                            const month = birthdayParts[birthdayParts.length - 2];
                            const day = birthdayParts[birthdayParts.length - 1];
                            birthdayDisplay = `${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        } else {
                            birthdayDisplay = item.birthday;
                        }
                    } catch (error) {
                        birthdayDisplay = item.birthday;
                    }
                }
                
                // 생일메시지 처리 (연도별 필터링)
                let birthdayMessageStatus = '-';
                if (item.birthday_queue_name === 'birthday' && item.birthday_send_time) {
                    const sendDate = new Date(item.birthday_send_time);
                    const messageYear = sendDate.getFullYear();
                    
                    // 현재 선택된 연도와 메시지 전송 연도가 일치하는 경우에만 표시
                    if (messageYear === selectedYear) {
                        // is_read가 true이면 "수신(읽음)", 아니면 "발신(날짜)"
                        if (item.birthday_is_read === true || item.birthday_is_read === 1) {
                            birthdayMessageStatus = '수신(읽음)';
                        } else {
                            const formattedDate = sendDate.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            }).replace(/\./g, '-').replace(/\s/g, '').slice(0, -1); // 마지막 - 제거
                            birthdayMessageStatus = `발신(${formattedDate})`;
                        }
                    }
                    // 다른 연도의 메시지는 '-'로 표시 (기본값 유지)
                }
                
                // 쿠폰 정보 처리 - gift_message 데이터를 구성
                let couponInfo;
                if (birthdayMessageStatus === '-') {
                    // 생일메시지가 '-'이면 쿠폰도 '-'로 표시
                    couponInfo = {
                        status: '-',
                        expiry: '-',
                        usage: '-'
                    };
                } else {
                    const birthdayMessageData = {
                        queue_name: item.gift_queue_name,
                        send_time: item.gift_send_time
                    };
                    couponInfo = parseCouponInfo(item.coupons, birthdayMessageData, selectedYear);
                }
                
                // 쿠폰 상태가 "발송(날짜)" 형태이면 생일메시지를 "수신(읽음)"으로 변경
                if (couponInfo.status.startsWith('발송(')) {
                    birthdayMessageStatus = '수신(읽음)';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-weight: bold;">${item.name || '-'}</td>
                    <td>${item.dept || '-'}</td>
                    <td>${birthdayDisplay}</td>
                    <td class="${consentClass}">${consentStatus}</td>
                    <td class="birthday-message-status">${birthdayMessageStatus}</td>
                    <td class="coupon-status">${couponInfo.status}</td>
                    <td class="coupon-expiry">${couponInfo.expiry}</td>
                    <td class="coupon-usage" data-status="${couponInfo.usage}">${couponInfo.usage}</td>
                `;
                
                // 행 클릭 이벤트 추가 (토스 스타일 상세보기)
                row.style.cursor = 'pointer';
                row.onclick = () => openPrivacyDetailModal(item);
                
                tbody.appendChild(row);
            });
        }

        // 개인정보 동의 현황 페이지네이션 업데이트
        function updatePrivacyConsentPagination(totalPages, currentPage, totalCount) {
            const pagination = document.getElementById('privacy-consent-pagination');
            pagination.innerHTML = '';
            
            // 데이터 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.className = 'pagination-info';
            infoDiv.innerHTML = `
                <span style="font-size: 12px; color: #666; margin-right: 15px;">
                    전체 ${totalCount || 0}명 • ${totalPages || 1}페이지 중 ${currentPage || 1}페이지
                </span>
            `;
            pagination.appendChild(infoDiv);
            
            if (totalPages <= 1) return;
            
            // 페이지 버튼 컨테이너
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'pagination-buttons';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '5px';
            buttonsDiv.style.marginTop = '8px';
            
            // 처음 버튼
            if (currentPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '처음';
                firstBtn.style.fontWeight = 'bold';
                firstBtn.onclick = () => {
                    goToPrivacyConsentPage(1);
                };
                buttonsDiv.appendChild(firstBtn);
            }
            
            // 이전 버튼
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '이전';
                prevBtn.onclick = () => {
                    goToPrivacyConsentPage(currentPage - 1);
                };
                buttonsDiv.appendChild(prevBtn);
            }
            
            // 페이지 번호
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    goToPrivacyConsentPage(i);
                };
                buttonsDiv.appendChild(pageBtn);
            }
            
            // 다음 버튼
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '다음';
                nextBtn.onclick = () => {
                    goToPrivacyConsentPage(currentPage + 1);
                };
                buttonsDiv.appendChild(nextBtn);
            }
            
            // 마지막 버튼
            if (currentPage < totalPages) {
                const lastBtn = document.createElement('button');
                lastBtn.textContent = '마지막';
                lastBtn.style.fontWeight = 'bold';
                lastBtn.onclick = () => {
                    goToPrivacyConsentPage(totalPages);
                };
                buttonsDiv.appendChild(lastBtn);
            }
            
            pagination.appendChild(buttonsDiv);
        }

        // 동의 현황 필터 드롭다운 토글
        function toggleConsentFilter(event) {
            event.stopPropagation();
            console.log('동의 현황 필터 토글 클릭됨');
            const dropdown = document.getElementById('consent-filter-dropdown');
            
            if (!dropdown) {
                console.error('동의 현황 드롭다운을 찾을 수 없습니다');
                return;
            }
            
            dropdown.classList.toggle('show');
            console.log('드롭다운 show 클래스:', dropdown.classList.contains('show'));
            
            if (dropdown.classList.contains('show')) {
                updateConsentDropdown();
                setupConsentOptionListeners();
            }
        }

        function setupConsentOptionListeners() {
            const options = document.querySelectorAll('.consent-filter-option');
            console.log('동의 현황 옵션 리스너 설정:', options.length, '개');
            options.forEach(option => {
                option.onclick = function(event) {
                    event.stopPropagation();
                    const consent = this.getAttribute('data-consent');
                    console.log('동의 현황 옵션 클릭됨:', consent);
                    filterByConsent(consent);
                };
            });
        }

        function updateConsentDropdown() {
            const dropdown = document.getElementById('consent-filter-dropdown');
            const options = dropdown.querySelectorAll('.consent-filter-option');
            
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-consent') === selectedConsent) {
                    option.classList.add('selected');
                }
            });
        }

        async function filterByConsent(consent) {
            selectedConsent = consent;
            console.log('=== 동의 현황 필터 선택됨 ===');
            console.log('선택된 동의 현황:', consent);
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('consent-filter-dropdown');
            dropdown.classList.remove('show');
            
            // 정렬된 전체 데이터 초기화 (새로운 필터 조건으로 다시 로드하기 위해)
            isFullDataSorted = false;
            allPrivacyConsentData = [];
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            privacyConsentCurrentPage = 1;
            console.log('페이지를 1로 리셋, 데이터 새로 로드 시작');
            await loadPrivacyConsentData();
            
            // 월별 생일자 현황도 즉시 업데이트
            await loadBirthdayCountByMonth();
            
            updateFilterStatusDisplay(); // 필터 상태 업데이트
            console.log('=== 동의 현황 필터 적용 완료 ===');
        }

        // 개인정보 동의 현황 요약 정보 로드 (대시보드 카드용)
        async function loadPrivacyConsentSummary() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                const response = await fetch('/api/main/privacy-consent/summary', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const summaryText = `동의: ${data.agreed_count || 0}명, 미동의: ${data.not_agreed_count || 0}명`;
                    document.getElementById('privacy-consent-summary').textContent = summaryText;
                } else {
                    document.getElementById('privacy-consent-summary').textContent = '로드 실패';
                }
            } catch (error) {
                console.error('개인정보 동의 현황 요약 정보 로드 오류:', error);
                document.getElementById('privacy-consent-summary').textContent = '로드 실패';
            }
        }

        // 추석 선물 모니터링 현황 요약 정보 로드 (대시보드 카드용)
        async function loadChuseokGiftSummary() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                const response = await fetch('/api/main/chuseok-gift/summary', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const data = result.data || result;
                    const summaryText = `수령: ${data.received_count || 0}명, 미수령: ${data.not_received_count || 0}명`;
                    document.getElementById('chuseok-gift-summary').textContent = summaryText;
                } else {
                    document.getElementById('chuseok-gift-summary').textContent = '로드 실패';
                }
            } catch (error) {
                console.error('추석 선물 모니터링 현황 요약 정보 로드 오류:', error);
                document.getElementById('chuseok-gift-summary').textContent = '로드 실패';
            }
        }

        // 페이지 로드시 앱 버전 요약 정보 로드
        setTimeout(() => {
            loadAppVersionSummary();
            loadPrivacyConsentSummary();
            loadChuseokGiftSummary();
        }, 2000);

        // 부서 필터 드롭다운 토글
        function toggleDeptFilterAppVersion(event) {
            event.stopPropagation();
            console.log('부서 필터 토글 클릭됨');
            const dropdown = document.getElementById('dept-filter-dropdown-appversion');
            
            if (!dropdown) {
                console.error('부서 드롭다운을 찾을 수 없습니다');
                return;
            }
            
            dropdown.classList.toggle('show');
            console.log('드롭다운 show 클래스:', dropdown.classList.contains('show'));
            
            if (dropdown.classList.contains('show')) {
                // 부서 목록이 비어있으면 다시 초기화
                if (allDeptListAppVersion.length === 0) {
                    allDeptListAppVersion = [
                        '솔루션사업부', 'DTE본부', 'SCM사업부', 'HRS사업부', '남부지사', 
                        'FCM사업부', 'BDS사업부', 'BAC사업부', '중국지사', '인턴', 
                        'PUBLIC CLOUD사업부', 'New Tech사업부', 'Biz AI사업부', 
                        'ITS사업부', 'Innovation Center', '경영관리실'
                    ];
                }
                updateDeptDropdownAppVersion();
                setupDeptOptionListenersAppVersion();
            }
        }

        function setupDeptOptionListenersAppVersion() {
            const options = document.querySelectorAll('.dept-filter-option-appversion');
            console.log('부서 옵션 리스너 설정:', options.length, '개');
            options.forEach(option => {
                option.onclick = function(event) {
                    event.stopPropagation();
                    const dept = this.getAttribute('data-dept');
                    console.log('부서 옵션 클릭됨:', dept);
                    filterByDeptAppVersion(dept);
                };
            });
        }

        function updateDeptDropdownAppVersion() {
            const dropdown = document.getElementById('dept-filter-dropdown-appversion');
            console.log('부서 드롭다운 업데이트 시작, 부서 수:', allDeptListAppVersion.length);
            
            if (!dropdown) {
                console.error('부서 드롭다운 요소를 찾을 수 없음');
                return;
            }
            
            // 기존 옵션들 제거 (전체 옵션과 중국지사 제외 옵션 제외)
            const existingOptions = dropdown.querySelectorAll('.dept-filter-option-appversion:not([data-dept="전체"]):not([data-dept="중국지사 제외"])');
            console.log('제거할 기존 옵션 수:', existingOptions.length);
            existingOptions.forEach(option => option.remove());
            
            // 새 부서 옵션들 추가
            allDeptListAppVersion.forEach((dept, index) => {
                if (dept && dept !== '전체' && dept !== '중국지사 제외') {
                    console.log(`부서 추가 ${index + 1}:`, dept);
                    const option = document.createElement('div');
                    option.className = 'dept-filter-option-appversion';
                    option.setAttribute('data-dept', dept);
                    option.textContent = dept;
                    dropdown.appendChild(option);
                }
            });
            
            // 선택된 옵션 업데이트
            const options = dropdown.querySelectorAll('.dept-filter-option-appversion');
            console.log('업데이트된 전체 옵션 수:', options.length);
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-dept') === selectedDeptAppVersion) {
                    option.classList.add('selected');
                    console.log('선택된 부서:', selectedDeptAppVersion);
                }
            });
        }

        async function filterByDeptAppVersion(dept) {
            selectedDeptAppVersion = dept;
            console.log('=== 부서 필터 선택됨 ===');
            console.log('선택된 부서:', dept);
            console.log('이전 selectedDeptAppVersion:', selectedDeptAppVersion);
            
            // 필터 변경 시 정렬 상태 초기화
            isAppVersionSorted = false;
            const sortIcon = document.getElementById('dept-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '부서명 정렬';
            }
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('dept-filter-dropdown-appversion');
            dropdown.classList.remove('show');
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            appVersionCurrentPage = 1;
            console.log('페이지를 1로 리셋, 데이터 새로 로드 시작');
            await loadAppVersionData();
            console.log('=== 부서 필터 적용 완료 ===');
        }
        
        // 개인정보 동의 현황 필터 드롭다운 토글 (앱 버전용)
        function toggleConsentFilterAppVersion(event) {
            console.log('=== toggleConsentFilterAppVersion 함수 시작 ===');
            event.stopPropagation();
            console.log('앱 버전 동의 현황 필터 토글 클릭됨');
            const dropdown = document.getElementById('consent-filter-dropdown-appversion');
            
            if (!dropdown) {
                console.error('앱 버전 동의 현황 드롭다운을 찾을 수 없습니다');
                return;
            }
            
            console.log('드롭다운 요소 찾음:', dropdown);
            dropdown.classList.toggle('show');
            console.log('드롭다운 show 클래스:', dropdown.classList.contains('show'));
            
            if (dropdown.classList.contains('show')) {
                console.log('드롭다운 열림 - 함수들 실행');
                updateConsentDropdownAppVersion();
                setupConsentOptionListenersAppVersion();
            } else {
                console.log('드롭다운 닫힘');
            }
            console.log('=== toggleConsentFilterAppVersion 함수 종료 ===');
        }
        
        function setupConsentOptionListenersAppVersion() {
            console.log('=== setupConsentOptionListenersAppVersion 함수 시작 ===');
            const options = document.querySelectorAll('.consent-filter-option-appversion');
            console.log('앱 버전 동의 현황 옵션 리스너 설정:', options.length, '개');
            
            if (options.length === 0) {
                console.error('동의 현황 옵션을 찾을 수 없습니다!');
                return;
            }
            
            options.forEach((option, index) => {
                console.log(`옵션 ${index + 1}:`, option.textContent, 'data-consent:', option.getAttribute('data-consent'));
                option.onclick = function(event) {
                    console.log('=== 동의 현황 옵션 클릭 이벤트 시작 ===');
                    event.stopPropagation();
                    const consent = this.getAttribute('data-consent');
                    console.log('앱 버전 동의 현황 옵션 클릭됨:', consent);
                    console.log('filterByConsentAppVersion 함수 호출 예정');
                    filterByConsentAppVersion(consent);
                };
            });
            console.log('=== setupConsentOptionListenersAppVersion 함수 종료 ===');
        }
        
        function updateConsentDropdownAppVersion() {
            const dropdown = document.getElementById('consent-filter-dropdown-appversion');
            const options = dropdown.querySelectorAll('.consent-filter-option-appversion');
            
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-consent') === selectedConsentAppVersion) {
                    option.classList.add('selected');
                }
            });
        }
        
        async function filterByConsentAppVersion(consent) {
            console.log('=== filterByConsentAppVersion 함수 시작 ===');
            console.log('받은 consent 값:', consent);
            
            selectedConsentAppVersion = consent;
            console.log('selectedConsentAppVersion 설정됨:', selectedConsentAppVersion);
            console.log('=== 앱 버전 동의 현황 필터 선택됨 ===');
            console.log('선택된 동의 현황:', consent);
            
            // 필터 변경 시 정렬 상태 초기화
            isAppVersionSorted = false;
            const sortIcon = document.getElementById('dept-sort-icon');
            if (sortIcon) {
                sortIcon.textContent = '⇅';
                sortIcon.title = '부서명 정렬';
            }
            
            // 드롭다운 닫기
            const dropdown = document.getElementById('consent-filter-dropdown-appversion');
            if (dropdown) {
                dropdown.classList.remove('show');
                console.log('드롭다운 닫기 완료');
            } else {
                console.error('드롭다운을 찾을 수 없어서 닫기 실패');
            }
            
            // 페이지를 1로 리셋하고 데이터 새로 로드
            appVersionCurrentPage = 1;
            console.log('페이지를 1로 리셋, 현재 페이지:', appVersionCurrentPage);
            console.log('loadAppVersionData 함수 호출 시작');
            try {
                await loadAppVersionData();
                console.log('loadAppVersionData 함수 완료');
            } catch (error) {
                console.error('loadAppVersionData 함수 오류:', error);
            }
            console.log('=== filterByConsentAppVersion 함수 종료 ===');
        }

        // v1.3.1 사용자 주간 비교 정보 로드
        async function loadV131WeeklyComparison() {
            try {
                console.log('=== v1.3.1 주간 비교 정보 로드 시작 ===');

                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                // 새로운 API 엔드포인트 호출
                const url = '/api/main/app-version/weekly-comparison-v131';

                const headers = {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'x-admin-role': adminRole,
                    'x-user-id': userId
                };

                const response = await fetch(url, { headers });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('v1.3.1 주간 비교 API 응답:', result);

                if (result.success && result.data) {
                    displayV131WeeklyComparison(result.data);
                } else {
                    throw new Error('API 응답 형식이 올바르지 않습니다.');
                }

            } catch (error) {
                console.error('v1.3.1 주간 비교 정보 로드 오류:', error);
                document.getElementById('v131-weekly-comparison-content').innerHTML =
                    '<span style="color: #dc3545;">데이터 로드 실패</span>';
            }
        }

        // v1.3.1 주간 비교 결과 표시
        function displayV131WeeklyComparison(data) {
            const contentDiv = document.getElementById('v131-weekly-comparison-content');

            const netChangeIcon = data.net_change > 0 ? '📈' : data.net_change < 0 ? '📉' : '➡️';
            const netChangeColor = data.net_change > 0 ? '#28a745' : data.net_change < 0 ? '#dc3545' : '#6c757d';
            const netChangeText = data.net_change > 0 ? '증가' : data.net_change < 0 ? '감소' : '변화없음';

            // API에서 받은 데이터 구조에 맞게 수정
            const todayDate = data.comparison_date ? data.comparison_date.today : new Date().toLocaleDateString('ko-KR');
            const weekAgoDate = data.comparison_date ? data.comparison_date.week_ago : new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ko-KR');

            // 일주일 전이 0인 경우 퍼센트 표시 안함
            const percentageDisplay = data.week_ago_v131_count === 0
                ? ''
                : `<span style="color: ${netChangeColor};">(${data.change_percentage > 0 ? '+' : ''}${data.change_percentage}%)</span>`;

            // 일렬 배치로 단순하게 표시
            contentDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; font-size: 12px;">
                    <span><strong>현재:</strong> ${data.today_v131_count}명</span>
                    <span><strong>일주일전:</strong> ${data.week_ago_v131_count}명</span>
                    <span style="color: ${netChangeColor}; font-weight: bold;">
                        ${netChangeIcon} ${Math.abs(data.net_change)}명 ${netChangeText}
                    </span>
                    ${percentageDisplay}
                </div>
            `;

            console.log('v1.3.1 주간 비교 결과 표시 완료:', data);
        }

        // AAA 미사용자 주간 비교 정보 로드
        async function loadUnusedUsersWeeklyComparison() {
            try {
                console.log('=== AAA 미사용자 주간 비교 정보 로드 시작 ===');

                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');

                // API 엔드포인트 호출
                const url = '/api/main/unused-users/weekly-comparison';

                const headers = {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'x-admin-role': adminRole,
                    'x-user-id': userId
                };

                const response = await fetch(url, { headers });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('AAA 미사용자 주간 비교 API 응답:', result);

                if (result.success && result.data) {
                    displayUnusedUsersWeeklyComparison(result.data);
                } else {
                    throw new Error('API 응답 형식이 올바르지 않습니다.');
                }

            } catch (error) {
                console.error('AAA 미사용자 주간 비교 정보 로드 오류:', error);
                document.getElementById('unused-weekly-comparison-content').innerHTML =
                    '<span style="color: #dc3545;">데이터 로드 실패</span>';
            }
        }

        // AAA 미사용자 주간 비교 결과 표시 (가로로 길게)
        function displayUnusedUsersWeeklyComparison(data) {
            const contentDiv = document.getElementById('unused-weekly-comparison-content');

            const netChangeIcon = data.net_change > 0 ? '📈' : data.net_change < 0 ? '📉' : '➡️';
            const netChangeColor = data.net_change > 0 ? '#dc3545' : data.net_change < 0 ? '#28a745' : '#6c757d'; // 미사용자는 증가가 나쁜 것
            const netChangeText = data.net_change > 0 ? '증가' : data.net_change < 0 ? '감소' : '변화없음';

            // 가로로 길게 일렬 배치
            contentDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px; font-size: 12px;">
                    <span><strong>현재:</strong> ${data.today_unused_count}명</span>
                    <span><strong>일주일전:</strong> ${data.week_ago_unused_count}명</span>
                    <span style="color: ${netChangeColor}; font-weight: bold;">
                        ${netChangeIcon} ${Math.abs(data.net_change)}명 ${netChangeText}
                    </span>
                    <span style="color: ${netChangeColor};">
                        (${data.change_percentage > 0 ? '+' : ''}${data.change_percentage}%)
                    </span>
                    ${data.became_inactive_count > 0 ? `<span style="color: #666;">😴 ${data.became_inactive_count}명 중단</span>` : ''}
                    ${data.became_active_count > 0 ? `<span style="color: #666;">🎉 ${data.became_active_count}명 시작</span>` : ''}
                </div>
            `;

            console.log('AAA 미사용자 주간 비교 결과 표시 완료:', data);
        }

        // Excel 내보내기 함수
        async function exportAppVersionToExcel() {
            try {
                console.log('=== Excel 내보내기 시작 ===');
                
                // 현재 필터 상태로 전체 데이터 조회
                let allData = await fetchAllAppVersionData();
                console.log(`Excel 내보내기: 서버에서 조회된 전체 데이터 ${allData.length}건`);
                console.log('현재 부서 필터:', selectedDeptAppVersion);
                
                // 중국지사 제외 필터 적용
                if (selectedDeptAppVersion === '중국지사 제외') {
                    const beforeCount = allData.length;
                    allData = allData.filter(item => item.dept !== '중국지사');
                    console.log(`Excel 내보내기: 중국지사 제외 필터 적용 - ${beforeCount}건에서 ${allData.length}건으로 필터링`);
                }
                
                if (!allData || allData.length === 0) {
                    alert('내보낼 데이터가 없습니다.');
                    return;
                }
                
                // Excel 데이터 구성
                const worksheetData = [
                    ['번호', '사용자 ID', '이름', '부서', '앱 버전', '개인정보 동의'], // 헤더
                    ...allData.map((item, index) => [
                        index + 1,
                        item.user_id || '-',
                        item.name || '-',
                        item.dept || '-',
                        getVersionText(item.version_info),
                        item.is_agreed == 1 ? '동의함' : '동의안함'
                    ])
                ];
                
                // SheetJS를 사용하여 Excel 파일 생성
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '사용자 앱 버전 내역');
                
                // 컬럼 너비 설정
                worksheet['!cols'] = [
                    { width: 8 },   // 번호
                    { width: 15 },  // 사용자 ID
                    { width: 12 },  // 이름
                    { width: 20 },  // 부서
                    { width: 10 },  // 앱 버전
                    { width: 15 }   // 개인정보 동의
                ];
                
                // 파일명 생성 (현재 날짜/시간 + 필터 정보)
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                let filterInfo = '';
                if (selectedVersion !== '전체') filterInfo += `_버전${selectedVersion}`;
                if (selectedDeptAppVersion !== '전체') filterInfo += `_부서${selectedDeptAppVersion}`;
                if (selectedConsentAppVersion !== '전체') filterInfo += `_동의${selectedConsentAppVersion}`;
                
                const filename = `사용자_앱버전_내역_${dateStr}${filterInfo}.xlsx`;
                
                // 파일 다운로드
                XLSX.writeFile(workbook, filename);
                
                console.log('Excel 파일 다운로드 완료:', filename);
                
            } catch (error) {
                console.error('Excel 내보내기 오류:', error);
                alert('Excel 파일 내보내기에 실패했습니다.');
            }
        }

        // 전체 앱 버전 데이터 조회 함수
        async function fetchAllAppVersionData() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                let url = `/api/main/app-version?page=1&limit=10000`; // 큰 수로 설정하여 모든 데이터 조회
                
                // 현재 적용된 필터들 추가
                if (selectedVersion !== '전체') {
                    url += `&version=${encodeURIComponent(selectedVersion)}`;
                }
                
                if (selectedDeptAppVersion !== '전체' && selectedDeptAppVersion !== '중국지사 제외') {
                    url += `&dept=${encodeURIComponent(selectedDeptAppVersion)}`;
                }
                
                if (selectedConsentAppVersion !== '전체') {
                    let consentValue;
                    if (selectedConsentAppVersion === '동의함') {
                        consentValue = '1';
                    } else if (selectedConsentAppVersion === '동의안함') {
                        consentValue = '0';
                    }
                    url += `&consent=${consentValue}`;
                }
                
                console.log('전체 데이터 조회 URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('전체 데이터 조회 실패');
                }
                
                const data = await response.json();
                console.log('전체 데이터 조회 완료, 총', data.versionList?.length || 0, '건');
                
                return data.versionList || [];
                
            } catch (error) {
                console.error('전체 데이터 조회 오류:', error);
                throw error;
            }
        }

        // Markdown 내보내기 함수
        async function exportAppVersionToMarkdown() {
            try {
                console.log('=== Markdown 내보내기 시작 ===');
                
                // 현재 필터 상태로 전체 데이터 조회
                let allData = await fetchAllAppVersionData();
                console.log(`Markdown 내보내기: 서버에서 조회된 전체 데이터 ${allData.length}건`);
                console.log('현재 부서 필터:', selectedDeptAppVersion);
                
                // 중국지사 제외 필터 적용
                if (selectedDeptAppVersion === '중국지사 제외') {
                    const beforeCount = allData.length;
                    allData = allData.filter(item => item.dept !== '중국지사');
                    console.log(`Markdown 내보내기: 중국지사 제외 필터 적용 - ${beforeCount}건에서 ${allData.length}건으로 필터링`);
                }
                
                if (!allData || allData.length === 0) {
                    alert('내보낼 데이터가 없습니다.');
                    return;
                }
                
                // 현재 날짜/시간
                const now = new Date();
                const dateTimeStr = now.toLocaleString('ko-KR');
                
                // 필터 정보 문자열 생성
                let filterInfoStr = '';
                const activeFilters = [];
                if (selectedVersion !== '전체') activeFilters.push(`앱 버전: ${selectedVersion}`);
                if (selectedDeptAppVersion !== '전체') activeFilters.push(`부서: ${selectedDeptAppVersion}`);
                if (selectedConsentAppVersion !== '전체') activeFilters.push(`개인정보 동의: ${selectedConsentAppVersion}`);
                
                if (activeFilters.length > 0) {
                    filterInfoStr = `\n**적용된 필터:** ${activeFilters.join(', ')}\n`;
                }
                
                // Markdown 내용 생성
                let markdownContent = `# 사용자 앱 버전 내역\n\n`;
                markdownContent += `**생성 일시:** ${dateTimeStr}\n`;
                markdownContent += `**총 사용자 수:** ${allData.length}명\n`;
                markdownContent += filterInfoStr;
                markdownContent += `\n---\n\n`;
                
                // 테이블 헤더
                markdownContent += `| 번호 | 사용자 ID | 이름 | 부서 | 앱 버전 | 개인정보 동의 |\n`;
                markdownContent += `|------|-----------|------|------|---------|---------------|\n`;
                
                // 데이터 행들
                allData.forEach((item, index) => {
                    const userId = (item.user_id || '-').replace(/\|/g, '\\|');
                    const name = (item.name || '-').replace(/\|/g, '\\|');
                    const dept = (item.dept || '-').replace(/\|/g, '\\|');
                    const version = getVersionText(item.version_info);
                    const consent = item.is_agreed == 1 ? '동의함' : '동의안함';
                    
                    markdownContent += `| ${index + 1} | ${userId} | ${name} | ${dept} | ${version} | ${consent} |\n`;
                });
                
                // 요약 정보 추가
                markdownContent += `\n---\n\n## 요약 정보\n\n`;
                
                // 버전별 통계
                const versionStats = {};
                allData.forEach(item => {
                    const version = getVersionText(item.version_info);
                    versionStats[version] = (versionStats[version] || 0) + 1;
                });
                
                markdownContent += `### 앱 버전별 통계\n\n`;
                Object.entries(versionStats).forEach(([version, count]) => {
                    markdownContent += `- **${version}**: ${count}명\n`;
                });
                
                // 동의 현황 통계
                const consentStats = { '동의함': 0, '동의안함': 0 };
                allData.forEach(item => {
                    if (item.is_agreed == 1) {
                        consentStats['동의함']++;
                    } else {
                        consentStats['동의안함']++;
                    }
                });
                
                markdownContent += `\n### 개인정보 동의 현황\n\n`;
                markdownContent += `- **동의함**: ${consentStats['동의함']}명\n`;
                markdownContent += `- **동의안함**: ${consentStats['동의안함']}명\n`;
                
                // 파일명 생성
                const dateStr = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                let filterInfo = '';
                if (selectedVersion !== '전체') filterInfo += `_버전${selectedVersion}`;
                if (selectedDeptAppVersion !== '전체') filterInfo += `_부서${selectedDeptAppVersion}`;
                if (selectedConsentAppVersion !== '전체') filterInfo += `_동의${selectedConsentAppVersion}`;
                
                const filename = `사용자_앱버전_내역_${dateStr}${filterInfo}.md`;
                
                // 파일 다운로드
                const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Markdown 파일 다운로드 완료:', filename);
                
            } catch (error) {
                console.error('Markdown 내보내기 오류:', error);
                alert('Markdown 파일 내보내기에 실패했습니다.');
            }
        }

        // 전체 생일자 개인정보 동의 현황 데이터 조회 함수
        async function fetchAllPrivacyConsentData() {
            try {
                const adminRole = localStorage.getItem('adminRole');
                const userId = localStorage.getItem('userId');
                
                let url = `/api/main/privacy-consent?page=1&limit=10000`; // 큰 수로 설정하여 모든 데이터 조회
                
                // 현재 적용된 필터들 추가
                if (selectedConsent !== '전체') {
                    const consentValue = selectedConsent === '동의함' ? '1' : '0';
                    url += `&consent=${consentValue}`;
                }
                
                if (selectedDeptPrivacy !== '전체') {
                    url += `&dept=${encodeURIComponent(selectedDeptPrivacy)}`;
                }
                
                if (selectedBirthdayMonth !== '전체') {
                    url += `&month=${selectedBirthdayMonth}`;
                }
                
                // 3개월 이상 근무자 필터가 활성화된 경우 senior_employee 파라미터 추가
                if (isSeniorEmployeeFilterActive) {
                    url += '&senior_employee=true';
                }
                
                console.log('전체 생일자 개인정보 동의 현황 데이터 조회 URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'x-admin-role': adminRole,
                        'x-user-id': userId
                    }
                });
                
                if (!response.ok) {
                    throw new Error('전체 데이터 조회 실패');
                }
                
                const data = await response.json();
                console.log('전체 생일자 개인정보 동의 현황 데이터 조회 완료, 총', data.consentList?.length || 0, '건');
                
                return data.consentList || [];
                
            } catch (error) {
                console.error('전체 생일자 개인정보 동의 현황 데이터 조회 오류:', error);
                throw error;
            }
        }

        // 생일자 개인정보 동의 현황 Excel 내보내기 함수
        async function exportPrivacyConsentToExcel() {
            try {
                console.log('=== 생일자 개인정보 동의 현황 Excel 내보내기 시작 ===');
                
                // 현재 필터 상태로 전체 데이터 조회
                const allData = await fetchAllPrivacyConsentData();
                
                if (!allData || allData.length === 0) {
                    alert('내보낼 데이터가 없습니다.');
                    return;
                }
                
                // Excel 데이터 구성
                const worksheetData = [
                    ['번호', '사용자 ID', '이름', '부서', '생일', '개인정보 동의'], // 헤더
                    ...allData.map((item, index) => [
                        index + 1,
                        item.user_id || '-',
                        item.name || '-',
                        item.dept || '-',
                        item.birthday ? formatBirthday(item.birthday) : '미작성',
                        item.is_agreed == 1 ? '동의함' : '미동의'
                    ])
                ];
                
                // SheetJS를 사용하여 Excel 파일 생성
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '생일자 개인정보 동의 현황');
                
                // 컬럼 너비 설정
                worksheet['!cols'] = [
                    { width: 8 },   // 번호
                    { width: 15 },  // 사용자 ID
                    { width: 12 },  // 이름
                    { width: 20 },  // 부서
                    { width: 12 },  // 생일
                    { width: 15 }   // 개인정보 동의
                ];
                
                // 파일명 생성 (현재 날짜/시간 + 필터 정보)
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                let filterInfo = '';
                if (selectedConsent !== '전체') filterInfo += `_동의${selectedConsent}`;
                if (selectedDeptPrivacy !== '전체') filterInfo += `_부서${selectedDeptPrivacy}`;
                if (selectedBirthdayMonth !== '전체') filterInfo += `_생일월${selectedBirthdayMonth}`;
                
                const filename = `생일자_개인정보_동의현황_${selectedYear}년_${dateStr}${filterInfo}.xlsx`;
                
                // 파일 다운로드
                XLSX.writeFile(workbook, filename);
                
                console.log('Excel 파일 다운로드 완료:', filename);
                
            } catch (error) {
                console.error('생일자 개인정보 동의 현황 Excel 내보내기 오류:', error);
                alert('Excel 파일 내보내기에 실패했습니다.');
            }
        }

        // 생일 포맷팅 함수
        function formatBirthday(birthday) {
            if (!birthday) return '미작성';
            
            try {
                const date = new Date(birthday);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${month}-${day}`;
            } catch (error) {
                console.error('생일 포맷팅 오류:', error);
                return '미작성';
            }
        }

        // 모달 외부 클릭 시 필터 드롭다운들 닫기
        document.addEventListener('click', function(event) {
            const versionDropdown = document.getElementById('version-filter-dropdown');
            const versionHeader = document.querySelector('.version-filter-header');
            const deptDropdown = document.getElementById('dept-filter-dropdown-appversion');
            const deptHeader = document.querySelector('.dept-filter-header-appversion');
            const consentDropdown = document.getElementById('consent-filter-dropdown');
            const consentHeader = document.querySelector('.consent-filter-header');
            const consentAppVersionDropdown = document.getElementById('consent-filter-dropdown-appversion');
            const consentAppVersionHeader = document.querySelector('.consent-filter-header-appversion');
            const deptPrivacyDropdown = document.getElementById('dept-filter-dropdown-privacy');
            const deptPrivacyHeader = document.querySelector('.dept-filter-header-privacy');
            
            if (versionDropdown && versionHeader && !versionHeader.contains(event.target)) {
                versionDropdown.classList.remove('show');
            }
            
            if (deptDropdown && deptHeader && !deptHeader.contains(event.target)) {
                deptDropdown.classList.remove('show');
            }
            
            if (consentDropdown && consentHeader && !consentHeader.contains(event.target)) {
                consentDropdown.classList.remove('show');
            }
            
            if (consentAppVersionDropdown && consentAppVersionHeader && !consentAppVersionHeader.contains(event.target)) {
                consentAppVersionDropdown.classList.remove('show');
            }
            
            if (deptPrivacyDropdown && deptPrivacyHeader && !deptPrivacyHeader.contains(event.target)) {
                deptPrivacyDropdown.classList.remove('show');
            }

        });

    </script>
    <style>
        .admin-notice {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .admin-notice h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .admin-notice ul {
            list-style: none;
            padding: 0;
        }
        
        .admin-notice li {
            padding: 5px 0;
            color: #6c757d;
        }
        
        /* 관리자 활동 목록 스타일 */
        .activity-item {
            position: relative;
        }
        
        .activity-error {
            background-color: #fee;
            border-left: 3px solid #dc3545;
            padding-left: 10px;
        }
        
        .activity-user {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .no-activity {
            color: #999;
            font-style: italic;
        }
        
        /* 활동 토글 버튼 스타일 */
        .activity-toggle-btn {
            width: 100%;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .activity-toggle-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .activity-toggle-btn:active {
            transform: translateY(1px);
        }
        
        .toggle-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .activity-list {
            margin-top: 0;
            padding-top: 10px;
        }

        /* CSR 이상내역 카드 스타일 */
        .csr-abnormal-card {
            cursor: pointer;
            border-left: 4px solid #e74c3c;
            transition: all 0.3s ease;
        }

        .csr-abnormal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.2);
        }

        .csr-abnormal-card h3 {
            color: #e74c3c;
        }

        .csr-abnormal-card p {
            color: #e74c3c;
            font-size: 2em;
            font-weight: bold;
        }

        .csr-abnormal-card small {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-top: 5px;
            display: block;
        }

        /* CSR 이상내역 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* 생일자 개인정보 동의 현황 모달 특별 스타일 */
        #privacy-consent-modal .modal-content {
            width: 95%;
            max-width: none;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-section select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 120px;
        }

        .filter-section button {
            padding: 6px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
            white-space: nowrap;
            min-width: 70px;
        }

        .filter-section button:hover {
            background-color: #2980b9;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px !important;
            font-size: 13px !important;
            border-radius: 6px !important;
            transition: all 0.3s ease !important;
            border: none !important;
            cursor: pointer !important;
            font-weight: 500 !important;
        }

        .excel-btn {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
        }

        .excel-btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .md-btn {
            background: linear-gradient(135deg, #6f42c1, #8e44ad) !important;
            color: white !important;
        }

        .md-btn:hover {
            background: linear-gradient(135deg, #8e44ad, #6f42c1) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }

        #csr-abnormal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        #csr-abnormal-table th,
        #csr-abnormal-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        #csr-abnormal-table th:last-child,
        #csr-abnormal-table td:last-child {
            border-right: none;
        }

        #csr-abnormal-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #adb5bd;
            text-align: center;
        }

        #csr-abnormal-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* 컬럼별 너비 설정 */
        #csr-abnormal-table th:nth-child(1),
        #csr-abnormal-table td:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        #csr-abnormal-table th:nth-child(2),
        #csr-abnormal-table td:nth-child(2) {
            width: 18%;
            text-align: center;
        }

        #csr-abnormal-table th:nth-child(3),
        #csr-abnormal-table td:nth-child(3) {
            width: 12%;
            text-align: center;
        }

        /* CSR ID 컬럼 bold 처리 */
        #csr-abnormal-table td:nth-child(3) {
            font-weight: bold;
            color: #2c3e50;
        }

        #csr-abnormal-table th:nth-child(4),
        #csr-abnormal-table td:nth-child(4) {
            width: 15%;
            text-align: center;
        }

        #csr-abnormal-table th:nth-child(5),
        #csr-abnormal-table td:nth-child(5) {
            width: 35%;
            text-align: left;
        }

        #csr-abnormal-table th:nth-child(6),
        #csr-abnormal-table td:nth-child(6) {
            width: 12%;
            text-align: center;
        }

        /* 상태별 색상 스타일 */
        .status-complete {
            color: #27ae60;  /* 초록색 - 완료 (최종단계) */
            font-weight: bold;
        }

        .status-reject {
            color: #e74c3c;  /* 빨강색 - 반려 */
            font-weight: bold;
        }

        .status-confirm {
            color: #3498db;  /* 파란색 - 승인 */
            font-weight: bold;
        }

        .status-devtest {
            color: #f1c40f;  /* 노란색 - 개발테스트 */
            font-weight: bold;
        }

        .status-test {
            color: #f39c12;  /* 주황색 - 테스트 */
            font-weight: bold;
        }

        .status-process {
            color: #e67e22;  /* 다크 오렌지 - 처리진행 */
            font-weight: bold;
        }

        .status-hold {
            color: #95a5a6;  /* 회색 - 보류 */
            font-weight: bold;
        }

        .status-plan {
            color: #9b59b6;  /* 보라색 - 계획 */
            font-weight: bold;
        }

        .status-qa {
            color: #8e44ad;  /* 진보라색 - 검증 */
            font-weight: bold;
        }

        .status-release {
            color: #2980b9;  /* 진파란색 - 배포 */
            font-weight: bold;
        }

        .status-release-file {
            color: #1abc9c;  /* 청록색 - 배포 파일 준비 */
            font-weight: bold;
        }

        /* 기존 스타일 유지 (하위 호환성) */
        .status-pending {
            color: #f39c12;
            font-weight: bold;
        }

        .status-resolved {
            color: #27ae60;
            font-weight: bold;
        }

        .status-investigating {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-planning {
            color: #9b59b6;
            font-weight: bold;
        }

        /* 페이지네이션 스타일 */
        #csr-abnormal-pagination {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .pagination-info {
            text-align: center;
        }

        .pagination-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        #csr-abnormal-pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        #csr-abnormal-pagination button:hover {
            background-color: #f8f9fa;
        }

        #csr-abnormal-pagination button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* CSR 상세 모달 스타일 */
        .csr-detail-container {
            max-height: 80vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .detail-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        /* 요청서 상세보기 컨테이너 스타일 */
        .request-detail-section {
            background-color: #f8f9fa;
            border: 2px solid #3498db;
        }

        .request-header-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .header-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .header-item label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
            background-color: #e8f4f8;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .header-item span {
            color: #333;
            padding: 10px 12px;
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            min-height: 20px;
            font-size: 0.95em;
        }

        .request-content-section {
            margin-top: 20px;
            border-top: 1px solid #bdc3c7;
            padding-top: 20px;
        }

        .request-content-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1em;
            padding: 8px 12px;
            background-color: #e8f4f8;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .request-content-box {
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            padding: 20px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.95em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 마크다운 렌더링 스타일 */
        .request-content-box h1,
        .request-content-box h2,
        .request-content-box h3,
        .request-content-box h4,
        .request-content-box h5,
        .request-content-box h6 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .request-content-box h1 { font-size: 1.4em; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .request-content-box h2 { font-size: 1.3em; color: #3498db; }
        .request-content-box h3 { font-size: 1.2em; color: #2980b9; }
        .request-content-box h4 { font-size: 1.1em; }

        .request-content-box ul,
        .request-content-box ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .request-content-box li {
            margin: 5px 0;
        }

        .request-content-box p {
            margin: 10px 0;
        }

        .request-content-box code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .request-content-box pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }

        .request-content-box blockquote {
            border-left: 4px solid #3498db;
            margin: 15px 0;
            padding: 10px 20px;
            background-color: #f8f9fa;
            font-style: italic;
        }

        .request-content-box strong,
        .request-content-box b {
            font-weight: 600;
            color: #2c3e50;
        }

        .request-content-box em,
        .request-content-box i {
            font-style: italic;
            color: #555;
        }

        /* 2번 컨테이너: 진행 내역 상세 스타일 */
        .progress-detail-section {
            background-color: #f0f8ff;
            border: 2px solid #2980b9;
        }

        .progress-header-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-content-section {
            margin-top: 20px;
            border-top: 1px solid #85c1e9;
            padding-top: 20px;
        }

        .progress-content-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1em;
            padding: 8px 12px;
            background-color: #d6eaf8;
            border-radius: 4px;
            border-left: 4px solid #2980b9;
        }

        .progress-content-box {
            background-color: white;
            border: 1px solid #85c1e9;
            border-radius: 6px;
            padding: 20px;
            min-height: 120px;
            max-height: 250px;
            overflow-y: auto;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.95em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 진행 내역 마크다운 렌더링 스타일 */
        .progress-content-box h1,
        .progress-content-box h2,
        .progress-content-box h3,
        .progress-content-box h4,
        .progress-content-box h5,
        .progress-content-box h6 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .progress-content-box h1 { font-size: 1.4em; border-bottom: 2px solid #2980b9; padding-bottom: 5px; }
        .progress-content-box h2 { font-size: 1.3em; color: #2980b9; }
        .progress-content-box h3 { font-size: 1.2em; color: #3498db; }
        .progress-content-box h4 { font-size: 1.1em; }

        .progress-content-box ul,
        .progress-content-box ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .progress-content-box li {
            margin: 5px 0;
        }

        .progress-content-box p {
            margin: 10px 0;
        }

        .progress-content-box code {
            background-color: #e8f4f8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .progress-content-box pre {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #2980b9;
        }

        .progress-content-box blockquote {
            border-left: 4px solid #2980b9;
            margin: 15px 0;
            padding: 10px 20px;
            background-color: #e8f4f8;
            font-style: italic;
        }

        .progress-content-box strong,
        .progress-content-box b {
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-content-box em,
        .progress-content-box i {
            font-style: italic;
            color: #555;
        }

        /* 3번 컨테이너: 이상 탐지 내역 스타일 */
        .abnormal-detail-section {
            background-color: #fff5f5;
            border: 2px solid #e74c3c;
        }

        .abnormal-list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .abnormal-item {
            background-color: white;
            border: 1px solid #f1948a;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(231, 76, 60, 0.1);
        }

        .abnormal-item:last-child {
            margin-bottom: 0;
        }

        .abnormal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #fadbd8;
        }

        .abnormal-time {
            color: #e74c3c;
            font-weight: 600;
            font-size: 0.9em;
            background-color: #fdeaea;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .abnormal-content {
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
            font-size: 0.95em;
        }

        .no-abnormal {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            background-color: white;
            border: 1px dashed #bdc3c7;
            border-radius: 6px;
        }

        /* 기존 스타일 유지 (하위 호환성) */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-item label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .detail-item span {
            color: #333;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 20px;
        }

        .detail-content {
            margin-top: 10px;
        }

        .abnormal-detail-box {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* 테이블 행 클릭 가능 스타일 */
        #csr-abnormal-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #csr-abnormal-table tbody tr:hover {
            background-color: #e3f2fd !important;
        }

        /* AAA 미사용자 명단 카드 스타일 */
        .unused-users-card {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .unused-users-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .unused-users-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .unused-users-card p {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .unused-users-card small {
            opacity: 0.9;
            font-size: 0.85em;
        }

        /* 미사용자 테이블 스타일 */
        #unused-users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        #unused-users-table th,
        #unused-users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        #unused-users-table th:last-child,
        #unused-users-table td:last-child {
            border-right: none;
        }

        #unused-users-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #adb5bd;
            text-align: center;
        }

        #unused-users-table tbody tr:hover {
            background-color: #fff3e0;
        }

        /* 미사용자 테이블 컬럼별 너비 설정 */
        #unused-users-table th:nth-child(1),
        #unused-users-table td:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        #unused-users-table th:nth-child(2),
        #unused-users-table td:nth-child(2) {
            width: 15%;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        #unused-users-table th:nth-child(3),
        #unused-users-table td:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        #unused-users-table th:nth-child(4),
        #unused-users-table td:nth-child(4) {
            width: 20%;
            text-align: center;
        }

        #unused-users-table th:nth-child(5),
        #unused-users-table td:nth-child(5) {
            width: 25%;
            text-align: center;
        }

        #unused-users-table th:nth-child(6),
        #unused-users-table td:nth-child(6) {
            width: 17%;
            text-align: center;
            color: #e67e22;
            font-weight: 600;
        }

        /* 미사용자 페이지네이션 스타일 */
        .pagination-buttons button {
            padding: 8px 12px;
            margin: 0 2px;
            border: 1px solid #ddd;
            background-color: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .pagination-buttons button:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: #007bff;
        }

        .pagination-buttons button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }

        .pagination-buttons button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #dee2e6;
        }

        /* 부서 필터 헤더 스타일 */
        .dept-filter-header {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .dept-filter-header:hover {
            background-color: #f8f9fa !important;
        }

        .filter-icon {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .dept-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .dept-filter-dropdown.show {
            display: block;
        }

        .dept-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .dept-filter-option:last-child {
            border-bottom: none;
        }

        .dept-filter-option:hover {
            background-color: #f8f9fa;
        }

        .dept-filter-option.selected {
            background-color: #007bff;
            color: white;
        }

        /* 추석 선물 모니터링 - 부서 필터 스타일 */
        .dept-filter-header-chuseok {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .dept-filter-header-chuseok:hover {
            background-color: #f8f9fa !important;
        }

        .dept-filter-icon-chuseok {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .dept-filter-dropdown-chuseok {
            position: fixed;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 10000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 150px;
        }

        .dept-filter-dropdown-chuseok.show {
            display: block;
        }

        .dept-filter-option-chuseok {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .dept-filter-option-chuseok:last-child {
            border-bottom: none;
        }

        .dept-filter-option-chuseok:hover {
            background-color: #f8f9fa;
        }

        .dept-filter-option-chuseok.selected {
            background-color: #007bff;
            color: white;
        }

        /* 추석 선물 모니터링 - 발송 상태 필터 스타일 */
        .gift-status-filter-header {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .gift-status-filter-header:hover {
            background-color: #f8f9fa !important;
        }

        .gift-status-filter-icon {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .gift-status-filter-dropdown {
            position: fixed;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 10000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 150px;
        }

        .gift-status-filter-dropdown.show {
            display: block;
        }

        .gift-status-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .gift-status-filter-option:last-child {
            border-bottom: none;
        }

        .gift-status-filter-option:hover {
            background-color: #f8f9fa;
        }

        .gift-status-filter-option.selected {
            background-color: #007bff;
            color: white;
        }

        /* 사용자 앱 버전 내역 카드 스타일 */
        .app-version-card {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .app-version-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .app-version-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .app-version-card p {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
            color: white !important;
        }

        .app-version-card small {
            opacity: 0.9;
            font-size: 0.85em;
            color: white !important;
        }

        /* 앱 버전 카드 내 특정 요소들 흰색 강제 지정 */
        .app-version-card #app-version-summary {
            color: white !important;
        }

        .app-version-card h3 {
            color: white !important;
        }

        /* 개인정보 동의 현황 카드 스타일 */
        .privacy-consent-card {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .privacy-consent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .privacy-consent-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: white !important;
        }

        .privacy-consent-card p {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
            color: white !important;
        }

        .privacy-consent-card small {
            opacity: 0.9;
            font-size: 0.85em;
            color: white !important;
        }

        /* 개인정보 동의 카드 내 특정 요소들 흰색 강제 지정 */
        .privacy-consent-card #privacy-consent-summary {
            color: white !important;
        }

        /* 앱 버전 테이블 스타일 */
        #app-version-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        #app-version-table th,
        #app-version-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        #app-version-table th:last-child,
        #app-version-table td:last-child {
            border-right: none;
        }

        #app-version-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #adb5bd;
            text-align: center;
        }

        #app-version-table tbody tr:hover {
            background-color: #f0f8ff;
        }

        /* 앱 버전 테이블 컬럼별 너비 설정 */
        #app-version-table th:nth-child(1),
        #app-version-table td:nth-child(1) {
            width: 10%;
            text-align: center;
        }

        #app-version-table th:nth-child(2),
        #app-version-table td:nth-child(2) {
            width: 25%;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        #app-version-table th:nth-child(3),
        #app-version-table td:nth-child(3) {
            width: 20%;
            text-align: center;
        }

        #app-version-table th:nth-child(4),
        #app-version-table td:nth-child(4) {
            width: 25%;
            text-align: center;
        }

        #app-version-table th:nth-child(5),
        #app-version-table td:nth-child(5) {
            width: 20%;
            text-align: center;
        }

        /* 앱 버전별 색상 스타일 */
        .version-latest {
            color: #27ae60;
            font-weight: bold;
            background-color: #d5f5d5;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .version-old {
            color: #e67e22;
            font-weight: bold;
            background-color: #fdeaa7;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* 버전 필터 헤더 스타일 */
        .version-filter-header {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .version-filter-header:hover {
            background-color: #f8f9fa !important;
        }

        .version-filter-icon {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .version-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 9999;
            max-height: 150px;
            overflow-y: auto;
            min-width: 100px;
        }

        .version-filter-dropdown.show {
            display: block;
        }

        .version-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .version-filter-option:last-child {
            border-bottom: none;
        }

        .version-filter-option:hover {
            background-color: #f8f9fa;
        }

        .version-filter-option.selected {
            background-color: #6c5ce7;
            color: white;
        }

        /* 부서 필터 헤더 스타일 (앱 버전용) */
        .dept-filter-header-appversion {
            position: relative;
            user-select: none;
        }

        .dept-filter-header-appversion:hover {
            background-color: #f8f9fa !important;
        }

        .dept-header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .dept-title {
            font-weight: bold;
        }

        .dept-sort-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 2px 6px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dept-sort-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .dept-filter-icon-appversion {
            cursor: pointer;
        }

        .dept-filter-icon-appversion {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .dept-filter-dropdown-appversion {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 9999;
            max-height: 200px;
            overflow-y: auto;
            min-width: 120px;
        }

        .dept-filter-dropdown-appversion.show {
            display: block;
        }

        .dept-filter-option-appversion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .dept-filter-option-appversion:last-child {
            border-bottom: none;
        }

        .dept-filter-option-appversion:hover {
            background-color: #f8f9fa;
        }

        .dept-filter-option-appversion.selected {
            background-color: #28a745;
            color: white;
        }

        /* 개인정보 동의현황 부서 필터 스타일 */
        .dept-filter-header-privacy {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .dept-filter-header-privacy:hover {
            background-color: #f8f9fa !important;
        }

        .dept-filter-icon-privacy {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .dept-filter-dropdown-privacy {
            position: fixed;
            top: auto;
            left: auto;
            right: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 99999;
            max-height: 200px;
            overflow-y: auto;
            min-width: 120px;
            transform: translateY(0);
        }

        .dept-filter-dropdown-privacy.show {
            display: block;
            position: fixed !important;
            z-index: 99999 !important;
        }

        .dept-filter-option-privacy {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .dept-filter-option-privacy:last-child {
            border-bottom: none;
        }

        .dept-filter-option-privacy:hover {
            background-color: #f8f9fa;
        }

        .dept-filter-option-privacy.selected {
            background-color: #28a745;
            color: white;
        }

        /* 생일 월 필터 스타일 */
        .birthday-filter-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .birthday-filter-icon {
            font-size: 12px;
            margin-left: 4px;
            transition: transform 0.2s;
        }

        .birthday-filter-dropdown {
            position: fixed;
            top: auto;
            left: auto;
            right: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 99999;
            min-width: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .birthday-filter-dropdown.show {
            display: block;
            position: fixed !important;
            z-index: 99999 !important;
        }

        .birthday-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .birthday-filter-option:hover {
            background-color: #f8f9fa;
        }

        .birthday-filter-option.selected {
            background-color: #28a745;
            color: white;
        }

        /* 생일 헤더 및 정렬 스타일 */
        .birthday-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .birthday-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        .birthday-filter-part {
            flex: 1;
        }

        .birthday-sort-part {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 14px;
            font-weight: bold;
            color: #007bff;
        }

        .birthday-sort-part:hover {
            background-color: #f8f9fa;
        }

        /* 월별 생일자 인원수 표시 스타일 */
        .birthday-count-section {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .birthday-count-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr); /* 12개월 + 미작성 = 13개 */
            gap: 6px;
            margin-top: 10px;
        }

        .birthday-count-item {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 2px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 0; /* 유연한 너비 허용 */
        }

        .birthday-count-item:hover {
            background-color: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .birthday-count-item.selected {
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,123,255,0.3);
        }

        .birthday-count-item.selected .month-name {
            color: white;
            font-weight: 700;
        }

        .birthday-count-item.selected .month-count {
            color: white;
            font-weight: 600;
        }

        .birthday-count-item.selected:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .month-name {
            font-size: 11px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 2px;
        }

        .month-count {
            font-size: 12px;
            color: #007bff;
            font-weight: bold;
        }

        /* 미작성 아이템 스타일 */
        .no-birthday-item {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }

        .no-birthday-item:hover {
            background-color: #fff3cd !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .no-birthday-item .month-name {
            color: #856404 !important;
        }

        .no-birthday-item .month-count {
            color: #856404 !important;
        }

        /* 개인정보 동의 현황 테이블 컨테이너 스타일 */
        #privacy-consent-modal .table-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 개인정보 동의 현황 테이블 스타일 */
        #privacy-consent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            border: none;
        }

        #privacy-consent-table th,
        #privacy-consent-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        #privacy-consent-table th:last-child,
        #privacy-consent-table td:last-child {
            border-right: none;
        }

        #privacy-consent-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #adb5bd;
        }

        #privacy-consent-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* 동의 현황 필터 헤더 스타일 */
        .consent-filter-header {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .consent-filter-header:hover {
            background-color: #f8f9fa !important;
        }

        .consent-filter-icon {
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .consent-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 9999;
            max-height: 200px;
            overflow-y: auto;
            min-width: 120px;
        }

        .consent-filter-dropdown.show {
            display: block;
        }

        .consent-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .consent-filter-option:last-child {
            border-bottom: none;
        }

        .consent-filter-option:hover {
            background-color: #f8f9fa;
        }

        .consent-filter-option.selected {
            background-color: #2ecc71;
            color: white;
        }

        /* 동의 현황별 글자색 스타일 */
        .consent-agreed {
            color: #27ae60 !important;
            font-weight: bold;
        }

        .consent-disagreed {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        /* 앱 버전 테이블의 개인정보 동의 컬럼 스타일 */
        #app-version-table .consent-agreed {
            color: #28a745;
            font-weight: 600;
        }
        
        #app-version-table .consent-disagreed {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* 개인정보 동의 컬럼 헤더 가로 정렬 */
        #app-version-table th:last-child {
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            white-space: nowrap;
        }
        
        /* 앱 버전 개인정보 동의 필터 스타일 */
        .consent-filter-header-appversion {
            position: relative;
            cursor: pointer;
            user-select: none;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .consent-filter-header-appversion:hover {
            background: #e9ecef;
        }
        
        .consent-filter-icon-appversion {
            margin-left: 5px;
            transition: transform 0.2s;
        }
        
        .consent-filter-dropdown-appversion {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 120px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .consent-filter-dropdown-appversion.show {
            display: block;
        }
        
        .consent-filter-option-appversion {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .consent-filter-option-appversion:hover {
            background: #f8f9fa;
        }
        
        .consent-filter-option-appversion.selected {
            background: #007bff;
            color: white;
        }
        
        .consent-filter-option-appversion:last-child {
            border-bottom: none;
        }

        /* 개인정보 동의 현황 페이지네이션 스타일 */
        #privacy-consent-pagination {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        #privacy-consent-pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        #privacy-consent-pagination button:hover {
            background-color: #f8f9fa;
        }

        #privacy-consent-pagination button.active {
            background-color: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        /* 토스 스타일 모달 */
        .toss-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            animation: toss-modal-fade-in 0.3s ease-out;
        }

        .toss-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .toss-modal-content {
            position: relative;
            max-width: 480px;
            width: 90%;
            margin: 10vh auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: toss-modal-slide-up 0.3s ease-out;
            overflow: hidden;
        }

        .toss-modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toss-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #191f28;
            margin: 0;
        }

        .toss-modal-close {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b95a1;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toss-modal-close:hover {
            background: #f2f4f6;
            color: #4e5968;
        }

        .toss-modal-body {
            padding: 24px;
        }

        .toss-user-info {
            display: flex;
            align-items: center;
            margin-bottom: 32px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
        }

        .toss-user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .toss-user-avatar span {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .toss-user-name {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: white;
        }

        .toss-user-dept {
            font-size: 14px;
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .toss-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .toss-info-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .toss-info-item:hover {
            background: #f1f3f4;
            transform: translateY(-1px);
        }

        .toss-info-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #8b95a1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .toss-info-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #191f28;
            word-break: break-all;
        }

        .toss-consent-badge {
            padding: 4px 8px !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toss-consent-badge.agreed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .toss-consent-badge.disagreed {
            background: #ffeaea;
            color: #d32f2f;
        }

        .toss-additional-info {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e9ecef;
        }

        .toss-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #191f28;
            margin: 0 0 16px 0;
        }

        .toss-additional-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @keyframes toss-modal-fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes toss-modal-slide-up {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media (max-width: 600px) {
            .toss-modal-content {
                width: 95%;
                margin: 5vh auto;
                border-radius: 16px;
            }

            .toss-info-grid,
            .toss-additional-grid {
                grid-template-columns: 1fr;
            }

            .toss-modal-header {
                padding: 20px 20px 12px 20px;
            }

            .toss-modal-body {
                padding: 20px;
            }

            .toss-modal-title {
                font-size: 18px;
            }
        }

        /* 연도별 탭 스타일 */
        .year-tabs-section {
            margin: 20px 0;
            padding: 0 10px;
        }

        .year-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .year-tab {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }

        .year-tab:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .year-tab.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
            font-weight: 600;
        }

        /* 생일메시지 상태 스타일 */
        .birthday-message-status {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        /* 쿠폰 관련 컬럼 스타일 */
        .coupon-status {
            font-size: 12px;
            font-weight: 500;
        }

        .coupon-expiry {
            font-size: 12px;
            color: #666;
        }

        .coupon-usage {
            font-size: 12px;
            font-weight: 500;
        }

        /* 쿠폰 상태별 색상 */
        .coupon-usage[data-status="발행"] {
            color: #28a745;
        }

        .coupon-usage[data-status="사용"] {
            color: #6c757d;
        }

        .coupon-usage[data-status="만료"] {
            color: #dc3545;
        }

        /* 추석 선물 모니터링 모달 스타일 */
        #chuseok-gift-modal .modal-content {
            width: 95%;
            height: 95%;
            max-width: none;
            max-height: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
        }

        #chuseok-gift-modal .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chuseok-gift-modal .filter-section {
            flex-shrink: 0;
        }

        #chuseok-gift-modal .table-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            margin-bottom: 15px;
        }

        #chuseok-gift-modal .pagination {
            flex-shrink: 0;
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }

        #chuseok-gift-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            border: none;
        }

        #chuseok-gift-table th,
        #chuseok-gift-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        #chuseok-gift-table th:last-child,
        #chuseok-gift-table td:last-child {
            border-right: none;
        }

        #chuseok-gift-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #adb5bd;
        }

        #chuseok-gift-table tbody tr:hover {
            background-color: #f5f5f5;
        }


        /* 추석 선물 발송 상태 뱃지 */
        .chuseok-gift-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }

        .chuseok-gift-status.sent {
            background-color: #d4edda;
            color: #155724;
        }

        .chuseok-gift-status.not-sent {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 추석 선물 수령 상태 뱃지 */
        .gift-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }

        .gift-status.sent {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .gift-status.not-sent {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>

    <!-- 추석 선물 모니터링 현황 모달 -->
    <div id="chuseok-gift-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🌕 추석 선물 모니터링 현황</h2>
                <span class="close" onclick="closeChuseokGiftModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 필터 및 컨트롤 섹션 -->
                <div class="filter-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

                            <!-- 3개월 이상 근무자 필터 -->
                            <button id="chuseok-senior-employee-filter-btn" onclick="toggleChuseokSeniorEmployeeFilter()"
                                    style="padding: 6px 12px; font-size: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                    title="입사 3개월 이상 인원만 조회">3개월+</button>
                        </div>

                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="loadChuseokGiftData()" style="padding: 6px 12px; font-size: 12px;">새로고침</button>
                            <button onclick="resetChuseokGiftFilters()" style="background-color: #6c757d; padding: 6px 12px; font-size: 12px;">필터 초기화</button>
                            <button onclick="exportChuseokGiftToExcel()" class="export-btn excel-btn" style="padding: 6px 12px; font-size: 12px;">📊 Excel</button>
                        </div>
                    </div>
                </div>

                <!-- 테이블 컨테이너 -->
                <div class="table-container">
                    <table id="chuseok-gift-table" class="data-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>사용자명</th>
                                <th class="dept-filter-header-chuseok" onclick="toggleDeptFilterChuseok(event)">
                                    부서
                                    <span class="dept-filter-icon-chuseok">▼</span>
                                    <div id="dept-filter-dropdown-chuseok" class="dept-filter-dropdown-chuseok">
                                        <div class="dept-filter-option-chuseok" data-dept="전체">전체</div>
                                        <!-- 부서 목록은 동적으로 생성됨 -->
                                    </div>
                                </th>
                                <th>사용자 ID</th>
                                <th class="gift-status-filter-header" onclick="toggleGiftStatusFilter(event)">
                                    수령여부
                                    <span class="gift-status-filter-icon">▼</span>
                                    <div id="gift-status-filter-dropdown" class="gift-status-filter-dropdown">
                                        <div class="gift-status-filter-option" data-status="전체">전체</div>
                                        <div class="gift-status-filter-option" data-status="수령">수령</div>
                                        <div class="gift-status-filter-option" data-status="미수령">미수령</div>
                                    </div>
                                </th>
                                <th>쿠폰 만료일</th>
                            </tr>
                        </thead>
                        <tbody id="chuseok-gift-tbody">
                            <!-- 동적으로 생성됨 -->
                        </tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <div id="chuseok-gift-pagination" class="pagination">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
        </div>
    </div>

</body>
</html> 