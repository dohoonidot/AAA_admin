<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전사원 휴가현황 - AAA 관리자 홈</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/vacation-admin.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>AAA 관리자 홈</h1>
            <div class="sidebar-tabs">
                <a href="../index.html" class="sidebar-tab">홈</a>
                <a href="dashboard.html" class="sidebar-tab">대시보드</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown">
                        사용자 관리
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="users.html" class="sidebar-dropdown-item">재직자</a>
                        <a href="resigned-users.html" class="sidebar-dropdown-item">퇴사자</a>
                    </div>
                </div>
                <a href="gifts.html" class="sidebar-tab">선물보내기</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown active">
                        휴가 총괄 관리
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="vacation-requests.html" class="sidebar-dropdown-item">부여요청목록</a>
                        <a href="vacation-history.html" class="sidebar-dropdown-item">부여내역</a>
                        <a href="vacation-status.html" class="sidebar-dropdown-item active">전사원 휴가현황</a>
                        <a href="vacation-proxy.html" class="sidebar-dropdown-item" style="display: none;">휴가 대리결제</a>
                        <a href="vacation-manual.html" class="sidebar-dropdown-item">임의휴가부여</a>
                        <a href="vacation-approvers.html" class="sidebar-dropdown-item">권한관리자 지정</a>
                        <a href="vacation-promotion.html" class="sidebar-dropdown-item" style="display: none;">연차촉진관리</a>
                        <a href="vacation-approval-history.html" class="sidebar-dropdown-item">휴가신청승인 관리</a>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <span id="username-display"></span>
                <button id="logout-btn" class="logout-btn">로그아웃</button>
            </div>
        </div>

        <div class="main-content">
            <div class="page-header">
                <h1>전사원 휴가현황</h1>
                <p class="subtitle">전체 직원의 휴가 잔여일수와 사용 현황을 확인할 수 있습니다</p>
            </div>

            <div class="filter-section">
                <div class="filter-card">
                    <div class="filter-group">
                        <label>연도</label>
                        <select id="year-filter" class="filter-select">
                            <!-- JavaScript로 동적 생성 -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>부서</label>
                        <select id="department-filter" class="filter-select">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>검색</label>
                        <input type="text" id="name-search" class="filter-select" placeholder="이름">
                    </div>
                    <button id="export-btn" class="refresh-btn">엑셀</button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>이름</th>
                            <th>부서</th>
                            <th>총연차</th>
                            <th>사용</th>
                            <th>잔여</th>
                            <th>사용률</th>
                            <th>상세</th>
                        </tr>
                    </thead>
                    <tbody id="vacation-tbody"></tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination-container" id="pagination-container" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px; flex-wrap: wrap;">
                <!-- 맨 처음 버튼 -->
                <button id="first-page-btn" class="pagination-btn" onclick="goToPage(1)" style="padding: 10px 16px; background-color: #ffffff; color: #495057; border: 1.5px solid #dee2e6; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px;" onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#adb5bd';" onmouseout="this.style.backgroundColor='#ffffff'; this.style.borderColor='#dee2e6';">
                    « 처음
                </button>
                <!-- 이전 버튼 -->
                <button id="prev-page-btn" class="pagination-btn" onclick="changePage(-1)" style="padding: 10px 16px; background-color: #ffffff; color: #495057; border: 1.5px solid #dee2e6; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px;" onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#adb5bd';" onmouseout="this.style.backgroundColor='#ffffff'; this.style.borderColor='#dee2e6';">
                    ‹ 이전
                </button>
                
                <!-- 페이지 번호 버튼들 -->
                <div id="page-numbers" style="display: flex; gap: 4px; align-items: center;"></div>
                
                <!-- 다음 버튼 -->
                <button id="next-page-btn" class="pagination-btn" onclick="changePage(1)" style="padding: 10px 16px; background-color: #ffffff; color: #495057; border: 1.5px solid #dee2e6; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px;" onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#adb5bd';" onmouseout="this.style.backgroundColor='#ffffff'; this.style.borderColor='#dee2e6';">
                    다음 ›
                </button>
                <!-- 맨 마지막 버튼 -->
                <button id="last-page-btn" class="pagination-btn" onclick="goToLastPage()" style="padding: 10px 16px; background-color: #ffffff; color: #495057; border: 1.5px solid #dee2e6; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 14px;" onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#adb5bd';" onmouseout="this.style.backgroundColor='#ffffff'; this.style.borderColor='#dee2e6';">
                    마지막 »
                </button>
                
                <!-- 페이지 정보 -->
                <span id="page-info" class="page-info" style="font-size: 14px; font-weight: 600; color: #495057; margin-left: 12px; padding: 8px 12px; background-color: #f8f9fa; border-radius: 6px;">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- 휴가 상세내역 모달 -->
    <div id="detail-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="modal-user-name">휴가 상세내역</h3>
                <button class="close-btn" onclick="closeDetailModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="detail-content" style="padding: 20px;">
                    <!-- 상세 내역이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/utils/auth.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;
        let totalPages = 1;
        let allUserData = [];

        document.addEventListener('DOMContentLoaded', function() {
            controlSidebarMenus();
            initializeYearFilter();
            loadDepartments();
            loadVacationStatus();

            // 연도 필터 변경 이벤트
            document.getElementById('year-filter').addEventListener('change', function() {
                currentPage = 1;
                loadVacationStatus();
            });

            // 부서 필터 변경 이벤트
            document.getElementById('department-filter').addEventListener('change', function() {
                currentPage = 1;
                loadVacationStatus();
            });

            // 검색 이벤트 (실시간 검색)
            const nameSearchInput = document.getElementById('name-search');
            if (nameSearchInput) {
                nameSearchInput.addEventListener('input', function(e) {
                    console.log('이름 검색 이벤트 발생:', e.target.value);
                    filterByName();
                });

                // 엔터키로도 검색 가능
                nameSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('엔터키 검색 이벤트 발생:', e.target.value);
                        filterByName();
                    }
                });
                console.log('이름 검색 이벤트 리스너가 설정되었습니다.');
            } else {
                console.error('이름 검색 입력 요소를 찾을 수 없습니다.');
            }
        });

        // 연도 선택 초기화
        function initializeYearFilter() {
            const yearSelect = document.getElementById('year-filter');
            const currentYear = new Date().getFullYear();

            // 현재 연도 + 1년부터 5년 전까지 옵션 생성 (2026년 포함)
            for (let year = currentYear + 1; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}년`;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // 부서 목록 로드
        function loadDepartments() {
            const departments = [
                '경영관리실', 'New Tech사업부', '솔루션사업부', 'FCM사업부', 'SCM사업부',
                'Innovation Center', 'Biz AI사업부', 'HRS사업부', 'DTE본부', '남부지사',
                '중국지사', 'PUBLIC CLOUD사업부', 'ITS사업부', 'BAC사업부', 'BDS사업부',
                'NGE본부', '대표이사'
            ];

            const select = document.getElementById('department-filter');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        async function loadVacationStatus() {
            try {
                const department = document.getElementById('department-filter').value;
                const year = parseInt(document.getElementById('year-filter').value);

                // view_type 결정: department 값이 있으면 "department", 없으면 "all"
                const viewType = department ? 'department' : 'all';

                const requestBody = {
                    year: year,
                    view_type: viewType,
                    department: department
                };

                console.log('전사원 휴가현황 조회 요청:', requestBody);

                const response = await fetch(`https://ai2great.com:8060/admin/leave/management?page=${currentPage}&page_size=${pageSize}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('전사원 휴가현황 응답:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                allUserData = data.user_list || [];
                totalPages = data.total_pages || 1;

                displayVacationData(allUserData);
                updatePagination();

            } catch (error) {
                console.error('전사원 휴가현황 조회 실패:', error);
                alert('휴가 현황을 불러오는데 실패했습니다.');
            }
        }

        function displayVacationData(users) {
            const tbody = document.getElementById('vacation-tbody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">조회된 데이터가 없습니다.</td></tr>';
                return;
            }

            // 사용자별로 그룹화 (같은 이름+부서는 여러 휴가 타입을 가질 수 있음)
            const userMap = new Map();
            users.forEach(user => {
                const key = `${user.name}_${user.department}`;
                if (!userMap.has(key)) {
                    userMap.set(key, {
                        name: user.name,
                        department: user.department,
                        job_position: user.job_position,
                        total: 0,
                        used: 0,
                        remaining: 0,
                        details: [],
                        user_id: user.user_id
                    });
                }
                const userData = userMap.get(key);
                userData.total += user.total_days;
                userData.used += user.used_days;
                userData.remaining += user.remain_days;
                userData.details.push({
                    leave_type: user.leave_type,
                    total: user.total_days,
                    used: user.used_days,
                    remaining: user.remain_days
                });
            });

            const uniqueUsers = Array.from(userMap.values());

            tbody.innerHTML = uniqueUsers.map((user, idx) => {
                const usageRate = user.total > 0 ? Math.round((user.used / user.total) * 100) : 0;
                const displayNumber = idx + 1;

                return `
                    <tr style="cursor: pointer; transition: background-color 0.15s;"
                        onmouseover="this.style.backgroundColor='#f9fafb'"
                        onmouseout="this.style.backgroundColor='transparent'"
                        onclick="showDetailModal('${user.user_id || ''}', '${user.name}')">
                        <td>${displayNumber}</td>
                        <td>${user.name}</td>
                        <td>${user.department}</td>
                        <td>${user.total.toFixed(1)}일</td>
                        <td>${user.used.toFixed(1)}일</td>
                        <td>${user.remaining.toFixed(1)}일</td>
                        <td>${usageRate}%</td>
                        <td><button class="modal-btn" onclick="event.stopPropagation(); showDetailModal('${user.user_id || ''}', '${user.name}')">보기</button></td>
                    </tr>
                `;
            }).join('');
        }

        function filterByName() {
            const searchTerm = document.getElementById('name-search').value.toLowerCase().trim();
            console.log('이름 검색:', searchTerm, '전체 데이터 수:', allUserData.length);

            if (!searchTerm) {
                currentPage = 1;
                displayVacationData(allUserData);
                updatePagination();
                return;
            }

            // 원본 데이터를 필터링한 후, 사용자별 그룹화 로직 재적용
            const filteredRawUsers = allUserData.filter(user =>
                user.name && user.name.toLowerCase().includes(searchTerm)
            );
            console.log('필터링된 데이터 수:', filteredRawUsers.length);

            currentPage = 1;
            displayVacationData(filteredRawUsers);
            updatePagination();
        }

        // 페이지 변경 함수
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage < 1 || newPage > totalPages) {
                return;
            }
            goToPage(newPage);
        }

        // 특정 페이지로 이동
        function goToPage(page) {
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            loadVacationStatus();
        }

        // 맨 마지막 페이지로 이동
        function goToLastPage() {
            goToPage(totalPages);
        }

        // 페이지네이션 UI 업데이트
        function updatePagination() {
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const firstBtn = document.getElementById('first-page-btn');
            const lastBtn = document.getElementById('last-page-btn');
            const pageNumbers = document.getElementById('page-numbers');
            const paginationContainer = document.getElementById('pagination-container');

            if (!paginationContainer) return;

            // 페이지가 1개 이하면 페이지네이션 숨기기
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            paginationContainer.style.display = 'flex';

            // 페이지 정보 업데이트
            if (pageInfo) {
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
            }

            // 버튼 활성/비활성 처리
            if (firstBtn) {
                firstBtn.disabled = currentPage <= 1;
                firstBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
                firstBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            }

            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
                prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
                prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            }

            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
                nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
                nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
            }

            if (lastBtn) {
                lastBtn.disabled = currentPage >= totalPages;
                lastBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
                lastBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
            }

            // 페이지 번호 버튼 생성
            if (pageNumbers) {
                pageNumbers.innerHTML = '';
                
                const maxPageButtons = 7; // 최대 표시할 페이지 버튼 수
                let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
                
                // 시작 페이지 재조정
                if (endPage - startPage + 1 < maxPageButtons) {
                    startPage = Math.max(1, endPage - maxPageButtons + 1);
                }
                
                // 첫 페이지 표시
                if (startPage > 2) {
                    const pageBtn = createPageButton(1);
                    pageNumbers.appendChild(pageBtn);
                    
                    if (startPage > 3) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.style.padding = '0 8px';
                        ellipsis.style.color = '#6c757d';
                        pageNumbers.appendChild(ellipsis);
                    }
                }
                
                // 페이지 번호 버튼들
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = createPageButton(i);
                    pageNumbers.appendChild(pageBtn);
                }
                
                // 마지막 페이지 표시
                if (endPage < totalPages - 1) {
                    if (endPage < totalPages - 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.style.padding = '0 8px';
                        ellipsis.style.color = '#6c757d';
                        pageNumbers.appendChild(ellipsis);
                    }
                    const pageBtn = createPageButton(totalPages);
                    pageNumbers.appendChild(pageBtn);
                }
            }
        }

        // 페이지 번호 버튼 생성 함수
        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.className = 'pagination-btn';
            
            if (pageNum === currentPage) {
                button.style.backgroundColor = '#0066ff';
                button.style.color = '#ffffff';
                button.style.borderColor = '#0066ff';
                button.style.fontWeight = '700';
            } else {
                button.style.backgroundColor = '#ffffff';
                button.style.color = '#495057';
                button.style.borderColor = '#dee2e6';
            }
            
            button.style.padding = '10px 14px';
            button.style.border = '1.5px solid';
            button.style.borderRadius = '8px';
            button.style.fontWeight = '600';
            button.style.cursor = 'pointer';
            button.style.transition = 'all 0.2s ease';
            button.style.fontSize = '14px';
            button.style.minWidth = '40px';
            
            button.onmouseover = function() {
                if (pageNum !== currentPage) {
                    this.style.backgroundColor = '#f8f9fa';
                    this.style.borderColor = '#adb5bd';
                }
            };
            
            button.onmouseout = function() {
                if (pageNum !== currentPage) {
                    this.style.backgroundColor = '#ffffff';
                    this.style.borderColor = '#dee2e6';
                }
            };
            
            button.onclick = function() {
                goToPage(pageNum);
            };
            
            return button;
        }

        function showDetail(user) {
            let detailHtml = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">${user.name} (${user.department}) - 휴가 상세</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="padding: 10px; border: 1px solid #ddd;">휴가 종류</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">총일수</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">사용</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">잔여</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            user.details.forEach(detail => {
                detailHtml += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${detail.leave_type}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${detail.total}일</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${detail.used}일</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${detail.remaining}일</td>
                    </tr>
                `;
            });

            detailHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            // 간단한 모달 대화상자로 표시
            const modal = window.open('', '휴가 상세', 'width=600,height=400');
            modal.document.write(detailHtml);
        }

        // 휴가 상세내역 모달 열기
        async function showDetailModal(userId, userName) {
            try {
                const year = parseInt(document.getElementById('year-filter').value);

                console.log('휴가 상세내역 조회 요청:', { year, user_id: userId });

                // 모달 열기
                document.getElementById('modal-user-name').textContent = `${userName}님의 휴가 상세내역`;
                document.getElementById('detail-content').innerHTML = '<div style="text-align: center; padding: 40px;">불러오는 중...</div>';
                document.getElementById('detail-modal').style.display = 'flex';

                const response = await fetch('/admin/leave/management/detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ year, user_id: userId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('휴가 상세내역 응답:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                const leaveStatus = data.leave_status || [];

                if (leaveStatus.length === 0) {
                    document.getElementById('detail-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">휴가 내역이 없습니다.</div>';
                    return;
                }

                // 상세 내역 테이블 렌더링
                let detailHtml = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f9fafb;">
                                <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left;">휴가 종류</th>
                                <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">총일수</th>
                                <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">사용</th>
                                <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">잔여</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                leaveStatus.forEach(item => {
                    detailHtml += `
                        <tr>
                            <td style="padding: 12px; border: 1px solid #e5e7eb;">${item.leave_type}</td>
                            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">${item.total_days}일</td>
                            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">${item.used_days}일</td>
                            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">${item.remain_days}일</td>
                        </tr>
                    `;
                });

                detailHtml += `
                        </tbody>
                    </table>
                `;

                document.getElementById('detail-content').innerHTML = detailHtml;

            } catch (error) {
                console.error('휴가 상세내역 조회 실패:', error);
                document.getElementById('detail-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">상세내역을 불러오는데 실패했습니다.</div>';
            }
        }

        // 모달 닫기
        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        // 모달 배경 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeDetailModal();
            }
        }
    </script>
</body>
</html>
