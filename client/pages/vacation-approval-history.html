<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íœ´ê°€ì‹ ì²­ìŠ¹ì¸ ê´€ë¦¬ - AAA ê´€ë¦¬ì í™ˆ</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/vacation-admin.css">
    <link rel="stylesheet" href="../css/sort-styles.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>AAA ê´€ë¦¬ì í™ˆ</h1>
            <div class="sidebar-tabs">
                <a href="../index.html" class="sidebar-tab">í™ˆ</a>
                <a href="dashboard.html" class="sidebar-tab">ëŒ€ì‹œë³´ë“œ</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown">
                        ì‚¬ìš©ì ê´€ë¦¬
                        <span class="dropdown-arrow">â–¼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="users.html" class="sidebar-dropdown-item">ì¬ì§ì</a>
                        <a href="resigned-users.html" class="sidebar-dropdown-item">í‡´ì‚¬ì</a>
                    </div>
                </div>
                <a href="gifts.html" class="sidebar-tab">ì„ ë¬¼ë³´ë‚´ê¸°</a>
                <div class="sidebar-tab-dropdown">
                    <div class="sidebar-tab sidebar-tab-with-dropdown active">
                        íœ´ê°€ ì´ê´„ ê´€ë¦¬
                        <span class="dropdown-arrow">â–¼</span>
                    </div>
                    <div class="sidebar-dropdown-content">
                        <a href="vacation-requests.html" class="sidebar-dropdown-item">ë¶€ì—¬ìš”ì²­ëª©ë¡</a>
                        <a href="vacation-history.html" class="sidebar-dropdown-item">ë¶€ì—¬ë‚´ì—­</a>
                        <a href="vacation-status.html" class="sidebar-dropdown-item">ì „ì‚¬ì› íœ´ê°€í˜„í™©</a>
                        <a href="vacation-proxy.html" class="sidebar-dropdown-item" style="display: none;">íœ´ê°€ ëŒ€ë¦¬ê²°ì œ</a>
                        <a href="vacation-manual.html" class="sidebar-dropdown-item">ì„ì˜íœ´ê°€ë¶€ì—¬</a>
                        <a href="vacation-approvers.html" class="sidebar-dropdown-item">ê¶Œí•œê´€ë¦¬ì ì§€ì •</a>
                        <a href="vacation-promotion.html" class="sidebar-dropdown-item" style="display: none;">ì—°ì°¨ì´‰ì§„ê´€ë¦¬</a>
                        <a href="vacation-approval-history.html" class="sidebar-dropdown-item active">íœ´ê°€ì‹ ì²­ìŠ¹ì¸ ê´€ë¦¬</a>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <span id="username-display"></span>
                <button id="logout-btn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="main-content">
            <div class="page-header">
                <h1>íœ´ê°€ì‹ ì²­ìŠ¹ì¸ ê´€ë¦¬</h1>
                <p class="subtitle">ì „ì‚¬ì›ì˜ íœ´ê°€ ì‹ ì²­ ë‚´ì—­ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <div class="filter-section">
                <div class="filter-card">
                    <div class="filter-group">
                        <label>ì—°ë„</label>
                        <select id="year-filter" class="filter-select">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ì´ë¦„ ê²€ìƒ‰</label>
                        <input id="name-filter" type="text" class="filter-input" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="filter-group">
                        <label>í•„í„° ìœ í˜•</label>
                        <select id="view-type-filter" class="filter-select">
                            <option value="">ì „ì²´</option>
                            <option value="department">ë¶€ì„œë³„</option>
                            <option value="leave_type">íœ´ê°€íƒ€ì…ë³„</option>
                        </select>
                    </div>
                    <div class="filter-group" id="department-filter-group" style="display: none;">
                        <label>ë¶€ì„œ</label>
                        <select id="department-filter" class="filter-select">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="filter-group" id="leave-type-filter-group" style="display: none;">
                        <label>íœ´ê°€ íƒ€ì…</label>
                        <select id="leave-type-filter" class="filter-select">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì—°ì°¨">ì—°ì°¨</option>
                            <option value="ì˜ˆë¹„êµ°/ë¯¼ë°©ìœ„ ì—°ì°¨">ì˜ˆë¹„êµ°/ë¯¼ë°©ìœ„ ì—°ì°¨</option>
                            <option value="ë³‘ê°€">ë³‘ê°€</option>
                            <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
                        </select>
                    </div>
                    <button id="search-btn" class="refresh-btn">ì¡°íšŒ</button>
                </div>
                <div id="active-filters" class="active-filters"></div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th class="sortable-header" data-sort-key="name">ì´ë¦„ <span class="sort-icon">â†•</span></th>
                            <th class="sortable-header" data-sort-key="department">ë¶€ì„œ <span class="sort-icon">â†•</span></th>
                            <th>íœ´ê°€ëª…</th>
                            <th class="sortable-header" data-sort-key="leave_date">íœ´ê°€ì¼ì <span class="sort-icon">â†•</span></th>
                            <th>ì‚¬ìš©ì¼ìˆ˜</th>
                            <th class="sortable-header" data-sort-key="requested_date">ì‹ ì²­ì¼ <span class="sort-icon">â†•</span></th>
                            <th class="sortable-header" data-sort-key="status">ìŠ¹ì¸ìƒíƒœ <span class="sort-icon">â†•</span></th>
                        </tr>
                    </thead>
                    <tbody id="leave-history-tbody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§• -->
            <div class="pagination-container" id="pagination-container" style="display: none; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px; flex-wrap: wrap;">
                <button id="first-page-btn" class="pagination-btn" onclick="goToFirstPage()">Â« ì²˜ìŒ</button>
                <button id="prev-page-btn" class="pagination-btn" onclick="goToPage(currentPage - 1)">â€¹ ì´ì „</button>
                
                <!-- í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ -->
                <div id="page-numbers" style="display: flex; gap: 4px; align-items: center;"></div>
                
                <button id="next-page-btn" class="pagination-btn" onclick="goToPage(currentPage + 1)">ë‹¤ìŒ â€º</button>
                <button id="last-page-btn" class="pagination-btn" onclick="goToLastPage()">ë§ˆì§€ë§‰ Â»</button>
                
                <!-- í˜ì´ì§€ ì •ë³´ -->
                <span id="page-info" class="page-info" style="font-size: 14px; font-weight: 600; color: #495057; margin-left: 12px; padding: 8px 12px; background-color: #f8f9fa; border-radius: 6px;">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- ìŠ¹ì¸ ì´ë ¥ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="approval-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background-color: white; border-radius: 12px; width: 95%; max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <!-- ëª¨ë‹¬ í—¤ë” -->
            <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1a1f36;">íœ´ê°€ ì‹ ì²­ ìƒì„¸</h3>
                <button onclick="closeApprovalModal()" style="background: none; border: none; font-size: 2rem; color: #6b7280; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">Ã—</button>
            </div>

            <!-- ëª¨ë‹¬ ë³¸ë¬¸ -->
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                <!-- ì‹ ì²­ ë‚´ì—­ ì„¹ì…˜ -->
                <div style="margin-bottom: 32px;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: #1a1f36; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #3182F6;">ğŸ“ ì‹ ì²­ ë‚´ì—­</h4>
                    <div id="leave-request-info" style="background-color: #f8f9fa; border-radius: 8px; padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">ì‹ ì²­ì</span>
                                <p id="modal-applicant" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">ë¶€ì„œ</span>
                                <p id="modal-department" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">íœ´ê°€ ì¢…ë¥˜</span>
                                <p id="modal-leave-type" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">ì‚¬ìš© ì¼ìˆ˜</span>
                                <p id="modal-workdays" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">íœ´ê°€ ê¸°ê°„</span>
                                <p id="modal-leave-date" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">ì‹ ì²­ì¼</span>
                                <p id="modal-requested-date" style="margin: 4px 0 0 0; color: #1a1f36; font-size: 1rem;">-</p>
                            </div>
                            <div style="grid-column: span 2;">
                                <span style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">í˜„ì¬ ìƒíƒœ</span>
                                <p id="modal-status" style="margin: 4px 0 0 0;">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¹ì¸ ë‚´ì—­ ì„¹ì…˜ -->
                <div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: #1a1f36; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #10b981;">âœ… ìŠ¹ì¸ ë‚´ì—­</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background-color: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 14px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #4a5568; font-size: 0.875rem;">ìŠ¹ì¸ì</th>
                                    <th style="padding: 14px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #4a5568; font-size: 0.875rem; width: 100px;">ìˆœì°¨ê²°ì¬</th>
                                    <th style="padding: 14px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #4a5568; font-size: 0.875rem; width: 180px;">ìŠ¹ì¸ë‚ ì§œ</th>
                                    <th style="padding: 14px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #4a5568; font-size: 0.875rem; width: 100px;">ìŠ¹ì¸ìƒíƒœ</th>
                                    <th style="padding: 14px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #4a5568; font-size: 0.875rem; width: 200px;">ë°˜ë ¤ë©”ì‹œì§€</th>
                                </tr>
                            </thead>
                            <tbody id="approval-history-tbody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼ -->
            <div style="padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; background-color: #f9fafb;">
                <button onclick="handleDelegateApproval('APPROVED')" style="padding: 12px 24px; background-color: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.backgroundColor='#059669'" onmouseout="this.style.backgroundColor='#10b981'">
                    ëŒ€ë¦¬ìŠ¹ì¸
                </button>
                <button onclick="handleDelegateApproval('REJECTED')" style="padding: 12px 24px; background-color: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                    ëŒ€ë¦¬ë°˜ë ¤
                </button>
                <button onclick="closeApprovalModal()" style="padding: 12px 24px; background-color: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/utils/auth.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;
        let totalPages = 1;
        let sortState = { key: null, direction: 'asc' };

        document.addEventListener('DOMContentLoaded', function() {
            controlSidebarMenus();
            initializeYearFilter();
            loadDepartments();
            loadLeaveHistory();

            // í•„í„° ìœ í˜• ë³€ê²½ ì´ë²¤íŠ¸
            document.getElementById('view-type-filter').addEventListener('change', function() {
                const viewType = this.value;
                const deptGroup = document.getElementById('department-filter-group');
                const leaveTypeGroup = document.getElementById('leave-type-filter-group');

                if (viewType === 'department') {
                    deptGroup.style.display = 'block';
                    leaveTypeGroup.style.display = 'none';
                } else if (viewType === 'leave_type') {
                    deptGroup.style.display = 'none';
                    leaveTypeGroup.style.display = 'block';
                } else {
                    deptGroup.style.display = 'none';
                    leaveTypeGroup.style.display = 'none';
                }
            });

            // ì¡°íšŒ ë²„íŠ¼ í´ë¦­
            document.getElementById('search-btn').addEventListener('click', function() {
                currentPage = 1;
                loadLeaveHistory();
            });

            // ì´ë¦„ ê²€ìƒ‰ ì—”í„°
            document.getElementById('name-filter').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    currentPage = 1;
                    loadLeaveHistory();
                }
            });

            // ì—°ë„ ë³€ê²½
            document.getElementById('year-filter').addEventListener('change', function() {
                currentPage = 1;
                loadLeaveHistory();
            });

            // ì •ë ¬ í—¤ë” í´ë¦­
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const key = this.dataset.sortKey;
                    updateSortState(key);
                    displayLeaveHistory(currentLeaveData || []);
                });
            });
        });

        // ì—°ë„ ì„ íƒ ì´ˆê¸°í™”
        function initializeYearFilter() {
            const yearSelect = document.getElementById('year-filter');
            const currentYear = new Date().getFullYear();

            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'ì „ì²´';
            yearSelect.appendChild(allOption);

            // í˜„ì¬ ì—°ë„ë¶€í„° 5ë…„ ì „ê¹Œì§€ + 1ë…„ í›„ê¹Œì§€ (2026ë…„ í¬í•¨)
            for (let year = currentYear + 1; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}ë…„`;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // ë¶€ì„œ ëª©ë¡ ë¡œë“œ
        function loadDepartments() {
            const departments = [
                'ê²½ì˜ê´€ë¦¬ì‹¤', 'New Techì‚¬ì—…ë¶€', 'ì†”ë£¨ì…˜ì‚¬ì—…ë¶€', 'FCMì‚¬ì—…ë¶€', 'SCMì‚¬ì—…ë¶€',
                'Innovation Center', 'Biz AIì‚¬ì—…ë¶€', 'HRSì‚¬ì—…ë¶€', 'DTEë³¸ë¶€', 'ë‚¨ë¶€ì§€ì‚¬',
                'ì¤‘êµ­ì§€ì‚¬', 'PUBLIC CLOUDì‚¬ì—…ë¶€', 'ITSì‚¬ì—…ë¶€', 'BACì‚¬ì—…ë¶€', 'BDSì‚¬ì—…ë¶€',
                'NGEë³¸ë¶€', 'ëŒ€í‘œì´ì‚¬'
            ];

            const select = document.getElementById('department-filter');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        // íœ´ê°€ ì‹ ì²­ ì´ë ¥ ì¡°íšŒ
        async function loadLeaveHistory() {
            try {
                updateActiveFilters();
                const yearValue = document.getElementById('year-filter').value;
                const viewType = document.getElementById('view-type-filter').value;
                const department = document.getElementById('department-filter').value;
                const leaveType = document.getElementById('leave-type-filter').value;
                const name = document.getElementById('name-filter').value.trim();

                const requestBody = {
                    view_type: viewType,
                    department: viewType === 'department' ? department : '',
                    leave_type: viewType === 'leave_type' ? leaveType : ''
                };

                if (yearValue) {
                    requestBody.year = parseInt(yearValue, 10);
                }

                if (name) {
                    requestBody.name = name;
                }

                console.log('íœ´ê°€ ì‹ ì²­ ì´ë ¥ ì¡°íšŒ ìš”ì²­:', requestBody);

                const response = await fetch(`/admin/leave/management/history?page=${currentPage}&page_size=${pageSize}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('íœ´ê°€ ì‹ ì²­ ì´ë ¥ ì‘ë‹µ:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                const leaves = data.leaves || [];
                totalPages = data.total_pages || 1;

                displayLeaveHistory(leaves);
                renderPagination();

            } catch (error) {
                console.error('íœ´ê°€ ì‹ ì²­ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
                document.getElementById('leave-history-tbody').innerHTML =
                    '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // íœ´ê°€ ì‹ ì²­ ì´ë ¥ í‘œì‹œ
        function displayLeaveHistory(leaves) {
            const tbody = document.getElementById('leave-history-tbody');

            // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
            currentLeaveData = leaves;

            if (!leaves || leaves.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const sortedLeaves = getSortedLeaves(leaves);

            tbody.innerHTML = sortedLeaves.map((leave, idx) => {
                const startIdx = (currentPage - 1) * pageSize;
                const nameWithPosition = `${leave.name} ${leave.job_position}`;
                const leaveDate = formatDateRange(leave.start_date, leave.end_date);
                const requestedDate = formatDateTime(leave.requested_date);
                const statusBadge = getStatusBadge(leave.status);

                return `
                    <tr style="cursor: pointer; transition: background-color 0.15s;"
                        onclick="showApprovalDetail(${leave.id})"
                        onmouseover="this.style.backgroundColor='#f9fafb'"
                        onmouseout="this.style.backgroundColor='transparent'">
                        <td>${startIdx + idx + 1}</td>
                        <td>${nameWithPosition}</td>
                        <td>${leave.department}</td>
                        <td>${leave.leave_type}</td>
                        <td>${leaveDate}</td>
                        <td>${leave.workdays_count}ì¼</td>
                        <td>${requestedDate}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');

            updateSortIcons();
        }

        function updateSortState(key) {
            if (sortState.key === key) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.direction = 'asc';
            }
        }

        function updateSortIcons() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const icon = header.querySelector('.sort-icon');
                const key = header.dataset.sortKey;
                header.classList.remove('sort-active');
                if (!icon) return;

                if (sortState.key === key) {
                    header.classList.add('sort-active');
                    icon.textContent = sortState.direction === 'asc' ? 'â–²' : 'â–¼';
                } else {
                    icon.textContent = 'â†•';
                }
            });
        }

        function getSortedLeaves(leaves) {
            if (!sortState.key) return leaves;

            const sorted = [...leaves];
            const direction = sortState.direction === 'asc' ? 1 : -1;

            sorted.sort((a, b) => {
                switch (sortState.key) {
                    case 'name':
                        return direction * String(a.name || '').localeCompare(String(b.name || ''), 'ko');
                    case 'department':
                        return direction * String(a.department || '').localeCompare(String(b.department || ''), 'ko');
                    case 'leave_date': {
                        const aStart = new Date(a.start_date).getTime() || 0;
                        const bStart = new Date(b.start_date).getTime() || 0;
                        if (aStart !== bStart) return direction * (aStart - bStart);
                        const aEnd = new Date(a.end_date).getTime() || 0;
                        const bEnd = new Date(b.end_date).getTime() || 0;
                        return direction * (aEnd - bEnd);
                    }
                    case 'requested_date': {
                        const aReq = new Date(a.requested_date).getTime() || 0;
                        const bReq = new Date(b.requested_date).getTime() || 0;
                        return direction * (aReq - bReq);
                    }
                    case 'status': {
                        const aStatus = getStatusSortText(a.status);
                        const bStatus = getStatusSortText(b.status);
                        return direction * aStatus.localeCompare(bStatus, 'ko');
                    }
                    default:
                        return 0;
                }
            });

            return sorted;
        }

        function getStatusSortText(status) {
            const statusMap = {
                'APPROVED': 'ìŠ¹ì¸',
                'REJECTED': 'ë°˜ë ¤',
                'CANCELLED': 'ì·¨ì†Œ',
                'PENDING': 'ëŒ€ê¸°',
                'REQUESTED': 'ëŒ€ê¸°',
                'CANCEL_REQUESTED': 'ì·¨ì†ŒëŒ€ê¸°',
                'CANCEL_PENDING': 'ìŠ¹ì¸ì·¨ì†Œìš”ì²­',
                'CANCEL_APPROVED': 'ìŠ¹ì¸ì·¨ì†Œ',
                'ìŠ¹ì¸': 'ìŠ¹ì¸',
                'ë°˜ë ¤': 'ë°˜ë ¤',
                'ì·¨ì†Œ': 'ì·¨ì†Œ',
                'ëŒ€ê¸°': 'ëŒ€ê¸°',
                'ì·¨ì†ŒëŒ€ê¸°': 'ì·¨ì†ŒëŒ€ê¸°',
                'ìŠ¹ì¸ì·¨ì†Œìš”ì²­': 'ìŠ¹ì¸ì·¨ì†Œìš”ì²­',
                'ìŠ¹ì¸ì·¨ì†Œ': 'ìŠ¹ì¸ì·¨ì†Œ'
            };
            return statusMap[status] || String(status || '');
        }

        function updateActiveFilters() {
            const container = document.getElementById('active-filters');
            if (!container) return;

            const yearValue = document.getElementById('year-filter').value;
            const viewType = document.getElementById('view-type-filter').value;
            const department = document.getElementById('department-filter').value;
            const leaveType = document.getElementById('leave-type-filter').value;
            const name = document.getElementById('name-filter').value.trim();

            const tags = [];

            tags.push(`ì—°ë„: ${yearValue ? `${yearValue}ë…„` : 'ì „ì²´'}`);

            if (name) {
                tags.push(`ì´ë¦„: ${name}`);
            }

            if (viewType === 'department') {
                tags.push(`í•„í„°: ë¶€ì„œë³„`);
                if (department) {
                    tags.push(`ë¶€ì„œ: ${department}`);
                }
            } else if (viewType === 'leave_type') {
                tags.push(`í•„í„°: íœ´ê°€íƒ€ì…ë³„`);
                if (leaveType) {
                    tags.push(`íœ´ê°€íƒ€ì…: ${leaveType}`);
                }
            } else {
                tags.push('í•„í„°: ì „ì²´');
            }

            if (tags.length === 0) {
                container.innerHTML = '<span class="filter-tag">í•„í„° ì—†ìŒ</span>';
                return;
            }

            container.innerHTML = tags.map(text => `<span class="filter-tag">${text}</span>`).join('');
        }

        // ë‚ ì§œ ë²”ìœ„ í¬ë§·
        function formatDateRange(startDate, endDate) {
            const start = new Date(startDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\. /g, '-').replace('.', '');

            const end = new Date(endDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\. /g, '-').replace('.', '');

            return start === end ? start : `${start} ~ ${end}`;
        }

        // ë‚ ì§œ ì‹œê°„ í¬ë§· (ì‹œ/ë¶„/ì´ˆ í¬í•¨) - UTC ì‹œê°„ ê·¸ëŒ€ë¡œ í‘œì‹œ
        function formatDateTime(dateTime) {
            const date = new Date(dateTime);
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // ìƒíƒœ ë°°ì§€
        function getStatusBadge(status) {
            const statusMap = {
                'APPROVED': { text: 'ìŠ¹ì¸', color: '#10b981', bg: '#d1fae5' },
                'REJECTED': { text: 'ë°˜ë ¤', color: '#ef4444', bg: '#fee2e2' },
                'CANCELLED': { text: 'ì·¨ì†Œ', color: '#6b7280', bg: '#f3f4f6' },
                'PENDING': { text: 'ëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7' },
                'REQUESTED': { text: 'ëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7' },
                'CANCEL_REQUESTED': { text: 'ì·¨ì†ŒëŒ€ê¸°', color: '#f59e0b', bg: '#fef3c7' },
                'CANCEL_PENDING': { text: 'ìŠ¹ì¸ì·¨ì†Œìš”ì²­', color: '#f59e0b', bg: '#fef3c7' },
                'CANCEL_APPROVED': { text: 'ìŠ¹ì¸ì·¨ì†Œ', color: '#6b7280', bg: '#f3f4f6' }
            };

            const statusInfo = statusMap[status] || { text: status, color: '#6b7280', bg: '#f3f4f6' };

            // CANCEL_PENDINGì˜ ê²½ìš° ê¸€ì í¬ê¸°ë¥¼ 1px ì‘ê²Œ ì„¤ì •
            const fontSize = status === 'CANCEL_PENDING' ? '11px' : '12px';

            return `<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: ${fontSize}; font-weight: 600; color: ${statusInfo.color}; background-color: ${statusInfo.bg}; white-space: nowrap;">${statusInfo.text}</span>`;
        }

        // í˜ì´ì§• ë Œë”ë§
        function renderPagination() {
            const container = document.getElementById('pagination-container');
            const pageInfo = document.getElementById('page-info');
            const pageNumbersContainer = document.getElementById('page-numbers');
            const firstBtn = document.getElementById('first-page-btn');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const lastBtn = document.getElementById('last-page-btn');

            if (!container || !pageInfo) return;

            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            pageInfo.textContent = `${currentPage} / ${totalPages}`;

            // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ ìƒì„±
            if (pageNumbersContainer) {
                pageNumbersContainer.innerHTML = '';
                
                const maxPageButtons = 7; // ìµœëŒ€ í‘œì‹œí•  í˜ì´ì§€ ë²„íŠ¼ ìˆ˜
                let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
                
                // endPageê°€ totalPagesì— ê°€ê¹Œìš°ë©´ startPage ì¡°ì •
                if (endPage - startPage < maxPageButtons - 1) {
                    startPage = Math.max(1, endPage - maxPageButtons + 1);
                }
                
                // ì²˜ìŒ í˜ì´ì§€ê°€ 1ì´ ì•„ë‹ˆë©´ 1ë²ˆê³¼ "..." í‘œì‹œ
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('button');
                    firstPageBtn.className = 'pagination-page-btn';
                    firstPageBtn.textContent = '1';
                    firstPageBtn.onclick = () => goToPage(1);
                    pageNumbersContainer.appendChild(firstPageBtn);
                    
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        ellipsis.style.pointerEvents = 'none';
                        ellipsis.style.padding = '0 4px';
                        ellipsis.style.color = '#6c757d';
                        pageNumbersContainer.appendChild(ellipsis);
                    }
                }
                
                // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ ìƒì„±
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-page-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }
                
                // ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ endPageê°€ ì•„ë‹ˆë©´ "..."ê³¼ ë§ˆì§€ë§‰ í˜ì´ì§€ í‘œì‹œ
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        ellipsis.style.pointerEvents = 'none';
                        ellipsis.style.padding = '0 4px';
                        ellipsis.style.color = '#6c757d';
                        pageNumbersContainer.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('button');
                    lastPageBtn.className = 'pagination-page-btn';
                    lastPageBtn.textContent = totalPages;
                    lastPageBtn.onclick = () => goToPage(totalPages);
                    pageNumbersContainer.appendChild(lastPageBtn);
                }
            }

            // ì²˜ìŒ/ì´ì „/ë‹¤ìŒ/ë§ˆì§€ë§‰ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            if (firstBtn) {
                firstBtn.disabled = currentPage <= 1;
                firstBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
                firstBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            }

            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
                prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
                prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            }

            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
                nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
                nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
            }

            if (lastBtn) {
                lastBtn.disabled = currentPage >= totalPages;
                lastBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
                lastBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
            }
        }

        // í˜ì´ì§€ ì´ë™
        function goToPage(page) {
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            loadLeaveHistory();
        }

        // ì²˜ìŒ í˜ì´ì§€ë¡œ ì´ë™
        function goToFirstPage() {
            if (currentPage > 1) {
                goToPage(1);
            }
        }

        // ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
        function goToLastPage() {
            if (currentPage < totalPages) {
                goToPage(totalPages);
            }
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ íœ´ê°€ ë°ì´í„° ì €ì¥
        let currentLeaveData = null;
        // í˜„ì¬ ì„ íƒëœ íœ´ê°€ ì •ë³´ ì €ì¥ (ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ìš©)
        let currentSelectedLeave = null;

        // ìŠ¹ì¸ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        async function showApprovalDetail(leaveId) {
            try {
                const modal = document.getElementById('approval-detail-modal');
                const tbody = document.getElementById('approval-history-tbody');

                // ëª¨ë‹¬ í‘œì‹œ
                modal.style.display = 'flex';

                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

                // í˜„ì¬ íœ´ê°€ ëª©ë¡ì—ì„œ í•´ë‹¹ IDì˜ ë°ì´í„° ì°¾ê¸°
                const leaveInfo = findLeaveDataById(leaveId);
                
                // í˜„ì¬ ì„ íƒëœ íœ´ê°€ ì •ë³´ ì €ì¥ (ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ìš©)
                currentSelectedLeave = leaveInfo;

                // ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
                if (leaveInfo) {
                    displayLeaveRequestInfo(leaveInfo);
                }

                console.log('ìŠ¹ì¸ ì´ë ¥ ì¡°íšŒ ìš”ì²­:', leaveId);

                const response = await fetch(`/admin/leave/management/approvalHistory?id=${leaveId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ìŠ¹ì¸ ì´ë ¥ ì‘ë‹µ:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                const approvalHistory = data.approval_history || [];
                displayApprovalHistory(approvalHistory);

            } catch (error) {
                console.error('ìŠ¹ì¸ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
                const tbody = document.getElementById('approval-history-tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #ef4444;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // íœ´ê°€ ë°ì´í„° ì°¾ê¸°
        function findLeaveDataById(leaveId) {
            // displayLeaveHistoryì—ì„œ ì‚¬ìš©í•œ leaves ë°°ì—´ì—ì„œ ì°¾ê¸°
            const tbody = document.getElementById('leave-history-tbody');
            const rows = tbody.querySelectorAll('tr');

            for (let row of rows) {
                if (row.onclick && row.onclick.toString().includes(leaveId)) {
                    // ì—¬ê¸°ì„œëŠ” ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ëœ ë°ì´í„° ì‚¬ìš©
                    return currentLeaveData ? currentLeaveData.find(leave => leave.id === leaveId) : null;
                }
            }
            return null;
        }

        // ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
        function displayLeaveRequestInfo(leave) {
            document.getElementById('modal-applicant').textContent = `${leave.name} ${leave.job_position}`;
            document.getElementById('modal-department').textContent = leave.department;
            document.getElementById('modal-leave-type').textContent = leave.leave_type;
            document.getElementById('modal-workdays').textContent = `${leave.workdays_count}ì¼`;
            document.getElementById('modal-leave-date').textContent = formatDateRange(leave.start_date, leave.end_date);
            document.getElementById('modal-requested-date').textContent = formatDateTime(leave.requested_date);
            document.getElementById('modal-status').innerHTML = getStatusBadge(leave.status);
        }

        // ìŠ¹ì¸ ì´ë ¥ í‘œì‹œ
        function displayApprovalHistory(history) {
            const tbody = document.getElementById('approval-history-tbody');

            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">ìŠ¹ì¸ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = history.map((item, idx) => {
                const approverInfo = `${item.approver_name} ${item.job_position} (${item.department})`;
                const procDate = formatDateTime(item.proc_date);
                const statusBadge = getStatusBadge(item.is_approved);
                const rejectMsg = item.reject_message || '-';
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9fafb';

                return `
                    <tr style="border-bottom: 1px solid #e5e7eb; background-color: ${bgColor};">
                        <td style="padding: 14px; color: #1a1f36; font-size: 0.9rem;">${approverInfo}</td>
                        <td style="padding: 14px; color: #1a1f36; text-align: center; font-weight: 600; font-size: 0.9rem;">${item.approval_seq}ì°¨</td>
                        <td style="padding: 14px; color: #1a1f36; font-size: 0.875rem; font-family: monospace;">${procDate}</td>
                        <td style="padding: 14px; text-align: center;">${statusBadge}</td>
                        <td style="padding: 14px; color: ${item.reject_message ? '#ef4444' : '#6b7280'}; font-size: 0.875rem;">${rejectMsg}</td>
                    </tr>
                `;
            }).join('');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeApprovalModal() {
            const modal = document.getElementById('approval-detail-modal');
            modal.style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('approval-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApprovalModal();
            }
        });

        // ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬ í•¨ìˆ˜
        async function handleDelegateApproval(status) {
            if (!currentSelectedLeave) {
                alert('íœ´ê°€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë°˜ë ¤ì¸ ê²½ìš° ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥ ë°›ê¸°
            let rejectMessage = '';
            if (status === 'REJECTED') {
                rejectMessage = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
                if (rejectMessage === null) {
                    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
                    return;
                }
                if (rejectMessage.trim() === '') {
                    alert('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
            }

            // í™•ì¸ ëŒ€í™”ìƒì
            const actionText = status === 'APPROVED' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';
            if (!confirm(`ì •ë§ë¡œ ì´ íœ´ê°€ ì‹ ì²­ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                // ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ID ê°€ì ¸ì˜¤ê¸° (ì´ë©”ì¼ í˜•ì‹)
                const adminId = localStorage.getItem('userId') || localStorage.getItem('username');
                if (!adminId) {
                    alert('ê´€ë¦¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // í´ë¦­í•œ ê±´ì˜ user_id ì‚¬ìš©
                const userId = currentSelectedLeave.user_id;
                if (!userId) {
                    alert('íœ´ê°€ ì‹ ì²­ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // idëŠ” ìˆ«ìë¡œ ë³€í™˜
                const leaveId = parseInt(currentSelectedLeave.id);
                if (isNaN(leaveId)) {
                    alert('íœ´ê°€ ì‹ ì²­ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                const requestBody = {
                    id: leaveId,
                    admin_id: adminId,
                    user_id: userId,
                    status: status,
                    reject_message: rejectMessage || ''
                };

                console.log('ğŸ“¤ [í´ë¼ì´ì–¸íŠ¸] ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ API ìš”ì²­ ë³¸ë¬¸:', requestBody);
                console.log('ğŸ“¤ [í´ë¼ì´ì–¸íŠ¸] ìš”ì²­ ë³¸ë¬¸ JSON:', JSON.stringify(requestBody, null, 2));
                console.log('ğŸ“¤ [í´ë¼ì´ì–¸íŠ¸] ê° í•„ë“œ íƒ€ì…:', {
                    id: typeof leaveId,
                    admin_id: typeof adminId,
                    user_id: typeof userId,
                    status: typeof status,
                    reject_message: typeof rejectMessage
                });

                const response = await fetch('/admin/leave/approval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ API ì‘ë‹µ:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                alert(`${actionText}ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeApprovalModal();
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadLeaveHistory();

            } catch (error) {
                console.error('ëŒ€ë¦¬ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert(`${actionText} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
    </script>
</body>
</html>
